## ä¼˜åŒ–ç›®çš„

### **é¿å…å‡ºç°é¡µé¢è®¿é—®é”™è¯¯**

* ç”±äºæ•°æ®åº“è¿æ¥timeoutäº§ç”Ÿé¡µé¢5xxé”™è¯¯
* ç”±äºæ…¢æŸ¥è¯¢é€ æˆé¡µé¢æ— æ³•åŠ è½½
* ç”±äºé˜»å¡é€ æˆæ•°æ®æ— æ³•æäº¤

### å¢åŠ æ•°æ®åº“çš„ç¨³å®šæ€§

* å¾ˆå¤šæ•°æ®åº“é—®é¢˜éƒ½æ˜¯ç”±äºä½æ•ˆçš„æŸ¥è¯¢å¯¼è‡´

### ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

* æµç•…é¡µé¢çš„è®¿é—®é€Ÿåº¦
* è‰¯å¥½çš„ç½‘ç«™åŠŸèƒ½ä½“éªŒ

### æ­¥éª¤

* SqlåŠç´¢å¼•
* æ•°æ®åº“è¡¨ç»“æ„
* ç³»ç»Ÿé…ç½®
* ç¡¬ä»¶

**ä»ä¸Šåˆ°ä¸‹, æˆæœ¬ä¾æ¬¡å¢å¤§, æ•ˆæœä¾æ¬¡é™ä½.**

## SQLè¯­å¥ä¼˜åŒ–

**æ…¢æŸ¥è¯¢**

å¦‚ä½•å‘ç°æœ‰é—®é¢˜çš„SQLï¼Ÿ

ä½¿ç”¨mysqlæ…¢æŸ¥è¯¢æ—¥å¿—å¯¹æœ‰æ•ˆç‡é—®é¢˜çš„SQLè¿›è¡Œç›‘æ§

```cmd
//æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯å¦å¼€å¯
show variables like 'slow_query_log';

//æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å­˜å‚¨ä½ç½®
show variables like 'slow_query_log_file';

//å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
set global slow_query_log=on;

//æŒ‡å®šæ…¢æŸ¥è¯¢æ—¥å¿—å­˜å‚¨ä½ç½®
set global show_query_log_file='/var/lib/mysql/homestead-slow.log';

//è®°å½•æ²¡æœ‰ä½¿ç”¨ç´¢å¼•çš„sql
set global log_queries_not_using_indexes=on;

//è®°å½•æŸ¥è¯¢è¶…è¿‡1sçš„sql
set global long_query_time=1;
```

æ…¢æŸ¥è¯¢æ—¥å¿—æ‰€åŒ…å«çš„å†…å®¹ï¼š

```cmd
#User@Host:root[root] @localhost[]//æ‰§è¡Œsqlçš„ä¸»æœºä¿¡æ¯
#Query_time:0.0000024 Lock_time:0.00 Rows_sent:0 Rows_esamined:0//sqlçš„æ‰§è¡Œä¿¡æ¯
SET timestamp=1402389324//sqlæ‰§è¡Œæ—¶é—´
select * from store; //sqlçš„å†…å®¹
```

**MySQLæ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ä¹‹mysqldumpslowï¼ˆmysqlå®˜æ–¹ï¼‰**

å®‰è£…å®ŒMySQLåï¼Œé»˜è®¤å°±å¸¦äº†mysqldumpslowï¼Œå¾ˆå¸¸ç”¨çš„ä¸€ä¸ªå·¥å…·ã€‚

```cmd
//æŸ¥çœ‹å‚æ•°åˆ—è¡¨
mysqldumpslow -h

//åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ä¸­å‰ä¸‰æ¡æ¯”è¾ƒæ…¢çš„sql
mysqldumpslow -t 3 /var/lib/mysql/homestead-slow.log | more 

//è¾“å‡ºæ ·å¼æ•ˆæœ
Count:1 Time:0.00s Lock=0.00s Rows=10.0
root[rppt]@localhost
select * from store
```

**MySQLæ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ä¹‹pt-query-digest**

åˆ†æç»“æœæ¯”mysqldumpslowæ›´è¯¦ç»†å…¨é¢

```cmd
//è¾“å‡ºåˆ°æ–‡ä»¶
pt-query-digest slow-log > slow_log.report

//è¾“å‡ºåˆ°æ•°æ®è¡¨
pt-query-digest slow.log -review \
	h=127.0.0.1,D=test,p=root,P=3306,u=root,t=query_review \
	--create-reviewtable \
	--review-history t=hostname_slow
```

åŸºæœ¬ä½¿ç”¨

```cmd
//æŸ¥çœ‹å‚æ•°åˆ—è¡¨
pt-query-digest --help

//åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ä¸­å‰ä¸‰æ¡æ¯”è¾ƒæ…¢çš„sql
pt-query-digest /var/lib/mysql/homestead-slow.log | more 

//è¾“å‡ºåˆ†ä¸ºä¸‰éƒ¨åˆ†
1.æ˜¾ç¤ºé™¤äº†æ—¥å¿—çš„æ—¶é—´èŒƒå›´ï¼Œä»¥åŠæ€»çš„sqlæ•°é‡å’Œä¸åŒçš„sqlæ•°é‡
2.Response Time:å“åº”æ—¶é—´å æ¯” Calls:sqlæ‰§è¡Œæ¬¡æ•°
3.sqlçš„å…·ä½“æ—¥å¿—
```

å¦‚ä½•é€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—å‘ç°æœ‰é—®é¢˜çš„SQLï¼Ÿ

```cmd
1.æŸ¥è¯¢æ¬¡æ•°å¤šä¸”æ¯æ¬¡æŸ¥è¯¢å ç”¨æ—¶é—´é•¿çš„SQL
é€šå¸¸ä¸ºpt-query-digeståˆ†æçš„å‰å‡ ä¸ªæŸ¥è¯¢

2.IOå¤§çš„SQLï¼ˆæ•°æ®åº“ä¸»è¦ç“¶é¢ˆå‡ºç°åœ¨IOå±‚æ¬¡ï¼‰
æ³¨æ„pt-query-digeståˆ†æä¸­çš„Rows examineé¡¹

3.æœªå‘½ä¸­ç´¢å¼•çš„SQL
æ³¨æ„pt-query-digeståˆ†æä¸­çš„Rows examineå’ŒRows Sendçš„å¯¹æ¯”
```

é€šè¿‡explainæŸ¥è¯¢å’Œåˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’

```
explain select customer_id,,first_name,last_name from customer;
```

| id   | select_type | table     | type                                     | possible_keys         | key               | key_len              | ref              | rows               | Extra                            |
| ---- | ----------- | --------- | ---------------------------------------- | --------------------- | ----------------- | -------------------- | ---------------- | ------------------ | -------------------------------- |
| 1    | SIMPLE      | customer  | ALL                                      | NULL                  | NULL              | NULL                 | NULL             | 671                |                                  |
|      |             | è¯¥æ•°æ®å…³äºå“ªå¼ è¡¨ã€‚ | ç¤ºè¿æ¥ä½¿ç”¨äº†ä½•ç§ç±»å‹ã€‚ä»å¥½åˆ°å·®const,eq_reg,ref,range,indexå’ŒALLã€‚ | å¯èƒ½åº”ç”¨åœ¨è¯¥è¡¨çš„ç´¢å¼•ï¼Œç©ºï¼Œæ²¡æœ‰å¯èƒ½çš„ç´¢å¼•ã€‚ | å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚ç©ºï¼Œæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚ | ä½¿ç”¨çš„ç´¢å¼•é•¿åº¦ã€‚ä¸æŸå¤±ç²¾åº¦ä¸‹ï¼Œè¶ŠçŸ­è¶Šå¥½ã€‚ | æ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—è¢«ä½¿ç”¨äº†ï¼Œå¸¸æ•°ã€‚ | mysqlè®¤ä¸ºå¿…é¡»æ£€æŸ¥çš„æ•°æ®çš„è¡Œæ•°ã€‚ | æ³¨æ„ï¼šUsing filesort,Using tempoary |

Count()å’ŒMax()çš„ä¼˜åŒ–

```cmd
//æŸ¥è¯¢æœ€åæ”¯ä»˜æ—¶é—´--ä¼˜åŒ–max()å‡½æ•°
explain select max(payment_date) from payment;
create index idx_paydate on payment(payment_data);//ç»™payment_dateå»ºç«‹ç´¢å¼•(è¦†ç›–ç´¢å¼•)

//åœ¨ä¸€æ¡SQLä¸­åŒæ—¶æŸ¥å‡º2006å¹´å’Œ2007å¹´ç”µå½±çš„æ•°é‡--ä¼˜åŒ–Count()å‡½æ•°
select count(release_year='2006' or null) as '2006å¹´ç”µå½±æ•°é‡'ï¼Œcount(release_year='2007' or null) as '2007å¹´ç”µå½±æ•°é‡' from film;
//æœ‰å…³count()å‡½æ•°
https://blog.csdn.net/wendychiang1991/article/details/70909958/
```

å­æŸ¥è¯¢ä¼˜åŒ–

```cmd
é€šå¸¸æƒ…å†µä¸‹ï¼Œéœ€è¦æŠŠå­æŸ¥è¯¢ä¼˜åŒ–ä¸ºjoinæŸ¥è¯¢ï¼Œä½†åœ¨ä¼˜åŒ–æ—¶è¦æ³¨æ„å…³è”é”®æ˜¯å¦æœ‰ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè¦æ³¨æ„é‡å¤æ•°æ®ã€‚(distinctå»é‡)
//æŸ¥è¯¢sandraå‡ºæ¼”çš„æ‰€æœ‰å½±ç‰‡
explain select title,release_year,LENGTH from film
where film_id in (
select film_id from film_actor where actor_id in (
select actor_id from actor where first_name='sandra'));
```

group byçš„ä¼˜åŒ–

```cmd
//æ”¹å‰ ä¸´æ—¶è¡¨
explain select actor.first_name,actor_last_name,count(*) from sakila.film_actor
inner join sakila.actor USING(actor_id)
group by film_actor.actor_id;
//æ”¹å ç»“åˆå­æŸ¥è¯¢ ç´¢å¼•
explain select actor.first_name,actor.last_name,c.cnt from sakila.film_actor
inner join (
select actor_id,count(*) as cnt from sakila.film_actor group by actor_id) as c USING(actor_id);
```

limitä¼˜åŒ–

```cmd
limitå¸¸ç”¨äºåˆ†é¡µå¤„ç†ï¼Œæ—¶å¸¸ä¼šä¼´éšorder by ä»å¥ä½¿ç”¨ï¼Œå› æ­¤å¤§å¤šæ—¶å€™ä¼šä½¿ç”¨Filesortsè¿™æ ·ä¼šé€ æˆå¤§é‡çš„IOé—®é¢˜ã€‚
//æ–‡ä»¶æ’åºï¼ŒIOå¤§
explain select film_id,description from sakila.film order by title limit 50,5;
1.ä¼˜åŒ–ï¼šä½¿ç”¨æœ‰ç´¢å¼•çš„åˆ—æˆ–ä¸»é”®è¿›è¡Œorder byæ“ä½œï¼ˆorder by film_idï¼‰
2.è®°å½•ä¸Šæ¬¡è¿”å›çš„ä¸»é”®ï¼Œåœ¨ä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™ç”¨ä¸»é”®è¿‡æ»¤ï¼Œé¿å…äº†æ•°æ®é‡å¤§æ—¶æ‰«æè¿‡å¤šçš„è®°å½•
select film_id,description from sakila.film where film_if>55 and film_id<=60 order by film_id limit 1,5; 
é¡µæ•°è¶Šå¤§ï¼ŒIOè¶Šå¤§
```

#### ç´¢å¼•ä¼˜åŒ–

å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ—å»ºç«‹ç´¢å¼•ï¼Ÿ

```
1.åœ¨whereä»å¥ï¼Œgroup byä»å¥ï¼Œorder byä»å¥ï¼Œonä»å¥ä¸­å‡ºç°çš„åˆ—(select)
2.ç´¢å¼•å­—æ®µè¶Šå°è¶Šå¥½(è¡¨æ¯é¡µæ•°æ®æ‰ä¼šæ›´å¤šï¼ŒIOæ•ˆç‡ä¼šæ›´é«˜)
3.ç¦»æ•£åº¦å¤§çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å‰é¢
select * from payment where staff_id=2 and customer_id=584;
index(staff_id,customer_id)å¥½ï¼Ÿè¿˜æ˜¯index(customer_id,staff_id)å¥½ï¼Ÿ
ç”±äºcustomer_idçš„ç¦»æ•£åº¦æ›´å¤§(é‡å¤ç‡å°,å¯é€‰æ‹©æ€§æ›´å¤§)ï¼Œæ‰€ä»¥åº”è¯¥ä½¿ç”¨index(customer_id,staff_id)
```

ç´¢å¼•ä¼˜åŒ–SQLçš„æ–¹æ³•

ç´¢å¼•çš„ç»´æŠ¤åŠä¼˜åŒ–--é‡å¤åŠå†—ä½™ç´¢å¼•

```
å†—ä½™ç´¢å¼•æ˜¯æŒ‡å¤šä¸ªç´¢å¼•çš„å‰ç¼€åˆ—ç›¸åŒï¼Œæˆ–æ˜¯åœ¨è”åˆç´¢å¼•ä¸­åŒ…å«äº†ä¸»é”®çš„ç´¢å¼•ã€‚å¦‚ä¸‹ï¼škey(name,id)å°±æ˜¯ä¸€ä¸ªå†—ä½™ç´¢å¼•
create table test(
id int not null primary key,
name varchar(10) not null,
key(name,id)
)engine=innodb;
//å¯ä»¥åˆ é™¤å†—ä½™ç´¢å¼•ï¼Œè¾¾åˆ°ä¼˜åŒ–æ•ˆæœã€‚

ä½¿ç”¨pt-duplicate-key-checkerå·¥å…·æ£€æŸ¥é‡å¤åŠå†—ä½™ç´¢å¼•
pt-duplicate-key-checker \
-uroot \
-p '' \
-h 127.0.0.1
```

ç´¢å¼•ç»´æŠ¤çš„æ–¹æ³•--åˆ é™¤ä¸ç”¨ç´¢å¼•

```
ç›®å‰mysqlä¸­è¿˜æ²¡æœ‰è®°å½•ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯åœ¨PerconMySQLå’ŒMariaDBä¸­å¯é€šè¿‡INDEX_STATISTICSè¡¨æ¥æŸ¥çœ‹å“ªäº›ç´¢å¼•æœªä½¿ç”¨ï¼Œä½†åœ¨mysqlä¸­ç›®å‰åªèƒ½é€šè¿‡æ…¢æŸ¥æ—¥å¿—é…åˆpt-index-usageå·¥å…·æ¥è¿›è¡Œç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æã€‚
pt-index-usage \
	-uroot -p'' \
	mysql-slow.log
```

#### æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–

1ã€é€‰æ‹©**åˆé€‚**çš„æ•°æ®ç±»å‹

```
1.ä½¿ç”¨å¯ä»¥å­˜ä¸‹ä½ çš„æ•°æ®çš„æœ€å°çš„æ•°æ®ç±»å‹
2.ä½¿ç”¨ç®€å•çš„æ•°æ®ç±»å‹ã€‚intè¦æ¯”varcharç±»å‹åœ¨mysqlå¤„ç†ä¸Šæ›´ç®€å•
3.å°½å¯èƒ½çš„ä½¿ç”¨not nullå®šä¹‰å­—æ®µ
4.å°½é‡å°‘ç”¨textç±»å‹ï¼Œéç”¨ä¸å¯æ—¶æœ€å¥½è€ƒè™‘åˆ†è¡¨
*ä½¿ç”¨intæ¥å­˜å‚¨æ—¥å¿—æ—¶é—´ï¼Œåˆ©ç”¨FROM_UNIXTINE()(å¾—åˆ°æ—¥æœŸ),UNIX_TIMESTAMP()(å¾—åˆ°æ—¶é—´æˆ³)ä¸¤ä¸ªå‡½æ•°æ¥è¿›è¡Œè½¬æ¢
*ä½¿ç”¨bigintæ¥å­˜ipåœ°å€ï¼Œåˆ©ç”¨INET_ATON(),INET_NTOA()ä¸¤ä¸ªå‡½æ•°æ¥è¿›è¡Œè½¬æ¢
```

2ã€è¡¨çš„èŒƒå¼åŒ–å’ŒåèŒƒå¼åŒ–

**èŒƒå¼åŒ–**æ˜¯æŒ‡æ•°æ®åº“è®¾è®¡çš„è§„èŒƒï¼Œç›®å‰è¯´åˆ°èŒƒå¼åŒ–ä¸€èˆ¬æ˜¯æŒ‡ç¬¬ä¸‰è®¾è®¡èŒƒå¼ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚æ•°æ®è¡¨ä¸­ä¸å­˜åœ¨éå…³é”®å­—æ®µå¯¹ä»»æ„å€™é€‰å…³é”®å­—æ®µçš„ä¼ é€’å‡½æ•°ä¾èµ–åˆ™ç¬¦åˆç¬¬ä¸‰èŒƒå¼ã€‚

```
ä¸ç¬¦åˆç¬¬ä¸‰èŒƒå¼è¦æ±‚çš„è¡¨å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š
1.æ•°æ®å†—ä½™ï¼šï¼ˆåˆ†ç±»ï¼Œåˆ†ç±»æè¿°ï¼‰å¯¹äºæ¯ä¸€ä¸ªå•†å“éƒ½ä¼šè¿›è¡Œè®°å½•
2.æ•°æ®çš„æ’å…¥å¼‚å¸¸
3.æ•°æ®çš„æ›´æ–°å¼‚å¸¸
4.æ•°æ®çš„åˆ é™¤å¼‚å¸¸
```

**åèŒƒå¼åŒ–**æ˜¯æŒ‡ä¸ºäº†æŸ¥è¯¢æ•ˆç‡çš„è€ƒè™‘æŠŠåŸæœ¬ç¬¦åˆç¬¬ä¸‰èŒƒå¼çš„è¡¨é€‚å½“çš„å¢åŠ å†—ä½™ï¼Œä»¥è¾¾åˆ°ä¼˜åŒ–æŸ¥è¯¢çš„ç›®çš„ï¼ŒåèŒƒå¼åŒ–æ˜¯ä¸€ç§ä»¥ç©ºé—´æ¥æ¢å–æ—¶é—´çš„æ“ä½œã€‚

3ã€è¡¨çš„æ‹†åˆ†

å‚ç›´æ‹†åˆ†

```
æ‰€è°“çš„å‚ç›´æ‹†åˆ†ï¼Œå°±æ˜¯æŠŠåŸæ¥ä¸€ä¸ªæœ‰å¾ˆå¤šåˆ—çš„è¡¨æ‹†åˆ†æˆå¤šä¸ªè¡¨ï¼Œè¿™è§£å†³äº†è¡¨çš„å®½åº¦é—®é¢˜ã€‚é€šå¸¸å‚ç›´æ‹†åˆ†å¯ä»¥æŒ‰ä»¥ä¸‹åŸåˆ™è¿›è¡Œï¼š
1.æŠŠä¸å¸¸ç”¨çš„å­—æ®µå•ç‹¬å­˜æ”¾åˆ°ä¸€ä¸ªè¡¨ä¸­
2.æŠŠå¤§å­—æ®µç‹¬ç«‹å­˜æ”¾åˆ°ä¸€ä¸ªè¡¨ä¸­
3.æŠŠç»å¸¸ä¸€èµ·ä½¿ç”¨çš„å­—æ®µæ”¾åˆ°ä¸€èµ·
```

æ°´å¹³æ‹†åˆ†

```
è¡¨çš„æ°´å¹³æ‹†åˆ†æ˜¯ä¸ºäº†è§£å†³å•è¡¨çš„æ•°æ®é‡è¿‡å¤§çš„é—®é¢˜ï¼Œæ°´å¹³æ‹†åˆ†çš„è¡¨æ¯ä¸€ä¸ªè¡¨çš„ç»“æ„éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚
å¸¸ç”¨çš„æ°´å¹³æ‹†åˆ†æ–¹æ³•ä¸ºï¼š
1.å¯¹idè¿›è¡Œhashè¿ç®—ï¼Œå¦‚æœè¦æ‹†åˆ†æˆ5ä¸ªè¡¨åˆ™ä½¿ç”¨mod(id,5)å»é™¤0-4ä¸ªå€¼
2.é’ˆå¯¹ä¸åŒçš„hashIDæŠŠæ•°æ®å­˜åˆ°ä¸åŒçš„è¡¨ä¸­
```

#### ç³»ç»Ÿé…ç½®ä¼˜åŒ–

1ã€æ“ä½œç³»ç»Ÿé…ç½®ä¼˜åŒ–

æ•°æ®åº“æ˜¯åŸºäºæ“ä½œç³»ç»Ÿçš„ï¼Œç›®å‰å¤§å¤šæ•°mysqléƒ½æ˜¯å®‰è£…åœ¨Linuxç³»ç»Ÿä¹‹ä¸Šï¼Œæ‰€ä»¥å¯¹äºæ“ä½œç³»ç»Ÿçš„ä¸€äº›å‚æ•°é…ç½®ä¹Ÿä¼šå½±å“åˆ°MYSQLçš„æ€§èƒ½ã€‚

```
ç½‘ç»œæ–¹é¢çš„é…ç½®ï¼Œè¦ä¿®æ”¹/etc/stysctl.confæ–‡ä»¶
#å¢åŠ tcpæ”¯æŒçš„é˜Ÿåˆ—æ•°
net.ipv4.tcp_max_syn_backlog = 65535
#å‡å°‘æ–­å¼€é“¾æ¥æ˜¯ï¼Œèµ„æºå›æ”¶
net.ipv4.tcp_max_tw_buckets = 8000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_fin_timeout = 10

æ‰“å¼€æ–‡ä»¶æ•°çš„é™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ulimit -a æŸ¥çœ‹ç›®å½•çš„å„ä½é™åˆ¶ï¼Œå¯ä»¥ä¿®æ”¹/etcsecurity/limitsconfæ–‡ä»¶ï¼Œå¢åŠ ä¸€ä¸‹å†…å®¹ä»¥ä¿®æ”¹æ‰“å¼€æ–‡ä»¶æ•°é‡çš„é™åˆ¶
*soft nofile 65535
*hard nofile 65535
é™¤æ­¤ä¹‹å¤–æœ€å¥½åœ¨mysqlæœåŠ¡å™¨ä¸Šå…³é—­iptablesï¼Œselinuxç­‰é˜²ç«å¢™è½¯ä»¶ã€‚
```

2ã€MySQLæ•°æ®åº“ä¼˜åŒ–

MySQLé…ç½®æ–‡ä»¶

```
mysqlå¯ä»¥é€šè¿‡å¯åŠ¨æ—¶æŒ‡å®šé…ç½®å‚æ•°å’Œä½¿ç”¨é…ç½®æ–‡ä»¶ä¸¤ç§æ–¹æ³•è¿›è¡Œé…ç½®ï¼Œåœ¨å¤§æ•°æƒ…å†µä¸‹é…ç½®æ–‡ä»¶ä½äº/etc/my.cnfæˆ–æ˜¯/etc/mysql/my.cnfåœ¨windowsç³»ç»Ÿé…ç½®æ–‡ä»¶å¯ä»¥æ˜¯ä½äºC:/windows/my.iniæ–‡ä»¶ï¼ŒmysqlæŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„é¡ºåºå¯ä»¥é€šè¿‡ä¸€ä¸‹æ–¹æ³•è·å¾—
/usr/sbin/mysqld --verbose --help | grep -A 1 ' Default options '
```

MySQLé…ç½®æ–‡ä»¶--å¸¸ç”¨å‚æ•°è¯´æ˜

```
1.innodb_buffer_pool_size >= total MB
éå¸¸é‡è¦çš„ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºé…ç½®innodbçš„ç¼“å†²æ± ï¼Œå¦‚æœæ•°æ®åº“ä¸­åªæœ‰innodbè¡¨ï¼Œåˆ™æ¨èé…ç½®é‡ä¸ºæ€»å†…å­˜çš„75%

2.innodb_buffer_pool__instances
MySQL5.5ä¸­æ–°å¢åŠ å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶ç¼“å†²æ± çš„ä¸ªæ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªç¼“å†²æ± ã€‚

3.innodb_log_buffer_size
innodb logç¼“å†²çš„å¤§å°ï¼Œç”±äºæ—¥å¿—æœ€é•¿æ¯ç§’é’Ÿå°±ä¼šåˆ·æ–°æ‰€ä»¥ä¸€èˆ¬ä¸ç”¨å¤ªå¤§ã€‚

4.innodb_flush_log_at_trx_commit
å…³é”®å‚æ•°ï¼Œå¯¹innodbçš„IOæ•ˆç‡å½±å“å¾ˆå¤§ã€‚é»˜è®¤å€¼ä¸º1ï¼Œå¯å–0ï¼Œ1ï¼Œ2ä¸‰ä¸ªå€¼ï¼Œä¸€èˆ¬å»ºè®®ä¸º2ï¼Œä½†å¦‚æœæ•°æ®å®‰å…¨æ€§è¦æ±‚æ¯”è¾ƒé«˜åˆ™ä½¿ç”¨é»˜è®¤å€¼1.

5.innodb_read_io_threads   innodb_write_io_threads
ä»¥ä¸Šä¸¤ä¸ªå‚æ•°å†³å®šäº†Innodbè¯»å†™çš„IOè¿›ç¨‹æ•°ï¼Œé»˜è®¤ä¸º4.

6.innodb_file_per_table
å…³é”®å‚æ•°ï¼Œæ§åˆ¶innodbæ¯ä¸€ä¸ªè¡¨ä½¿ç”¨ç‹¬ç«‹çš„è¡¨ç©ºé—´ï¼Œé»˜è®¤ä¸ºoffï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è¡¨éƒ½ä¼šå»ºç«‹åœ¨å…±äº«è¡¨ç©ºé—´ä¸­ã€‚

7.innodb_stats_on_metadata
å†³å®šäº†mysqlåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåˆ·æ–°innodbè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
```

3ã€ç¬¬ä¸‰æ–¹é…ç½®å·¥å…·

ğŸ”—é“¾æ¥åœ°å€ï¼šhttps://tools.percona.com/wizard

#### æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–

å¦‚ä½•é€‰æ‹©cpuï¼Ÿ

```
1.mysqlæœ‰ä¸€äº›å·¥ä½œåªèƒ½ä½¿ç”¨åˆ°å•æ ¸cpuï¼ŒReplicate,SQL...
2.mysqlå¯¹cpuæ ¸æ•°çš„æ”¯æŒå¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¿«ã€‚mysql5.5ä½¿ç”¨çš„æœåŠ¡å™¨ä¸è¦è¶…è¿‡30æ ¸
```

ç£ç›˜IOä¼˜åŒ–

```
å¸¸ç”¨RAIDçº§åˆ«ç®€ä»‹
RAID0ï¼šä¹Ÿç§°æ¡å¸¦ï¼Œå°±æ˜¯æŠŠå¤šä¸ªç£ç›˜é“¾æ¥æˆä¸€ä¸ªç¡¬ç›˜ä½¿ç”¨ï¼Œè¿™ä¸ªçº§åˆ«IOæœ€å¥½
RAID1ï¼šä¹Ÿç§°é•œåƒï¼Œè¦æ±‚è‡³å°‘æœ‰ä¸¤ä¸ªç£ç›˜ï¼Œæ¯ç»„ç£ç›˜å­˜å‚¨çš„æ•°æ®ç›¸åŒ
RAID5ï¼šä¹Ÿæ˜¯æŠŠå¤šä¸ªç¡¬ç›˜åˆå¹¶æˆä¸€ä¸ªé€»è¾‘ç›˜ä½¿ç”¨ï¼Œæ•°æ®è¯»å†™æ—¶ä¼šå»ºç«‹å¥‡å¶æ ¡éªŒä¿¡æ¯ï¼Œåˆ†åˆ«å­˜å‚¨åœ¨ä¸åŒç£ç›˜ä¸Šã€‚
RAID1+0ï¼šå°±æ˜¯RAID1å’ŒRAID0çš„ç»“åˆã€‚åŒæ—¶å…·å¤‡ä¸¤ä¸ªçº§åˆ«çš„ä¼˜ç¼ºç‚¹ã€‚ä¸€èˆ¬å»ºè®®æ•°æ®åº“ä½¿ç”¨è¿™ä¸ªçº§åˆ«ã€‚

SNAå’ŒNATæ˜¯å¦é€‚åˆæ•°æ®åº“ï¼Ÿ
1.å¸¸ç”¨äºé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆ
2.é¡ºåºè¯»å†™æ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯éšæœºè¯»å†™ä¸å¦‚äººæ„
3.æ•°æ®åº“éšæœºè¯»å†™æ¯”ç‡å¾ˆé«˜
```



## 1.Sqlä¼˜åŒ–æ­¥éª¤

> å½“é¢å¯¹ä¸€ä¸ªæœ‰ SQL æ€§èƒ½é—®é¢˜çš„æ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä»ä½•å¤„å…¥æ‰‹æ¥è¿›è¡Œç³»ç»Ÿçš„åˆ†æï¼Œä½¿å¾—èƒ½ å¤Ÿå°½å¿«å®šä½é—®é¢˜SQLå¹¶å°½å¿«è§£å†³é—®é¢˜

æœ¬æ–‡å±äº[SQL ä¼˜åŒ–](https://blog.csdn.net/qq_39268193/article/details/98491922)ç³»åˆ—ç¯‡

### 1.é€šè¿‡show statuså‘½ä»¤äº†è§£å„ç§SQLçš„æ‰§è¡Œé¢‘ç‡

`MySQL`å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåï¼Œé€šè¿‡ `show [session|global]status` å‘½ä»¤å¯ä»¥æä¾›æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥åœ¨æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨`mysqladmin extended-status` å‘½ä»¤è·å¾—è¿™äº›æ¶ˆæ¯ã€‚`show [session|global] status` å¯ä»¥æ ¹æ®éœ€è¦åŠ ä¸Šå‚æ•°â€œ`session`â€æˆ–è€…â€œ`global`â€æ¥æ˜¾ç¤º`session`çº§ï¼ˆå½“å‰è¿æ¥ï¼‰çš„ç»Ÿè®¡ç»“æœå’Œ`global`çº§ï¼ˆè‡ªæ•°æ®åº“ä¸Šæ¬¡å¯åŠ¨è‡³ä»Šï¼‰çš„ç»Ÿè®¡ç»“æœã€‚å¦‚æœä¸å†™ï¼Œé»˜è®¤ä½¿ç”¨å‚æ•°æ˜¯â€œ`session`â€ ã€‚

ä¸‹é¢çš„å‘½ä»¤æ˜¾ç¤ºäº†å½“å‰`session`ä¸­æ‰€æœ‰ç»Ÿè®¡å‚æ•°çš„å€¼ï¼š

```mysql
mysql> show status like 'Com_%'; 
+--------------------------+-------+ 
| Variable_name            | Value | 
+--------------------------+-------+ 
| Com_admin_commands       | 0     | 
| Com_alter_db             | 0     | 
| Com_alter_event          | 0     | 
| Com_alter_table          | 0     | 
| Com_analyze              | 0     | 
| Com_backup_table         | 0     | 
| Com_begin                | 0     | 
| Com_change_db            | 1     | 
| Com_change_master        | 0     | 
| Com_check                | 0     | 
| Com_checksum             | 0     | 
| Com_commit               | 0     | 
...... 
1234567891011121314151617
```

`Com_xxx` è¡¨ç¤ºæ¯ä¸ª `xxx`è¯­å¥æ‰§è¡Œçš„æ¬¡æ•°ï¼Œæˆ‘ä»¬é€šå¸¸æ¯”è¾ƒå…³å¿ƒçš„æ˜¯ä»¥ä¸‹å‡ ä¸ªç»Ÿè®¡å‚æ•°ã€‚

- `Com_select`ï¼šæ‰§è¡Œ `select` æ“ä½œçš„æ¬¡æ•°ï¼Œä¸€æ¬¡æŸ¥è¯¢åªç´¯åŠ  `1`ã€‚
- `Com_insert`ï¼š æ‰§è¡Œ `INSERT` æ“ä½œçš„æ¬¡æ•°ï¼Œ å¯¹äºæ‰¹é‡æ’å…¥çš„ `INSERT` æ“ä½œï¼Œ åªç´¯åŠ ä¸€æ¬¡ã€‚
- `Com_update`ï¼šæ‰§è¡Œ `UPDATE` æ“ä½œçš„æ¬¡æ•°ã€‚
- `Com_delete`ï¼šæ‰§è¡Œ `DELETE` æ“ä½œçš„æ¬¡æ•°ã€‚

ä¸Šé¢è¿™äº›å‚æ•°å¯¹äºæ‰€æœ‰å­˜å‚¨å¼•æ“çš„è¡¨æ“ä½œéƒ½ä¼šè¿›è¡Œç´¯è®¡ã€‚ä¸‹é¢è¿™å‡ ä¸ªå‚æ•°åªæ˜¯é’ˆå¯¹ `InnoDB` å­˜å‚¨å¼•æ“çš„ï¼Œç´¯åŠ çš„ç®—æ³•ä¹Ÿç•¥æœ‰ä¸åŒã€‚

- `Innodb_rows_read`ï¼š`select` æŸ¥è¯¢è¿”å›çš„è¡Œæ•°ã€‚
- `Innodb_rows_inserted`ï¼šæ‰§è¡Œ `INSERT` æ“ä½œæ’å…¥çš„è¡Œæ•°ã€‚
- `Innodb_rows_updated`ï¼šæ‰§è¡Œ `UPDATE` æ“ä½œæ›´æ–°çš„è¡Œæ•°ã€‚
- `Innodb_rows_deleted`ï¼šæ‰§è¡Œ `DELETE` æ“ä½œåˆ é™¤çš„è¡Œæ•°ã€‚

é€šè¿‡ä»¥ä¸Šå‡ ä¸ªå‚æ•°ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°äº†è§£å½“å‰æ•°æ®åº“çš„åº”ç”¨æ˜¯ä»¥æ’å…¥æ›´æ–°ä¸ºä¸»è¿˜æ˜¯ä»¥æŸ¥è¯¢ æ“ä½œä¸ºä¸»ï¼Œä»¥åŠå„ç§ç±»å‹çš„ `SQL` å¤§è‡´çš„æ‰§è¡Œæ¯”ä¾‹æ˜¯å¤šå°‘ã€‚å¯¹äºæ›´æ–°æ“ä½œçš„è®¡æ•°ï¼Œæ˜¯å¯¹æ‰§è¡Œæ¬¡æ•°çš„è®¡æ•°ï¼Œä¸è®ºæäº¤è¿˜æ˜¯å›æ»šéƒ½ä¼šè¿›è¡Œç´¯åŠ ã€‚

å¯¹äºäº‹åŠ¡å‹çš„åº”ç”¨ï¼Œ é€šè¿‡`Com_commit`å’Œ`Com_rollback`å¯ä»¥äº†è§£äº‹åŠ¡æäº¤å’Œå›æ»šçš„æƒ…å†µï¼Œ å¯¹äºå›æ»šæ“ä½œéå¸¸é¢‘ç¹çš„æ•°æ®åº“ï¼Œå¯èƒ½æ„å‘³ç€åº”ç”¨ç¼–å†™å­˜åœ¨é—®é¢˜ã€‚

æ­¤å¤–ï¼Œä»¥ä¸‹å‡ ä¸ªå‚æ•°ä¾¿äºç”¨æˆ·äº†è§£æ•°æ®åº“çš„åŸºæœ¬æƒ…å†µã€‚

- `Connections`ï¼šè¯•å›¾è¿æ¥ `MySQL` æœåŠ¡å™¨çš„æ¬¡æ•°ã€‚
- `Uptime`ï¼šæœåŠ¡å™¨å·¥ä½œæ—¶é—´ã€‚
- `Slow_queries`ï¼šæ…¢æŸ¥è¯¢çš„æ¬¡æ•°ã€‚

### 2.å®šä½æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„ SQL è¯­å¥

å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®šä½æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„ `SQL` è¯­å¥ã€‚

- é€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—å®šä½é‚£äº›æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„ `SQL` è¯­å¥ï¼Œç”¨-`-log-slow-queries[=file_name]`é€‰é¡¹å¯åŠ¨æ—¶ï¼Œ`mysqld` å†™ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡ `long_query_time` ç§’çš„ `SQL` è¯­å¥çš„æ—¥å¿—æ–‡ä»¶ã€‚
- æ…¢æŸ¥è¯¢æ—¥å¿—åœ¨æŸ¥è¯¢ç»“æŸä»¥åæ‰çºªå½•ï¼Œ æ‰€ä»¥åœ¨åº”ç”¨åæ˜ æ‰§è¡Œæ•ˆç‡å‡ºç°é—®é¢˜çš„æ—¶å€™æŸ¥è¯¢æ…¢æŸ¥ è¯¢æ—¥å¿—å¹¶ä¸èƒ½å®šä½é—®é¢˜ï¼Œ å¯ä»¥ä½¿ç”¨==show processlist==å‘½ä»¤æŸ¥çœ‹å½“å‰`MySQL`åœ¨è¿›è¡Œçš„çº¿ç¨‹ï¼Œ åŒ…æ‹¬çº¿ç¨‹çš„çŠ¶æ€ã€æ˜¯å¦é”è¡¨ç­‰ï¼Œå¯ä»¥å®æ—¶åœ°æŸ¥çœ‹ `SQL` çš„æ‰§è¡Œæƒ…å†µï¼ŒåŒæ—¶å¯¹ä¸€äº›é”è¡¨æ“ ä½œè¿›è¡Œä¼˜åŒ–ã€‚

### 3[.é€šè¿‡ EXPLAIN åˆ†æä½æ•ˆ SQL çš„æ‰§è¡Œè®¡åˆ’](https://blog.csdn.net/lilongsy/article/details/95184594?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param)

é€šè¿‡ä»¥ä¸Šæ­¥éª¤æŸ¥è¯¢åˆ°æ•ˆç‡ä½çš„ `SQL` è¯­å¥åï¼Œ å¯ä»¥é€šè¿‡ `EXPLAIN` æˆ–è€… `DESC`å‘½ä»¤è·å– `MySQL` å¦‚ä½•æ‰§è¡Œ `SELECT` è¯­å¥çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨ `SELECT` è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­è¡¨å¦‚ä½•è¿æ¥å’Œè¿æ¥çš„é¡ºåºï¼Œæ¯”å¦‚æƒ³è®¡ç®— `2006` å¹´æ‰€æœ‰å…¬å¸çš„é”€å”®é¢ï¼Œéœ€è¦å…³è” `sales` è¡¨å’Œ `company` è¡¨ï¼Œå¹¶ä¸”å¯¹ `moneys` å­—æ®µ åšæ±‚å’Œï¼ˆ`sum`ï¼‰æ“ä½œï¼Œç›¸åº” `SQL` çš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹ï¼š

```mysql
mysql> explain select sum(moneys) from sales a,company b where a.company_id = b.id and a.year = 2006\G;
*************************** 1. row ***************************
	       id: 1
  select_type: SIMPLE
	    table: a
	     type: ALL
possible_keys: NULL
		  key: NULL
	  key_len: NULL
		  ref: NULL
		 rows: 1000
		Extra: Using where
*************************** 2. row ***************************
           id: 1
  select_type: SIMPLE
        table: b
         type: ref
possible_keys: ind_company_id
          key: ind_company_id
      key_len: 5
          ref: sakila.a.company_id
	     rows: 1
	    Extra: Using where; Using index
2 rows in set (0.00 sec)
123456789101112131415161718192021222324
```

æ¯ä¸ªåˆ—çš„ç®€å•è§£é‡Šå¦‚ä¸‹ï¼š

* `id`ï¼šä»£è¡¨selectå­å¥æˆ–è€…æ˜¯æ“ä½œè¡¨çš„é¡ºåº
  * idç›¸åŒï¼Œè¡¨ç¤ºåŠ è½½è¡¨çš„é¡ºåºæ˜¯ä»ä¸Šåˆ°ä¸‹ï¼ˆä¾‹å¦‚è¿è¡¨æŸ¥è¯¢ select * from user ,role where user.id = role.idï¼‰
  * idä¸åŒï¼Œidå€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œï¼ˆä¾‹å¦‚åµŒå¥—å­æŸ¥è¯¢ selelct * from user where id = (select id)ï¼‰
  * åŒæ—¶å­˜åœ¨idç›¸åŒå’Œä¸åŒ

- `select_type`ï¼šè¡¨ç¤º `SELECT` çš„ç±»å‹ï¼Œå¸¸è§çš„å–å€¼æœ‰ `SIMPLE`ï¼ˆç®€å•è¡¨ï¼Œå³ä¸ä½¿ç”¨è¡¨è¿æ¥ æˆ–è€…å­æŸ¥è¯¢ï¼‰ ã€`PRIMARY`ï¼ˆä¸»æŸ¥è¯¢ï¼Œå³å¤–å±‚çš„æŸ¥è¯¢ï¼‰ ã€`Dervied`ä¸´æ—¶è¡ç”Ÿè¡¨ã€`SUBQUERY`ï¼ˆå­æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ä¸ª `SELECT`ã€`UNION`ï¼ˆ`UNION` ä¸­çš„ç¬¬äºŒä¸ªæˆ– è€…åé¢çš„æŸ¥è¯¢è¯­å¥ï¼‰ ï¼‰ç­‰ã€‚
- `table`ï¼šè¾“å‡ºç»“æœé›†çš„è¡¨ã€‚
- `type`ï¼šè¡¨ç¤ºè¡¨çš„è¿æ¥ç±»å‹ï¼Œæ€§èƒ½ç”±å¥½åˆ°å·®çš„è¿æ¥ç±»å‹ä¸º
  - null,ä¾‹å¦‚select now():
  -  `system`ï¼ˆè¡¨ä¸­ä»…æœ‰ä¸€è¡Œï¼Œå³ å¸¸é‡è¡¨ï¼‰ ã€
  - `const`ï¼ˆé€šè¿‡ç´¢å¼•ä¸€æ¬¡å°±æ‰¾åˆ°äº†ï¼Œå•è¡¨ä¸­æœ€å¤šæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œä¾‹å¦‚ `primary key` æˆ–è€… `unique index`ï¼‰ 
  -  `eq_ref`ï¼ˆå¯¹äºå‰é¢çš„æ¯ä¸€è¡Œï¼Œåœ¨æ­¤è¡¨ä¸­åªæŸ¥è¯¢ä¸€æ¡è®°å½•ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¤šè¡¨è¿æ¥ ä¸­ä½¿ç”¨`primary key`æˆ–è€…`unique index`ï¼‰ ã€
  -  `ref`ï¼ˆä¸`eq_ref`ç±»ä¼¼ï¼Œ åŒºåˆ«åœ¨äºä¸æ˜¯ä½¿ç”¨`primary key` æˆ–è€… `unique index`ï¼Œè€Œæ˜¯ä½¿ç”¨æ™®é€šçš„ç´¢å¼•ï¼‰ ã€`ref_or_null`ï¼ˆä¸ `ref` ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº æ¡ä»¶ä¸­åŒ…å«å¯¹ `NULL` çš„æŸ¥è¯¢ï¼‰ ã€`index_merge`(ç´¢å¼•åˆå¹¶ä¼˜åŒ–)ã€`unique_subquery`ï¼ˆ`in` çš„åé¢æ˜¯ä¸€ä¸ªæŸ¥è¯¢ä¸»é”®å­—æ®µçš„å­æŸ¥è¯¢ï¼‰ ã€ `index_subquery` ï¼ˆä¸ `unique_subquery` ç±»ä¼¼ï¼Œ åŒºåˆ«åœ¨äº `in` çš„åé¢æ˜¯æŸ¥è¯¢éå”¯ä¸€ç´¢å¼•å­—æ®µçš„å­æŸ¥è¯¢ï¼‰ ã€
  -  `range` ï¼ˆå•è¡¨ä¸­çš„èŒƒå›´æŸ¥è¯¢ï¼‰ ã€ 
  - `index` ï¼ˆå¯¹äºå‰é¢çš„æ¯ä¸€è¡Œï¼Œ éƒ½é€šè¿‡æŸ¥è¯¢ç´¢å¼•æ¥å¾—åˆ°æ•°æ®ï¼‰ ã€
  -  `all` ï¼ˆå¯¹äºå‰é¢çš„æ¯ä¸€è¡Œï¼Œ éƒ½é€šè¿‡å…¨è¡¨æ‰«ææ¥å¾—åˆ°æ•°æ®ï¼‰
- `possible_keys`ï¼šè¡¨ç¤ºæŸ¥è¯¢æ—¶ï¼Œå¯èƒ½ä½¿ç”¨çš„ç´¢å¼•ã€‚
- `key`ï¼šè¡¨ç¤ºå®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚
- `key_len`ï¼šç´¢å¼•å­—æ®µçš„é•¿åº¦ã€‚
- ref:å¼•ç”¨
- `rows`ï¼šæ‰«æè¡Œçš„æ•°é‡ã€‚
- `Extra`ï¼šæ‰§è¡Œæƒ…å†µçš„è¯´æ˜å’Œæè¿°ã€‚
  - using filesort:è¯´æ˜mysqlä¼šå¯¹æ•°æ®ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç…§è¡¨å†…çš„ç´¢å¼•é¡ºåºè¿›è¡Œè¯»å–ï¼Œç§°ä¸ºæ–‡ä»¶æ’åº
  - using temporary:ä½¿ç”¨äº†ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼Œmysqlåœ¨å¯¹æŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œå¸¸è§äºorder byï¼Œgroup by
  - using indexï¼šè¡¨ç¤ºç›¸åº”çš„selectæ“ä½œä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼ˆä¸éœ€è¦å›è¡¨æŸ¥è¯¢ï¼‰ï¼Œé¿å…è®¿é—®è¡¨çš„æ•°æ®è¡Œï¼Œæ•ˆç‡ä¸é”™

### 4.ç¡®å®šé—®é¢˜å¹¶é‡‡å–ç›¸åº”çš„ä¼˜åŒ–æªæ–½

#### ptofile

> æŸ¥çœ‹è¡¨è€—è´¹æ—¶é—´

```cmd
#æŸ¥çœ‹æ˜¯å¦æ”¯æŒprofiling
mysql> select @@have_profiling;
+------------------+
| @@have_profiling |
+------------------+
| YES              |
+------------------+
1 row in set (0.00 sec)
#æŸ¥çœ‹æ˜¯å¦å¼€å¯profileing
mysql> select @@profilingï¼›
+-------------+
| @@profiling |
+-------------+
|           0 |
+-------------+
1 row in set (0.00 sec)
#è®¾ç½®profilingä¸º1
mysql> set @@profiling=1;
Query OK, 0 rows affected (0.00 sec)

mysql> select @@profiling;
+-------------+
| @@profiling |
+-------------+
|           1 |
+-------------+
1 row in set (0.00 sec)
#æŸ¥çœ‹è¡¨è€—æ—¶
mysql> show profiles;
+----------+------------+------------------------------+
| Query_ID | Duration   | Query                        |
+----------+------------+------------------------------+
|        1 | 0.00011925 | set @@profiling=1            |
|        2 | 0.00122275 | select @@profiling           |
|        3 | 0.00799600 | show databases               |
|        4 | 0.00051650 | SELECT DATABASE()            |
|        5 | 0.00120550 | show tables                  |
|        6 | 0.00491975 | select count(*) from student |
|        7 | 0.00365100 | select * from user           |
+----------+------------+------------------------------+
7 rows in set (0.00 sec)
# æŸ¥çœ‹æŸ¥è¯¢idç»å†çš„é˜¶æ®µï¼Œä»¥åŠè€—æ—¶
mysql> show profile ï¼ˆcpuï¼‰ for query 3;
+--------------------+----------+
| Status             | Duration |
+--------------------+----------+
| starting           | 0.000061 |
| Opening tables     | 0.002288 |
| System lock        | 0.000056 |
| init               | 0.000005 |
| optimizing         | 0.000002 |
| statistics         | 0.000007 |
| preparing          | 0.000005 |
| executing          | 0.005316 |
| Sending data       | 0.000023 |  //è®¿é—®æ•°æ®è¡Œå¹¶å°†ç»“æœè¿”å›åˆ°å®¢æˆ·ç«¯
| end                | 0.000007 |
| query end          | 0.000002 |
| closing tables     | 0.000001 |
| removing tmp table | 0.000165 |
| closing tables     | 0.000004 |
| freeing items      | 0.000050 |
| logging slow query | 0.000001 |
| cleaning up        | 0.000003 |
+--------------------+----------+
17 rows in set (0.00 sec)

```

#### trace

> traceåˆ†æä¼˜åŒ–å™¨

###### åœ¨æˆ‘ä»¬è°ƒä¼˜MySQLçš„SQLæ—¶å€™ï¼Œé€šå¸¸ä½¿ç”¨explainè¿›è¡ŒæŸ¥çœ‹sqlçš„æ‰§è¡Œè®¡åˆ’ã€‚è‡³äºä¼˜åŒ–å™¨ä¸ºä»€ä¹ˆä¼šè¿™æ ·é€‰æ‹©ï¼Œå°±æ— ä»å¾—çŸ¥ã€‚å¦‚æœä½ æƒ³äº†è§£ä¸ºä»€ä¹ˆï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡traceæ–‡ä»¶èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ä¸ºä»€ä¹ˆä¼˜åŒ–å™¨é€‰æ‹©Aæ‰§è¡Œè®¡åˆ’è€Œä¸é€‰æ‹©Bæ‰§è¡Œè®¡åˆ’.å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£ä¼˜åŒ–å™¨çš„è¡Œä¸º.

###### æ‰“å¼€trace,å¹¶è®¾ç½®æ ¼å¼ä¸ºJson

> SET OPTIMIZER_TRACE=â€œenabled=onâ€,END_MARKERS_IN_JSON=on;

###### è®¾ç½®traceä½¿ç”¨çš„å†…å­˜å¤§å°,é¿å…è§£æè¿‡ç¨‹å†…å­˜ä¸è¶³,æ–‡ä»¶æ˜¾ç¤ºä¸å®Œæ•´.

> SET OPTIMIZER_TRACE_MAX_MEM_SIZE=1000000;

###### æ‰§è¡Œä½ çš„sqlè¯­å¥

> select * from a, b where a.id=b.sid;

###### æŸ¥çœ‹traceä¿¡æ¯

> SELECT * FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;

###### TRACE jsonæ–‡ä»¶

```cmd
{
"steps": [
{
  "join_preparation": {  ---ä¼˜åŒ–å‡†å¤‡å·¥ä½œ
    "select#": 1,
    "steps": [
      {
        "expanded_query": "/* select#1 */ select `a`.`id` AS `id`,`a`.`name` AS `name`,`a`.`age` AS `age`,`b`.`id` AS `id`,`b`.`sid` AS `sid`,`b`.`name` AS `name`,`b`.`score` AS `score` from `a` join `b` where (`a`.`id` = `b`.`sid`)"
      }
    ] /* steps */
  } /* join_preparation */
},
{
  "join_optimization": {---ä¼˜åŒ–å·¥ä½œçš„ä¸»è¦é˜¶æ®µ,åŒ…æ‹¬é€»è¾‘ä¼˜åŒ–å’Œç‰©ç†ä¼˜åŒ–ä¸¤ä¸ªé˜¶æ®µ
    "select#": 1,
    "steps": [---ä¼˜åŒ–å·¥ä½œçš„ä¸»è¦é˜¶æ®µ, é€»è¾‘ä¼˜åŒ–é˜¶æ®µ  
      {
        "condition_processing": {  ---é€»è¾‘ä¼˜åŒ–,æ¡ä»¶åŒ–ç®€  
          "condition": "WHERE",
          "original_condition": "(`a`.`id` = `b`.`sid`)",
          "steps": [
            {
              "transformation": "equality_propagation",  ---é€»è¾‘ä¼˜åŒ–,æ¡ä»¶åŒ–ç®€,ç­‰å¼å¤„ç†
              "resulting_condition": "(`a`.`id` = `b`.`sid`)"
            },
            {
              "transformation": "constant_propagation", ---é€»è¾‘ä¼˜åŒ–,æ¡ä»¶åŒ–ç®€,å¸¸é‡å¤„ç†
              "resulting_condition": "(`a`.`id` = `b`.`sid`)"
            },
            {
              "transformation": "trivial_condition_removal",  ---é€»è¾‘ä¼˜åŒ–,æ¡ä»¶åŒ–ç®€,æ¡ä»¶å»é™¤
              "resulting_condition": "(`a`.`id` = `b`.`sid`)"
            }
          ] /* steps */
        } /* condition_processing */
      }, ---é€»è¾‘ä¼˜åŒ–,æ¡ä»¶åŒ–ç®€,ç»“æŸ 
      {
        "substitute_generated_columns": {
        } /* substitute_generated_columns */
      },
      {
        "table_dependencies": [ ---é€»è¾‘ä¼˜åŒ–, æ‰¾å‡ºè¡¨ä¹‹é—´çš„ç›¸äº’ä¾èµ–å…³ç³». éç›´æ¥å¯ç”¨çš„ä¼˜åŒ–æ–¹å¼.
          {
            "table": "`a`", ---è¡¨å
            "row_may_be_null": false, ---æ˜¯å¦æœ‰nullå€¼ï¼Œflaseæ˜¯æ²¡æœ‰
            "map_bit": 0,
            "depends_on_map_bits": [
            ] /* depends_on_map_bits */
          },
          {
            "table": "`b`",
            "row_may_be_null": false,
            "map_bit": 1,
            "depends_on_map_bits": [
            ] /* depends_on_map_bits */
          }
        ] /* table_dependencies */
      },
      {
        "ref_optimizer_key_uses": [ ---é€»è¾‘ä¼˜åŒ–,  æ‰¾å‡ºå¤‡é€‰çš„ç´¢å¼•  
          {
            "table": "`a`",  
            "field": "id", --ç´¢å¼•å­—æ®µ
            "equals": "`b`.`sid`",  --è¿æ¥çš„ç­‰å€¼å­—æ®µ
            "null_rejecting": false
          },
          {
            "table": "`b`",
            "field": "sid",
            "equals": "`a`.`id`",
            "null_rejecting": false
          }
        ] /* ref_optimizer_key_uses */
      },
      {
        "rows_estimation": [  ---é€»è¾‘ä¼˜åŒ–, ä¼°ç®—æ¯ä¸ªè¡¨çš„å…ƒç»„ä¸ªæ•°. å•è¡¨ä¸Šè¿›è¡Œå…¨è¡¨æ‰«æå’Œç´¢å¼•æ‰«æçš„ä»£ä»·ä¼°ç®—. æ¯ä¸ªç´¢å¼•éƒ½ä¼°ç®—ç´¢å¼•æ‰«æä»£ä»·  
          {
            "table": "`a`",
            "table_scan": { ---é€»è¾‘ä¼˜åŒ–, ä¼°ç®—æ¯ä¸ªè¡¨çš„å…ƒç»„ä¸ªæ•°. å•è¡¨ä¸Šè¿›è¡Œå…¨è¡¨æ‰«æçš„ä»£ä»·
              "rows": 10,
              "cost": 1
            } /* table_scan */
          },
          {
            "table": "`b`",
            "table_scan": {
              "rows": 21,
              "cost": 1
            } /* table_scan */
          }
        ] /* rows_estimation */
      },
      {
        "considered_execution_plans": [  ---ç‰©ç†ä¼˜åŒ–, å¼€å§‹å¤šè¡¨è¿æ¥çš„ç‰©ç†ä¼˜åŒ–è®¡ç®—
          {
            "plan_prefix": [
            ] /* plan_prefix */,
            "table": "`a`",
            "best_access_path": {
              "considered_access_paths": [
                {
                  "access_type": "ref",  ---ç‰©ç†ä¼˜åŒ–, è®¡ç®—indx_userç´¢å¼•ä¸Šä½¿ç”¨refæ–¹æŸ¥æ‰¾çš„èŠ±è´¹
                  "index": "PRIMARY",
                  "usable": false,
                  "chosen": false  ---ç‰©ç†ä¼˜åŒ–, æœ¬åº”è¯¥æ¯”è¾ƒæ‰€æœ‰çš„å¯ç”¨ç´¢å¼•,å³æ‰“å°å‡ºå¤šä¸ªæ ¼å¼ç›¸åŒçš„ä½†ç´¢å¼•åä¸åŒçš„å†…å®¹,è¿™é‡Œå´æ²¡æœ‰ã€‚æ¨æµ‹æ˜¯bug--æ²¡æœ‰éå†æ¯ä¸€ä¸ªç´¢å¼•. 
                },
                {
                  "rows_to_scan": 10,
                  "access_type": "scan",
                  "resulting_rows": 10,
                  "cost": 3,
                  "chosen": true
                }
              ] /* considered_access_paths */
            } /* best_access_path */,
            "condition_filtering_pct": 100,
            "rows_for_plan": 10,
            "cost_for_plan": 3,
            "rest_of_plan": [
              {
                "plan_prefix": [
                  "`a`"
                ] /* plan_prefix */,
                "table": "`b`",
                "best_access_path": {
                  "considered_access_paths": [
                    {
                      "access_type": "ref",
                      "index": "idx_sid",
                      "rows": 2.1,
                      "cost": 25.2,
                      "chosen": true
                    },
                    {
                      "rows_to_scan": 21,
                      "access_type": "scan",
                      "using_join_cache": true,
                      "buffers_needed": 1,
                      "resulting_rows": 21,
                      "cost": 43.006,
                      "chosen": false
                    }
                  ] /* considered_access_paths */
                } /* best_access_path */,
                "condition_filtering_pct": 100,
                "rows_for_plan": 21,
                "cost_for_plan": 28.2,
                "chosen": true
              }
            ] /* rest_of_plan */
          },
          {
            "plan_prefix": [
            ] /* plan_prefix */,
            "table": "`b`",
            "best_access_path": {
              "considered_access_paths": [
                {
                  "access_type": "ref",
                  "index": "idx_sid",
                  "usable": false,
                  "chosen": false
                },
                {
                  "rows_to_scan": 21,
                  "access_type": "scan",
                  "resulting_rows": 21,
                  "cost": 5.2,
                  "chosen": true
                }
              ] /* considered_access_paths */
            } /* best_access_path */,
            "condition_filtering_pct": 100,
            "rows_for_plan": 21,
            "cost_for_plan": 5.2,
            "rest_of_plan": [
              {
                "plan_prefix": [
                  "`b`"
                ] /* plan_prefix */,
                "table": "`a`",
                "best_access_path": {
                  "considered_access_paths": [
                    {
                      "access_type": "eq_ref",
                      "index": "PRIMARY",
                      "rows": 1,
                      "cost": 25.2,
                      "chosen": true,
                      "cause": "clustered_pk_chosen_by_heuristics"
                    },
                    {
                      "rows_to_scan": 10,
                      "access_type": "scan",
                      "using_join_cache": true,
                      "buffers_needed": 1,
                      "resulting_rows": 10,
                      "cost": 43.013,
                      "chosen": false
                    }
                  ] /* considered_access_paths */
                } /* best_access_path */,
                "condition_filtering_pct": 100,
                "rows_for_plan": 21,
                "cost_for_plan": 30.4,
                "pruned_by_cost": true
              }
            ] /* rest_of_plan */
          }
        ] /* considered_execution_plans */
      },
      {
        "attaching_conditions_to_tables": {
          "original_condition": "(`a`.`id` = `b`.`sid`)",
          "attached_conditions_computation": [
          ] /* attached_conditions_computation */,
          "attached_conditions_summary": [
            {
              "table": "`a`",
              "attached": null
            },
            {
              "table": "`b`",
              "attached": "(`a`.`id` = `b`.`sid`)"
            }
          ] /* attached_conditions_summary */
        } /* attaching_conditions_to_tables */
      },
      {
        "refine_plan": [
          {
            "table": "`a`"
          },
          {
            "table": "`b`",
            "pushed_index_condition": "(`a`.`id` = `b`.`sid`)",
            "table_condition_attached": null
          }
        ] /* refine_plan */
      }
    ] /* steps */
  } /* join_optimization */
},
{
  "join_execution": {
    "select#": 1,
    "steps": [
    ] /* steps */
  } /* join_execution */
}
] /* steps */
}
```



ç»è¿‡ä»¥ä¸Šæ­¥éª¤ï¼ŒåŸºæœ¬å°±å¯ä»¥ç¡®è®¤é—®é¢˜å‡ºç°çš„åŸå› ã€‚æ­¤æ—¶ç”¨æˆ·å¯ä»¥æ ¹æ®æƒ…å†µé‡‡å–ç›¸åº”çš„æªæ–½ï¼Œè¿›è¡Œä¼˜åŒ–æé«˜æ‰§è¡Œçš„æ•ˆç‡ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå·²ç»å¯ä»¥ç¡®è®¤æ˜¯å¯¹ a è¡¨çš„å…¨è¡¨æ‰«æå¯¼è‡´æ•ˆç‡çš„ä¸ç†æƒ³ï¼Œé‚£ä¹ˆå¯¹ `a` è¡¨çš„ `year` å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```mysql
mysql> create index ind_sales2_year on sales2(year); 
Query OK, 1000 rows affected (0.03 sec) 
Records: 1000  Duplicates: 0  Warnings: 0 
123
```

åˆ›å»ºç´¢å¼•åï¼Œå†çœ‹ä¸€ä¸‹è¿™æ¡è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```mysql
mysql> explain select sum(moneys) from sales a,company b where a.company_id = b.id and a.year = 2006\G;
*************************** 1. row ***************************
	       id: 1
  select_type: SIMPLE
	    table: a
	     type: ref
possible_keys: ind_sales2_year 
		  key: ind_sales2_year 
	  key_len: 2
		  ref: const
		 rows: 1
		Extra: Using where
*************************** 2. row ***************************
           id: 1
  select_type: SIMPLE
        table: b
         type: ref
possible_keys: ind_company2_id
          key: ind_company2_id
      key_len: 5
          ref: sakila.a.company_id
	     rows: 1
	    Extra: Using where; Using index
2 rows in set (0.00 sec)
123456789101112131415161718192021222324
```

å¯ä»¥å‘ç°å»ºç«‹ç´¢å¼•åå¯¹ a è¡¨éœ€è¦æ‰«æçš„è¡Œæ•°æ˜æ˜¾å‡å°‘ ï¼ˆä» `1000` è¡Œå‡å°‘åˆ° `1` è¡Œï¼‰ ï¼Œ å¯è§ç´¢å¼•çš„ ä½¿ç”¨å¯ä»¥å¤§å¤§æé«˜æ•°æ®åº“çš„è®¿é—®é€Ÿåº¦ï¼Œå°¤å…¶åœ¨è¡¨å¾ˆåºå¤§çš„æ—¶å€™è¿™ç§ä¼˜åŠ¿æ›´ä¸ºæ˜æ˜¾ã€‚

## 2.ç´¢å¼•é—®é¢˜

### 1. ç´¢å¼•çš„å­˜å‚¨åˆ†ç±»

`MyISAM` å­˜å‚¨å¼•æ“çš„è¡¨çš„æ•°æ®å’Œç´¢å¼•æ˜¯è‡ªåŠ¨åˆ†å¼€å­˜å‚¨çš„ï¼Œ å„è‡ªæ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªæ–‡ä»¶ï¼› `InnoDB` å­˜å‚¨å¼•æ“çš„è¡¨çš„æ•°æ®å’Œç´¢å¼•æ˜¯å­˜å‚¨åœ¨åŒä¸€ä¸ªè¡¨ç©ºé—´é‡Œé¢ï¼Œä½†å¯ä»¥æœ‰å¤šä¸ªæ–‡ä»¶ç»„æˆã€‚ `MySQL` ä¸­ç´¢å¼•çš„å­˜å‚¨ç±»å‹ç›®å‰åªæœ‰ä¸¤ç§ï¼ˆ`BTREE` å’Œ `HASH`ï¼‰ ï¼Œå…·ä½“å’Œè¡¨çš„å­˜å‚¨å¼•æ“ç›¸å…³ï¼š `MyISAM` å’Œ `InnoDB` å­˜å‚¨å¼•æ“éƒ½åªæ”¯æŒ `BTREE` ç´¢å¼•ï¼›`MEMORY/HEAP` å­˜å‚¨å¼•æ“å¯ä»¥æ”¯æŒ `HASH` å’Œ `BTREE` ç´¢å¼•ã€‚ä¸‹é¢æ˜¯åˆ›å»ºå‰ç¼€ç´¢å¼•çš„ä¸€ä¸ªä¾‹å­ï¼š

```mysql
mysql> create index ind_company2_name on company2(name(4)); 
Query OK, 1000 rows affected (0.03 sec)
Records: 1000  Duplicates: 0  Warnings: 0
123
```

### 2. MySQL å¦‚ä½•ä½¿ç”¨ç´¢å¼•

ç´¢å¼•ç”¨äºå¿«é€Ÿæ‰¾å‡ºåœ¨æŸä¸ªåˆ—ä¸­æœ‰ä¸€ç‰¹å®šå€¼çš„è¡Œã€‚å¯¹ç›¸å…³åˆ—ä½¿ç”¨ç´¢å¼•æ˜¯æé«˜ `SELECT` æ“ä½œæ€§èƒ½çš„æœ€ä½³é€”å¾„ã€‚

æŸ¥è¯¢è¦ä½¿ç”¨ç´¢å¼•æœ€ä¸»è¦çš„æ¡ä»¶æ˜¯æŸ¥è¯¢æ¡ä»¶ä¸­éœ€è¦ä½¿ç”¨ç´¢å¼•å…³é”®å­—ï¼Œå¦‚æœæ˜¯å¤šåˆ—ç´¢å¼•ï¼Œé‚£ä¹ˆåªæœ‰æŸ¥è¯¢æ¡ä»¶ä½¿ç”¨äº†å¤šåˆ—å…³é”®å­—æœ€å·¦è¾¹çš„å‰ç¼€æ—¶ï¼Œ æ‰å¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œ å¦åˆ™å°†ä¸èƒ½ä½¿ç”¨ç´¢å¼•ã€‚

### 2.1 ä½¿ç”¨ç´¢å¼•

åœ¨ `MySQL` ä¸­ï¼Œä¸‹åˆ—å‡ ç§æƒ…å†µä¸‹æœ‰å¯èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ã€‚

1. å¯¹äºåˆ›å»ºçš„å¤šåˆ—ç´¢å¼•ï¼Œåªè¦æŸ¥è¯¢çš„æ¡ä»¶ä¸­ç”¨åˆ°äº†æœ€å·¦è¾¹çš„åˆ—ï¼Œç´¢å¼•ä¸€èˆ¬å°±ä¼šè¢«ä½¿ç”¨ï¼Œ ä¸¾ä¾‹è¯´æ˜å¦‚ä¸‹ã€‚

   é¦–å…ˆæŒ‰ `company_id`ï¼Œ`moneys` çš„é¡ºåºåˆ›å»ºä¸€ä¸ªå¤åˆç´¢å¼•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

   ```mysql
   mysql> create index ind_sales2_companyid_moneys on sales2(company_id,moneys); 
   Query OK, 1000 rows affected (0.03 sec) 
   Records: 1000  Duplicates: 0  Warnings: 0 
   123
   ```

   ç„¶åæŒ‰ `company_id` è¿›è¡Œè¡¨æŸ¥è¯¢ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

   ```mysql
   mysql> explain select * from sales2 where company_id = 2006\G; 
   *************************** 1. row *************************** 
              id: 1
     select_type: SIMPLE 
           table: sales2 
            type: ref 
   possible_keys: ind_sales2_companyid_moneys 
             key: ind_sales2_companyid_moneys 
         key_len: 5 
             ref: const 
            rows: 1 
           Extra: Using where 
    1 row in set (0.00 sec) 
   12345678910111213
   ```

   å¯ä»¥å‘ç°å³ä¾¿ `where` æ¡ä»¶ä¸­ä¸æ˜¯ç”¨çš„ `company_id` ä¸ `moneys` çš„ç»„åˆæ¡ä»¶ï¼Œç´¢å¼•ä»ç„¶èƒ½ç”¨åˆ°ï¼Œè¿™å°±æ˜¯ç´¢å¼•çš„å‰ç¼€ç‰¹æ€§ã€‚ä½†æ˜¯å¦‚æœåªæŒ‰ `moneys` æ¡ä»¶æŸ¥è¯¢è¡¨ï¼Œé‚£ä¹ˆç´¢å¼•å°±ä¸ä¼šè¢«ç”¨åˆ°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

   ```mysql
   mysql> explain select * from company2 where name like '%3'\G; 
   *************************** 1. row *************************** 
              id: 1
     select_type: SIMPLE 
           table: sales2 
            type: ALL 
   possible_keys: NULL
             key: NULL
         key_len: NULL 
             ref: NULL
            rows: 1000 
           Extra: Using  where 
   1 row in set (0.00 sec) 
   12345678910111213
   ```

2. å¯¹äºä½¿ç”¨ `like` çš„æŸ¥è¯¢ï¼Œåé¢å¦‚æœæ˜¯å¸¸é‡å¹¶ä¸”åªæœ‰`ï¼…`å·ä¸åœ¨ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œç´¢å¼•æ‰å¯èƒ½ä¼šè¢«ä½¿ç”¨ï¼Œæ¥çœ‹ä¸‹é¢ä¸¤ä¸ªæ‰§è¡Œè®¡åˆ’ï¼š

   ```mysql
   mysql> explain select * from company2 where name like '%3'\G; 
              id: 1
     select_type: SIMPLE 
           table: company2 
            type: ALL 
   possible_keys: NULL
             key: NULL
         key_len: NULL 
             ref: NULL
            rows: 1000 
           Extra: Using  where 
   1 row in set (0.00 sec)
   
   mysql> explain select * from company2 where name like '3%'\G;  
   *************************** 1. row *************************** 
              id: 1
     select_type: SIMPLE 
           table: company2 
            type: range
   possible_keys: ind_company2_name 
             key: ind_company2_name 
         key_len: 11
             ref: NULL
            rows: 103
           Extra: Using where 
    1 row in set (0.00 sec) 
   1234567891011121314151617181920212223242526
   ```

   å¯ä»¥å‘ç°ç¬¬ä¸€ä¸ªä¾‹å­æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œè€Œç¬¬äºŒä¾‹å­å°±èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•ï¼ŒåŒºåˆ«å°±åœ¨äºâ€œ`%`â€çš„ä½ç½® ä¸åŒï¼Œå‰è€…æŠŠâ€œ`%`â€æ”¾åˆ°ç¬¬ä¸€ä½å°±ä¸èƒ½ç”¨åˆ°ç´¢å¼•ï¼Œè€Œåè€…æ²¡æœ‰æ”¾åˆ°ç¬¬ä¸€ä½å°±ä½¿ç”¨äº†ç´¢å¼•ã€‚

   å¦å¤–ï¼Œå¦‚æœå¦‚æœ `like` åé¢è·Ÿçš„æ˜¯ä¸€ä¸ªåˆ—çš„åå­—ï¼Œé‚£ä¹ˆç´¢å¼•ä¹Ÿä¸ä¼šè¢«ä½¿ç”¨ã€‚

3. å¦‚æœå¯¹å¤§çš„æ–‡æœ¬è¿›è¡Œæœç´¢ï¼Œä½¿ç”¨å…¨æ–‡ç´¢å¼•è€Œä¸ç”¨ä½¿ç”¨ `like â€˜%...%â€™`ã€‚

4. å¦‚æœåˆ—åæ˜¯ç´¢å¼•ï¼Œä½¿ç”¨ `column_name is null` å°†ä½¿ç”¨ç´¢å¼•ã€‚å¦‚ä¸‹ä¾‹ä¸­æŸ¥è¯¢ `name` ä¸º `null` çš„è®°å½•å°±ç”¨åˆ°äº†ç´¢å¼•:

   ```mysql
   mysql> explain select * from company2 where name is null\G; 
   *************************** 1. row *************************** 
   	       id: 1
     select_type: SIMPLE 
           table: company2 
            type: ref
   possible_keys: ind_company2_name 
             key: ind_company2_name 
         key_len: 11
             ref: const
            rows: 1
           Extra: Using where 
    1 row in set (0.00 sec) 
   12345678910111213
   ```

### 2.2 å­˜åœ¨ç´¢å¼•ä½†ä¸ä½¿ç”¨ç´¢å¼•

åœ¨ä¸‹åˆ—æƒ…å†µä¸‹ï¼Œè™½ç„¶å­˜åœ¨ç´¢å¼•ï¼Œä½†æ˜¯ `MySQL` å¹¶ä¸ä¼šä½¿ç”¨ç›¸åº”çš„ç´¢å¼•ã€‚

1. å¦‚æœ `MySQL` ä¼°è®¡ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ‰«ææ›´æ…¢ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•ã€‚ä¾‹å¦‚å¦‚æœåˆ— `key_part1` å‡åŒ€åˆ†å¸ƒåœ¨ `1` å’Œ `100` ä¹‹é—´ï¼Œä¸‹åˆ—æŸ¥è¯¢ä¸­ä½¿ç”¨ç´¢å¼•å°±ä¸æ˜¯å¾ˆå¥½ï¼š

   ```mysql
   SELECT * FROM table_name where key_part1 > 1 and key_part1 < 90; 
   1
   ```

2. å¦‚æœä½¿ç”¨ `MEMORY/HEAP` è¡¨å¹¶ä¸” `where` æ¡ä»¶ä¸­ä¸ä½¿ç”¨â€œ`=`â€è¿›è¡Œç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆä¸ä¼šç”¨åˆ°ç´¢å¼•ã€‚`heap` è¡¨åªæœ‰åœ¨â€œ`=`â€çš„æ¡ä»¶ä¸‹æ‰ä¼šä½¿ç”¨ç´¢å¼•ã€‚

3. ç”¨`or`åˆ†å‰²å¼€çš„æ¡ä»¶ï¼Œ å¦‚æœ`or`å‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•ï¼Œ è€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•ï¼Œ é‚£ä¹ˆæ¶‰åŠåˆ°çš„ç´¢å¼•éƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼Œä¾‹å¦‚ï¼š

   ```mysql
   mysql> show index from sales\G; 
   *************************** 1. row *************************** 
          Table: sales 
     Non_unique: 1 
       Key_name: ind_sales_year 
   Seq_in_index: 1 
    Column_name: year
      Collation: A 
    Cardinality: NULL 
       Sub_part: NULL 
         Packed: NULL 
           Null:  
     Index_type: BTREE 
        Comment:  
   1 row in set (0.00 sec) 
   123456789101112131415
   ```

   ä»ä¸Šé¢å¯ä»¥å‘ç°åªæœ‰`year` åˆ—ä¸Šé¢æœ‰ç´¢å¼•ï¼Œæ¥çœ‹å¦‚ä¸‹çš„æ‰§è¡Œè®¡åˆ’ï¼š

   ```mysql
   mysql> explain select * from sales where year = 2001 or country = 'China'\G; 
   *************************** 1. row *************************** 
   		   id: 1
     select_type: SIMPLE 
           table: sales 
            type: ALL
   possible_keys: ind_sales_year 
             key: NULL 
         key_len: NULL
             ref: NULL
            rows: 12
           Extra: Using where 
    1 row in set (0.00 sec) 
   12345678910111213
   ```

   å¯è§è™½ç„¶åœ¨`year`è¿™ä¸ªåˆ—ä¸Šå­˜åœ¨ç´¢å¼•`ind_sales_year`ï¼Œ ä½†æ˜¯è¿™ä¸ª`SQL`è¯­å¥å¹¶æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªç´¢å¼•ï¼Œ åŸå› å°±æ˜¯ `or` ä¸­æœ‰ä¸€ä¸ªæ¡ä»¶ä¸­çš„åˆ—æ²¡æœ‰ç´¢å¼•ã€‚

4. å¦‚æœä¸æ˜¯ç´¢å¼•åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¦‚ä¸‹ä¾‹å­:

   ```mysql
   mysql> explain select * from sales2 where moneys = 1\G; 
   *************************** 1. row *************************** 
   		   id: 1
     select_type: SIMPLE 
           table: sales2 
            type: ALL
   possible_keys: NULL 
             key: NULL 
         key_len: NULL
             ref: NULL
            rows: 1000
           Extra: Using where 
    1 row in set (0.00 sec) 	
   12345678910111213
   ```

   å¯è§è™½ç„¶åœ¨ `money` ä¸Šé¢å»ºæœ‰å¤åˆç´¢å¼•ï¼Œä½†æ˜¯ç”±äº `money` ä¸æ˜¯ç´¢å¼•çš„ç¬¬ä¸€åˆ—ï¼Œé‚£ä¹ˆåœ¨æŸ¥è¯¢ä¸­è¿™ä¸ªç´¢å¼•ä¹Ÿä¸ä¼šè¢« `MySQL` é‡‡ç”¨ã€‚

5. å¦‚æœ `like` æ˜¯ä»¥`ï¼…`å¼€å§‹ï¼Œä¾‹å¦‚ï¼š

   ```mysql
   mysql> explain select * from company2 where name like '%3'\G; 
   *************************** 1. row *************************** 
   		   id: 1
     select_type: SIMPLE 
           table: company2 
            type: ALL
   possible_keys: NULL 
             key: NULL 
         key_len: NULL
             ref: NULL
            rows: 1000
           Extra: Using where 
    1 row in set (0.00 sec) 		
   12345678910111213
   ```

   å¯è§è™½ç„¶åœ¨ `name` ä¸Šå»ºæœ‰ç´¢å¼•ï¼Œä½†æ˜¯ç”±äº `where` æ¡ä»¶ä¸­ `like` çš„å€¼çš„â€œ`%`â€åœ¨ç¬¬ä¸€ä½äº†ï¼Œé‚£ä¹ˆ `MySQL` ä¹Ÿä¸ä¼šé‡‡ç”¨è¿™ä¸ªç´¢å¼•ã€‚

6. å¦‚æœåˆ—ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¸€å®šè®°å¾—åœ¨ `where` æ¡ä»¶ä¸­æŠŠå­—ç¬¦å¸¸é‡å€¼ç”¨å¼•å·å¼•èµ·æ¥ï¼Œå¦åˆ™çš„è¯å³ä¾¿è¿™ä¸ªåˆ—ä¸Šæœ‰ç´¢å¼•ï¼Œ`MySQL` ä¹Ÿä¸ä¼šç”¨åˆ°çš„ï¼Œå› ä¸ºï¼Œ`MySQL` é»˜è®¤æŠŠè¾“å…¥çš„å¸¸é‡å€¼è¿›è¡Œè½¬æ¢ä»¥åæ‰è¿›è¡Œæ£€ç´¢ã€‚ å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­`company2`è¡¨ä¸­çš„`name`å­—æ®µæ˜¯å­—ç¬¦å‹çš„ï¼Œ ä½†æ˜¯ `SQL` è¯­å¥ä¸­çš„æ¡ä»¶å€¼ `294` æ˜¯ä¸€ä¸ªæ•°å€¼å‹å€¼ï¼Œå› æ­¤å³ä¾¿åœ¨ `name` ä¸Šæœ‰ç´¢å¼•ï¼Œ `MySQL` ä¹Ÿä¸èƒ½ æ­£ç¡®åœ°ç”¨ä¸Šç´¢å¼•ï¼Œè€Œæ˜¯ç»§ç»­è¿›è¡Œå…¨è¡¨æ‰«æã€‚

   ```mysql
   mysql> explain select * from company2 where name = 294\G; 
   *************************** 1. row *************************** 
   		   id: 1
     select_type: SIMPLE 
           table: company2 
            type: ALL
   possible_keys: ind_company2_name 
             key: NULL 
         key_len: NULL
             ref: NULL
            rows: 1000
           Extra: Using where 
   1 row in set (0.00 sec) 
   
   mysql> explain select * from company2 where name = '294'\G; 
   *************************** 1. row *************************** 
   		   id: 1
     select_type: SIMPLE 
           table: company2 
            type: ref
   possible_keys: ind_company2_name 
             key: ind_company2_name 
         key_len: 23
             ref: const
            rows: 1
           Extra: Using where 
   1 row in set (0.00 sec) 
   123456789101112131415161718192021222324252627
   ```

   ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ª `SQL` è¯­å¥ä¸­æŠŠä¸€ä¸ªæ•°å€¼å‹å¸¸é‡èµ‹å€¼ç»™äº†ä¸€ä¸ªå­—ç¬¦å‹çš„åˆ— `name`ï¼Œé‚£ä¹ˆè™½ç„¶åœ¨ `name` åˆ—ä¸Šæœ‰ç´¢å¼•ï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰ç”¨åˆ°ï¼›è€Œç¬¬äºŒä¸ª `SQL` è¯­å¥å°±å¯ä»¥æ­£ç¡®ä½¿ç”¨ç´¢å¼•ã€‚

### 3. æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ

å¦‚æœç´¢å¼•æ­£åœ¨å·¥ä½œï¼Œ`Handler_read_key` çš„å€¼å°†å¾ˆé«˜ï¼Œè¿™ä¸ªå€¼ä»£è¡¨äº†ä¸€ä¸ªè¡Œè¢«ç´¢å¼•å€¼è¯»çš„æ¬¡æ•°ï¼Œå¾ˆä½çš„å€¼è¡¨æ˜å¢åŠ ç´¢å¼•å¾—åˆ°çš„æ€§èƒ½æ”¹å–„ä¸é«˜ï¼Œå› ä¸ºç´¢å¼•å¹¶ä¸ç»å¸¸ä½¿ç”¨ã€‚

`Handler_read_rnd_next` çš„å€¼é«˜åˆ™æ„å‘³ç€æŸ¥è¯¢è¿è¡Œä½æ•ˆï¼Œå¹¶ä¸”åº”è¯¥å»ºç«‹ç´¢å¼•è¡¥æ•‘ã€‚è¿™ä¸ªå€¼çš„å«ä¹‰æ˜¯åœ¨æ•°æ®æ–‡ä»¶ä¸­è¯»ä¸‹ä¸€è¡Œçš„è¯·æ±‚æ•°ã€‚å¦‚æœæ­£è¿›è¡Œå¤§é‡çš„è¡¨æ‰«æï¼Œ `Handler_read_rnd_next` çš„å€¼è¾ƒé«˜ï¼Œ åˆ™é€šå¸¸è¯´æ˜è¡¨ç´¢å¼•ä¸æ­£ç¡®æˆ–å†™å…¥çš„æŸ¥è¯¢æ²¡æœ‰åˆ©ç”¨ç´¢å¼•ï¼Œ å…·ä½“å¦‚ä¸‹ã€‚

```mysql
mysql> show status like 'Handler_read%'; 
+-----------------------+-------+ 
| Variable_name         | Value | 
+-----------------------+-------+ 
| Handler_read_first    | 0     | 
| Handler_read_key      | 5     | 
| Handler_read_next     | 0     | 
| Handler_read_prev     | 0     | 
| Handler_read_rnd      | 0     | 
| Handler_read_rnd_next | 2055  | 
+-----------------------+-------+ 
6 rows in set (0.00 sec) 
123456789101112
```

ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œç›®å‰ä½¿ç”¨çš„ `MySQL` æ•°æ®åº“çš„ç´¢å¼•æƒ…å†µå¹¶ä¸ç†æƒ³ã€‚

## 3.ç®€å•ä¼˜åŒ–æ–¹æ³•

### 1. å®šæœŸåˆ†æè¡¨å’Œæ£€æŸ¥è¡¨

åˆ†æè¡¨çš„è¯­æ³•å¦‚ä¸‹ï¼š

```mysql
ANALYZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name] ...  
```

æœ¬è¯­å¥ç”¨äºåˆ†æå’Œå­˜å‚¨è¡¨çš„å…³é”®å­—åˆ†å¸ƒï¼Œåˆ†æçš„ç»“æœå°†å¯ä»¥ä½¿å¾—ç³»ç»Ÿå¾—åˆ°å‡†ç¡®çš„ç»Ÿè®¡ä¿¡ æ¯ï¼Œä½¿å¾— `SQL` èƒ½å¤Ÿç”Ÿæˆæ­£ç¡®çš„æ‰§è¡Œè®¡åˆ’ã€‚å¦‚æœç”¨æˆ·æ„Ÿè§‰å®é™…æ‰§è¡Œè®¡åˆ’å¹¶ä¸æ˜¯é¢„æœŸçš„æ‰§è¡Œè®¡ åˆ’ï¼Œæ‰§è¡Œä¸€æ¬¡åˆ†æè¡¨å¯èƒ½ä¼šè§£å†³é—®é¢˜ã€‚åœ¨åˆ†ææœŸé—´ï¼Œä½¿ç”¨ä¸€ä¸ªè¯»å–é”å®šå¯¹è¡¨è¿›è¡Œé”å®šã€‚è¿™å¯¹ äº `MyISAM`, `BDB` å’Œ `InnoDB` è¡¨æœ‰ä½œç”¨ã€‚å¯¹äº `MyISAM` è¡¨ï¼Œæœ¬è¯­å¥ä¸ä½¿ç”¨ `myisamchk -a` ç›¸å½“ï¼Œä¸‹ä¾‹ä¸­å¯¹è¡¨ `sales` åšäº†è¡¨åˆ†æï¼š

```mysql
mysql> analyze table sales; 
+--------------+---------+----------+----------+ 
| Table        | Op      | Msg_type | Msg_text | 
+--------------+---------+----------+----------+ 
| sakila.sales | analyze | status   | OK       | 
+--------------+---------+----------+----------+ 
1 row in set (0.00 sec) 
1234567
```

æ£€æŸ¥è¡¨çš„è¯­æ³•å¦‚ä¸‹ï¼š

```mysql
CHECK TABLE tbl_name [, tbl_name] ... [option] ... option = {QUICK | FAST | MEDIUM | EXTENDED | CHANGED}  
1
```

æ£€æŸ¥è¡¨çš„ä½œç”¨æ˜¯æ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨æ˜¯å¦æœ‰é”™è¯¯ã€‚ `CHECK TABLE`å¯¹`MyISAM`å’Œ`InnoDB`è¡¨æœ‰ä½œç”¨ã€‚ å¯¹äº `MyISAM` è¡¨ï¼Œå…³é”®å­—ç»Ÿè®¡æ•°æ®è¢«æ›´æ–°ï¼Œä¾‹å¦‚ï¼š

```mysql
mysql> check table sales; 
+--------------+-------+----------+----------+ 
| Table        | Op    | Msg_type | Msg_text | 
+--------------+-------+----------+----------+ 
| sakila.sales | check | status   | OK       | 
+--------------+-------+----------+----------+ 
1 row in set (0.00 sec) 
1234567
```

`CHECK TABLE` ä¹Ÿå¯ä»¥æ£€æŸ¥è§†å›¾æ˜¯å¦æœ‰é”™è¯¯ï¼Œæ¯”å¦‚åœ¨è§†å›¾å®šä¹‰ä¸­è¢«å¼•ç”¨çš„è¡¨å·²ä¸å­˜åœ¨ï¼Œä¸¾ä¾‹å¦‚ä¸‹ã€‚

1. é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè§†å›¾ã€‚

   ```mysql
   mysql> create view sales_view3 as select *  from sales3; 
   Query OK, 0 rows affected (0.00 sec) 
   12
   ```

2. ç„¶å `CHECK` ä¸€ä¸‹è¯¥è§†å›¾ï¼Œå‘ç°æ²¡æœ‰é—®é¢˜ã€‚

   ```mysql
   mysql> check table sales_view3; 
   +--------------------+-------+----------+----------+ 
   | Table              | Op    | Msg_type | Msg_text | 
   +--------------------+-------+----------+----------+ 
   | sakila.sales_view3 | check | status   | OK       | 
   +--------------------+-------+----------+----------+ 
   1 row in set (0.00 sec) 
   1234567
   ```

3. ç°åœ¨åˆ é™¤æ‰è§†å›¾ä¾èµ–çš„è¡¨ã€‚

   ```mysql
   mysql> drop table sales3; 
   Query OK, 0 rows affected (0.00 sec) 
   12
   ```

4. å†æ¥ `CHECK` ä¸€ä¸‹åˆšæ‰çš„è§†å›¾ï¼Œå‘ç°æŠ¥é”™äº†ã€‚

   ```mysql
   mysql> check table sales_view3\G; 
   *************************** 1. row *************************** 
      Table: sakila.sales_view3 
         Op: check 
   Msg_type: error 
   Msg_text: View 'sakila.sales_view3' references invalid table(s) or column(s) or function(s) or definer/invoker of view lack rights to use them 
   1 row in set (0.00 sec) 
   1234567
   ```

### 2. å®šæœŸä¼˜åŒ–è¡¨

ä¼˜åŒ–è¡¨çš„è¯­æ³•å¦‚ä¸‹ï¼š

```mysql
OPTIMIZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name] ... 
1
```

å¦‚æœå·²ç»åˆ é™¤äº†è¡¨çš„ä¸€å¤§éƒ¨åˆ†ï¼Œæˆ–è€…å¦‚æœå·²ç»å¯¹å«æœ‰å¯å˜é•¿åº¦è¡Œçš„è¡¨ï¼ˆå«æœ‰ `VARCHAR`ã€ `BLOB` æˆ– `TEXT` åˆ—çš„è¡¨ï¼‰è¿›è¡Œäº†å¾ˆå¤šæ›´æ”¹ï¼Œåˆ™åº”ä½¿ç”¨ `OPTIMIZE TABLE` å‘½ä»¤æ¥è¿›è¡Œè¡¨ä¼˜åŒ–ã€‚è¿™ä¸ª å‘½ä»¤å¯ä»¥å°†è¡¨ä¸­çš„ç©ºé—´ç¢ç‰‡è¿›è¡Œåˆå¹¶ï¼Œ å¹¶ä¸”å¯ä»¥æ¶ˆé™¤ç”±äºåˆ é™¤æˆ–è€…æ›´æ–°é€ æˆçš„ç©ºé—´æµªè´¹ï¼Œ ä½† `OPTIMIZE TABLE` å‘½ä»¤åªå¯¹ `MyISAM`ã€`BDB` å’Œ `InnoDB` è¡¨èµ·ä½œç”¨ã€‚

ä»¥ä¸‹ä¾‹å­æ˜¾ç¤ºäº†ä¼˜åŒ–è¡¨ `sales` çš„è¿‡ç¨‹ï¼š

```mysql
mysql> optimize table sales; 
+--------------+----------+----------+----------+ 
| Table        | Op       | Msg_type | Msg_text | 
+--------------+----------+----------+----------+ 
| sakila.sales | optimize | status   | OK       | 
+--------------+----------+----------+----------+ 
1 row in set (0.00 sec) 
```

## 4.å¸¸ç”¨Sqlä¼˜åŒ–

### 1. å¤§æ‰¹é‡æ’å…¥æ•°æ®

å½“ç”¨ `load` å‘½ä»¤å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œé€‚å½“çš„è®¾ç½®å¯ä»¥æé«˜å¯¼å…¥çš„é€Ÿåº¦ã€‚

å¯¹äº `MyISAM` å­˜å‚¨å¼•æ“çš„è¡¨ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¿«é€Ÿçš„å¯¼å…¥å¤§é‡çš„æ•°æ®ã€‚

```mysql
ALTER TABLE tbl_name DISABLE KEYS; 
loading the data 
ALTER TABLE tbl_name ENABLE KEYS; 
123
```

`DISABLE KEYS` å’Œ `ENABLE KEYS` ç”¨æ¥æ‰“å¼€æˆ–è€…å…³é—­ `MyISAM` è¡¨éå”¯ä¸€ç´¢å¼•çš„æ›´æ–°ã€‚åœ¨å¯¼å…¥å¤§é‡çš„æ•°æ®åˆ°ä¸€ä¸ªéç©ºçš„ `MyISAM` è¡¨æ—¶ï¼Œé€šè¿‡è®¾ç½®è¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚å¯¹äºå¯¼å…¥å¤§é‡æ•°æ®åˆ°ä¸€ä¸ªç©ºçš„ `MyISAM` è¡¨ï¼Œé»˜è®¤å°±æ˜¯å…ˆå¯¼å…¥æ•°æ®ç„¶åæ‰åˆ›å»ºç´¢å¼•çš„ï¼Œæ‰€ä»¥ä¸ç”¨è¿›è¡Œè®¾ç½®ã€‚

ä¸Šé¢æ˜¯å¯¹`MyISAM`è¡¨è¿›è¡Œæ•°æ®å¯¼å…¥æ—¶çš„ä¼˜åŒ–æªæ–½ï¼Œå¯¹äº`InnoDB`ç±»å‹çš„è¡¨ï¼Œè¿™ç§æ–¹å¼å¹¶ä¸èƒ½æé«˜å¯¼å…¥æ•°æ®çš„æ•ˆç‡ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼æé«˜`InnoDB`è¡¨çš„å¯¼å…¥æ•ˆç‡ã€‚

1. å› ä¸º `InnoDB`ç±»å‹çš„è¡¨æ˜¯æŒ‰ç…§ä¸»é”®çš„é¡ºåºä¿å­˜çš„ï¼Œæ‰€ä»¥å°†å¯¼å…¥çš„æ•°æ®æŒ‰ç…§**ä¸»é”®çš„é¡ºåº**æ’åˆ—ï¼Œå¯ä»¥æœ‰æ•ˆåœ°æé«˜å¯¼å…¥æ•°æ®çš„æ•ˆç‡ã€‚

   ä¾‹å¦‚ï¼Œä¸‹é¢æ–‡æœ¬`film_test3.txt`æ˜¯æŒ‰è¡¨`film_test4`çš„ä¸»é”®å­˜å‚¨çš„ï¼Œé‚£ä¹ˆå¯¼å…¥çš„æ—¶å€™å…±è€—æ—¶ `27.92`ç§’ã€‚

   ```mysql
   mysql> load data infile '/home/mysql/film_test3.txt' into table film_test4; 
   Query OK, 1587168 rows affected (22.92 sec) 
   Records: 1587168  Deleted: 0  Skipped: 0  Warnings: 0 
   123
   ```

   è€Œä¸‹é¢çš„ `film_test4.txt` æ˜¯æ²¡æœ‰ä»»ä½•é¡ºåºçš„æ–‡æœ¬ï¼Œé‚£ä¹ˆå¯¼å…¥çš„æ—¶å€™å…±è€—æ—¶ `31.16`ç§’ã€‚

   ```mysql
   mysql> load data infile '/home/mysql/film_test4.txt' into table film_test4; 
   Query OK, 1587168 rows affected (31.16 sec) 
   Records: 1587168  Deleted: 0  Skipped: 0  Warnings: 0 
   123
   ```

2. åœ¨å¯¼å…¥æ•°æ®å‰æ‰§è¡Œ `SET UNIQUE_CHECKS=0`ï¼Œå…³é—­å”¯ä¸€æ€§æ ¡éªŒï¼Œåœ¨å¯¼å…¥ç»“æŸåæ‰§è¡Œ `SET UNIQUE_CHECKS=1`ï¼Œæ¢å¤å”¯ä¸€æ€§æ ¡éªŒï¼Œå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚çœå¾—æ’å…¥çš„æ—¶å€™å¯¹æ¯”æ˜¯å¦å­—æ®µå”¯ä¸€

   ä¾‹å¦‚ï¼Œå½“ `UNIQUE_CHECKS=1`æ—¶ï¼š

   ```mysql
   mysql> load data infile '/home/mysql/film_test3.txt' into table film_test4; 
   Query OK, 1587168 rows affected (22.92 sec) 
   Records: 1587168  Deleted: 0  Skipped: 0  Warnings: 0 
   123
   ```

   å½“ `SET UNIQUE_CHECKS=0`æ—¶ï¼š

   ```mysql
   mysql> load data infile '/home/mysql/film_test3.txt' into table film_test4; 
   Query OK, 1587168 rows affected (19.92 sec) 
   Records: 1587168  Deleted: 0  Skipped: 0  Warnings: 0 
   123
   ```

3. å¦‚æœåº”ç”¨ä½¿ç”¨è‡ªåŠ¨æäº¤çš„æ–¹å¼ï¼Œå»ºè®®åœ¨å¯¼å…¥å‰æ‰§è¡Œ `SET AUTOCOMMIT=0`ï¼Œå…³é—­è‡ªåŠ¨æäº¤ï¼Œå¯¼å…¥ç»“æŸåå†æ‰§è¡Œ `SET AUTOCOMMIT=1`ï¼Œæ‰“å¼€è‡ªåŠ¨æäº¤ï¼Œä¹Ÿå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚

   ä¾‹å¦‚ï¼Œå½“ `AUTOCOMMIT=1`æ—¶ï¼š

   ```mysql
   mysql> load data infile '/home/mysql/film_test3.txt' into table film_test4; 
   Query OK, 1587168 rows affected (22.92 sec) 
   Records: 1587168  Deleted: 0  Skipped: 0  Warnings: 0 
   123
   ```

   å½“ `AUTOCOMMIT=0`æ—¶ï¼š

   ```mysql
   mysql> load data infile '/home/mysql/film_test3.txt' into table film_test4; 
   Query OK, 1587168 rows affected (20.87 sec) 
   Records: 1587168  Deleted: 0  Skipped: 0  Warnings: 0 
   123
   ```

### 2. ä¼˜åŒ– INSERT è¯­å¥

å½“è¿›è¡Œæ•°æ®`INSERT`çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ä»¥ä¸‹å‡ ç§ä¼˜åŒ–æ–¹å¼ã€‚

- å¦‚æœåŒæ—¶ä»åŒä¸€å®¢æˆ·æ’å…¥å¾ˆå¤šè¡Œï¼Œå°½é‡ä½¿ç”¨å¤šä¸ªå€¼è¡¨çš„`INSERT`è¯­å¥ï¼Œè¿™ç§æ–¹å¼å°†å¤§å¤§ç¼©å‡å®¢æˆ·ç«¯ä¸æ•°æ®åº“ä¹‹é—´çš„è¿æ¥ã€å…³é—­ç­‰æ¶ˆè€—ï¼Œä½¿å¾—æ•ˆç‡æ¯”åˆ†å¼€æ‰§è¡Œçš„å•ä¸ª`INSERT`è¯­ å¿«(åœ¨ä¸€äº›æƒ…å†µä¸­å‡ å€)ã€‚ä¸‹é¢æ˜¯ä¸€æ¬¡æ’å…¥å¤šå€¼çš„ä¸€ä¸ªä¾‹å­ï¼š

  ```mysql
  insert into test values(1,2),(1,3),(1,4)... 
  ```
  
- åœ¨äº‹åŠ¡ä¸­è¿›è¡Œæ•°æ®æ’å…¥

- æ•°æ®æœ‰åºæ’å…¥ï¼ŒæŒ‰ç…§ä¸»é”®é¡ºåº

- å¦‚æœä»ä¸åŒå®¢æˆ·æ’å…¥å¾ˆå¤šè¡Œï¼Œèƒ½é€šè¿‡ä½¿ç”¨`INSERT DELAYED`è¯­å¥å¾—åˆ°æ›´é«˜çš„é€Ÿåº¦ã€‚ `DELAYED`çš„å«ä¹‰æ˜¯è®©`INSERT`è¯­å¥é©¬ä¸Šæ‰§è¡Œï¼Œå…¶å®æ•°æ®éƒ½è¢«æ”¾åœ¨å†…å­˜çš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶æ²¡æœ‰çœŸæ­£å†™å…¥ç£ç›˜ï¼Œè¿™æ¯”æ¯æ¡è¯­å¥åˆ†åˆ«æ’å…¥è¦å¿«çš„å¤šï¼›`LOW_PRIORITY`åˆšå¥½ç›¸åï¼Œåœ¨æ‰€æœ‰å…¶ ä»–ç”¨æˆ·å¯¹è¡¨çš„è¯»å†™å®Œåæ‰è¿›è¡Œæ’å…¥

- å°†ç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶åˆ†åœ¨ä¸åŒçš„ç£ç›˜ä¸Šå­˜æ”¾ï¼ˆåˆ©ç”¨å»ºè¡¨ä¸­çš„é€‰é¡¹ï¼‰

- å¦‚æœè¿›è¡Œæ‰¹é‡æ’å…¥ï¼Œå¯ä»¥å¢åŠ `bulk_insert_buffer_size`å˜é‡å€¼çš„æ–¹æ³•æ¥æé«˜é€Ÿåº¦ï¼Œä½†æ˜¯ï¼Œ è¿™åªèƒ½å¯¹`MyISAM`è¡¨ä½¿ç”¨ï¼›

- å½“ä»ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶è£…è½½ä¸€ä¸ªè¡¨æ—¶ï¼Œä½¿ç”¨`LOAD DATA INFILE`ã€‚è¿™é€šå¸¸æ¯”ä½¿ç”¨å¾ˆå¤š`INSERT`è¯­å¥å¿«`20`å€ã€‚

### 3. ä¼˜åŒ– GROUP BY è¯­å¥

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`MySQL`å¯¹æ‰€æœ‰`GROUP BY col1ï¼Œcol2....`çš„å­—æ®µè¿›è¡Œæ’åºã€‚è¿™ä¸åœ¨æŸ¥è¯¢ä¸­æŒ‡å®š `ORDER BY col1ï¼Œcol2...`ç±»ä¼¼ã€‚å› æ­¤ï¼Œå¦‚æœæ˜¾å¼åŒ…æ‹¬ä¸€ä¸ªåŒ…å«ç›¸åŒçš„åˆ—çš„`ORDER BY`å­å¥ï¼Œåˆ™å¯¹`MySQL`çš„å®é™…æ‰§è¡Œæ€§èƒ½æ²¡æœ‰ä»€ä¹ˆå½±å“ã€‚

å¦‚æœæŸ¥è¯¢åŒ…æ‹¬`GROUP BY`ä½†ç”¨æˆ·æƒ³è¦é¿å…æ’åºç»“æœçš„æ¶ˆè€—ï¼Œåˆ™å¯ä»¥æŒ‡å®š`ORDER BY NULL` ç¦æ­¢æ’åºï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š

* using temperary

```mysql
mysql> explain select id,sum(moneys) from sales2 group by id\G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: ALL 
possible_keys: NULL 
          key: NULL 
      key_len: NULL 
          ref: NULL 
         rows: 1000 
        Extra: Using temporary; Using filesort 
1 row in set (0.00 sec) 

mysql> explain select id,sum(moneys) from sales2 group by id order by null\G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: ALL 
possible_keys: NULL 
          key: NULL 
      key_len: NULL 
          ref: NULL 
         rows: 1000 
        Extra: Using temporary; 
1 row in set (0.00 sec) 
123456789101112131415161718192021222324252627
```

ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºç¬¬ä¸€ä¸ª`SQL`è¯­å¥éœ€è¦è¿›è¡Œ â€œ`filesort`â€ ï¼Œ è€Œç¬¬äºŒä¸ª`SQL`ç”±äº`ORDER BY NULL` ä¸éœ€è¦è¿›è¡Œâ€œ`filesort`â€ ï¼Œè€Œ`filesort`å¾€å¾€éå¸¸è€—è´¹æ—¶é—´ã€‚

### 4. ä¼˜åŒ– ORDER BY è¯­å¥

åœ¨æŸäº›æƒ…å†µä¸­ï¼Œ `MySQL`å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥æ»¡è¶³`ORDER BY`å­å¥ï¼Œ è€Œä¸éœ€è¦é¢å¤–çš„æ’åºã€‚ `WHERE`æ¡ä»¶å’Œ`ORDER BY`ä½¿ç”¨ç›¸åŒçš„ç´¢å¼•ï¼Œå¹¶ä¸”`ORDER BY`çš„é¡ºåºå’Œç´¢å¼•é¡ºåºç›¸åŒï¼Œå¹¶ä¸” `ORDER BY`çš„å­—æ®µéƒ½æ˜¯å‡åºæˆ–è€…éƒ½æ˜¯é™åºã€‚

* é€šè¿‡è¿”å›æ•°æ®è¿›è¡Œæ’åºï¼Œfilesortæ’åºï¼Œä¸é€‚ç”¨ç´¢å¼•çš„æƒ…å†µä¸‹
* é€šè¿‡æœ‰åºç´¢å¼•é¡ºåºæ‰«æç›´æ¥è¿”å›æœ‰åºæ•°æ®ï¼Œusing indexï¼Œä¸éœ€è¦é¢å¤–æ’åºï¼Œæ•ˆç‡é«˜ã€‚è¿™ç§æƒ…å†µä¸‹è¿”å›çš„æ•°æ®è¦ä¸ºè¦†ç›–ç´¢å¼•é‡Œé¢çš„å­—æ®µæˆ–è€…ä¸»é”®ï¼Œå¦åˆ™è¦å›è¡¨è¿›è¡ŒæŸ¥è¯¢ï¼Œæ­¤æ—¶ä½¿ç”¨filesortæ’åº

ä¾‹å¦‚ï¼Œä¸‹åˆ—SQLå¯ä»¥ä½¿ç”¨ç´¢å¼•ã€‚

```mysql
SELECT * FROM t1 ORDER BY key_part1,key_part2,... ; 
SELECT * FROM t1 WHERE key_part1=1 ORDER BY key_part1 DESC, key_part2 DESC; 
SELECT * FROM t1 ORDER BY key_part1 DESC, key_part2 DESC; 
123
```

ä½†æ˜¯åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹åˆ™ä¸ä½¿ç”¨ç´¢å¼•ï¼š

```mysql
#åˆä½¿ç”¨å‡åºåˆä½¿ç”¨é™åºï¼Œåˆ™ä¼šå¯¼è‡´ä¸ä½¿ç”¨ç´¢å¼•
SELECT * FROM t1 ORDER BY key_part1 DESC, key_part2 ASCï¼›  
--order byçš„å­—æ®µæ··åˆASCå’ŒDESC 
SELECT * FROM t1 WHERE key2=constant ORDER BY key1ï¼›  
--ç”¨äºæŸ¥è¯¢è¡Œçš„å…³é”®å­—ä¸ORDER BYä¸­æ‰€ä½¿ç”¨çš„ä¸ç›¸åŒ 
SELECT * FROM t1 ORDER BY key1, key2ï¼›  
--å¯¹ä¸åŒçš„å…³é”®å­—ä½¿ç”¨ORDER BYï¼š 
123456
```

* ä¸¤æ¬¡æ‰«æç®—æ³•å’Œä¸€æ¬¡æ‰«æç®—æ³•ï¼ˆé»˜è®¤ï¼‰

### 5. ä¼˜åŒ–åµŒå¥—æŸ¥è¯¢

`MySQL 4.1`å¼€å§‹æ”¯æŒ`SQL`çš„å­æŸ¥è¯¢ã€‚è¿™ä¸ªæŠ€æœ¯å¯ä»¥ä½¿ç”¨`SELECT`è¯­å¥æ¥åˆ›å»ºä¸€ä¸ªå•åˆ—çš„æŸ¥è¯¢ç»“æœï¼Œç„¶åæŠŠè¿™ä¸ªç»“æœä½œä¸ºè¿‡æ»¤æ¡ä»¶ç”¨åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢ä¸­ã€‚ä½¿ç”¨å­æŸ¥è¯¢å¯ä»¥ä¸€æ¬¡æ€§åœ°å®Œæˆå¾ˆ å¤šé€»è¾‘ä¸Šéœ€è¦å¤šä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆçš„SQLæ“ä½œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…äº‹åŠ¡æˆ–è€…è¡¨é”æ­»ï¼Œå¹¶ä¸”å†™èµ· æ¥ä¹Ÿå¾ˆå®¹æ˜“ã€‚ä½†æ˜¯ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œå­æŸ¥è¯¢å¯ä»¥è¢«æ›´æœ‰æ•ˆç‡çš„è¿æ¥ï¼ˆ`JOIN`ï¼‰æ›¿ä»£ã€‚

* ä½¿ç”¨å­æŸ¥è¯¢éœ€è¦åœ¨å†…å­˜ä¸­ åˆ›å»ºä¸´æ—¶è¡¨ï¼Œæ€§èƒ½è¾ƒä½ã€‚åŒæ—¶é€šè¿‡inä¸ºä¸€æ¡ä¸€æ¡åˆ¤æ–­ï¼Œä¸ºindexç´¢å¼•ã€‚æ€§èƒ½ä½
* æ¨èå¤šè¡¨è”æŸ¥æ›¿æ¢å­æŸ¥è¯¢ï¼Œtypeä¸ºref

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ è¦ä»`sales2`è¡¨ä¸­æ‰¾åˆ°é‚£äº›åœ¨`company2`è¡¨ä¸­ä¸å­˜åœ¨çš„æ‰€æœ‰å…¬å¸çš„ä¿¡æ¯ï¼š

```mysql
mysql> explain select * from sales2 where company_id not in ( select id from company2 )\G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: PRIMARY 
        table: sales2 
         type: ALL 
possible_keys: NULL 
          key: NULL 
      key_len: NULL 
          ref: NULL 
         rows: 1000 
        Extra: Using where
*************************** 2. row *************************** 
           id: 2
  select_type: DEPENDENT SUBQUERY  
        table: company2 
         type: index_subquery 
possible_keys: ind_company2_id 
          key: ind_company2_id 
      key_len: 5
          ref: func 
         rows: 2 
        Extra: Using index
2 rows in set (0.00 sec) 
123456789101112131415161718192021222324
```

å¦‚æœä½¿ç”¨è¿æ¥ï¼ˆ`JOIN`ï¼‰æ¥å®Œæˆè¿™ä¸ªæŸ¥è¯¢å·¥ä½œï¼Œé€Ÿåº¦å°†ä¼šå¿«å¾ˆå¤šã€‚å°¤å…¶æ˜¯å½“`company2`è¡¨ä¸­å¯¹idå»ºæœ‰ç´¢å¼•çš„è¯ï¼Œæ€§èƒ½å°†ä¼šæ›´å¥½ï¼Œå…·ä½“æŸ¥è¯¢å¦‚ä¸‹ï¼š

```mysql
mysql> explain select * from sales2 left join company2 on sales2.company_id = company2.id where sales2.company_id is null\G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: ref 
possible_keys: ind_sales2_companyid_moneys 
          key: ind_sales2_companyid_moneys 
      key_len: 5 
          ref: const 
         rows: 1 
        Extra: Using where
*************************** 2. row *************************** 
           id: 1
  select_type: SIMPLE
        table: ref
         type: index_subquery 
possible_keys: ind_company2_id 
          key: ind_company2_id 
      key_len: 5
          ref: sakila.sales2.company_id 
         rows: 2 
        Extra:
2 rows in set (0.00 sec) 
123456789101112131415161718192021222324
```

ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡ºæŸ¥è¯¢æ‰«æçš„è®°å½•èŒƒå›´å’Œä½¿ç”¨ç´¢å¼•çš„æƒ…å†µéƒ½æœ‰äº†å¾ˆå¤§çš„æ”¹å–„ã€‚ è¿æ¥ï¼ˆ`JOIN`ï¼‰ä¹‹æ‰€ä»¥æ›´æœ‰æ•ˆç‡ä¸€äº›ï¼Œæ˜¯å› ä¸º`MySQL` ä¸éœ€è¦åœ¨å†…å­˜ä¸­åˆ›å»ºä¸´æ—¶è¡¨æ¥å®Œæˆè¿™ä¸ªé€»è¾‘ä¸Šçš„éœ€è¦ä¸¤ä¸ªæ­¥éª¤çš„æŸ¥è¯¢å·¥ä½œã€‚

### 6.  ä¼˜åŒ– OR æ¡ä»¶

å¯¹äºå«æœ‰ `OR` çš„æŸ¥è¯¢å­å¥ï¼Œ å¦‚æœè¦åˆ©ç”¨ç´¢å¼•ï¼Œ åˆ™ `OR` ä¹‹é—´çš„æ¯ä¸ªæ¡ä»¶åˆ—éƒ½å¿…é¡»ç”¨åˆ°ç´¢å¼•ï¼› å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œåˆ™åº”è¯¥è€ƒè™‘å¢åŠ ç´¢å¼•ã€‚orä¸ä¼šä½¿ç”¨å¤åˆç´¢å¼•ã€‚æ¨èunionæ›¿æ¢orã€‚

```
select * from where id = 1 union select * from where id = 10;
```

### 7.ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢

```
select * from tb limit 1000,10;æŸ¥è¯¢ä»1000è¡Œå¼€å§‹çš„åæ¡æ•°æ®ï¼Œæ­¤æ—¶mysqléœ€è¦æ’åºå‰1010æ¡æ•°æ®ï¼Œä»…ä»…è¿”å›1000-1010æ¡è®°å½•ï¼Œå…¶ä»–è®°å½•ä¸¢å¼ƒï¼ŒæŸ¥è¯¢æ’åºçš„ä»£ä»·éå¸¸å¤§ã€‚èµ°å…¨è¡¨æ‰«æï¼Œä¸ä½¿ç”¨ç´¢å¼•
ä¼˜åŒ–æ€è·¯ä¸€ï¼šå®Œæˆæ’åºåˆ†é¡µåï¼Œæ ¹æ®ä¸»é”®å…³è”å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„å…¶ä»–åˆ—å†…å®¹
å³å…ˆæ ¹æ®ä¸»é”®åˆ†é¡µæŸ¥è¯¢ï¼Œç”¨åˆ°äº†ä¸»é”®ç´¢å¼•ï¼Œæ’å™æ•ˆç‡æ›´é«˜
select * from tb,(select * from tb order by id limit 1000,10) a where t.id=a.id
ä¼˜åŒ–æ€è·¯äºŒï¼šä»…é€‚ç”¨äºä¸»é”®è‡ªå¢çš„è¡¨ä¸”ä¸èƒ½å‡ºç°çŸ­å±‚ï¼Œå¯ä»¥æŠŠlimitæŸ¥è¯¢è½¬æ¢æˆæŸä¸ªä½ç½®çš„æŸ¥è¯¢
select * from tb where id>20000 limit 10;
```

### 8. ä½¿ç”¨ SQL æç¤º

`SQL` æç¤ºï¼ˆ`SQL HINT`ï¼‰æ˜¯ä¼˜åŒ–æ•°æ®åº“çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨ `SQL` è¯­å¥ä¸­åŠ å…¥ä¸€äº› äººä¸ºçš„æç¤ºæ¥è¾¾åˆ°ä¼˜åŒ–æ“ä½œçš„ç›®çš„ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `SQL` æç¤ºçš„ä¾‹å­ï¼š

```mysql
SELECT SQL_BUFFER_RESULTS * FROM... 
```

è¿™ä¸ªè¯­å¥å°†å¼ºåˆ¶ `MySQL` ç”Ÿæˆä¸€ä¸ªä¸´æ—¶ç»“æœé›†ã€‚åªè¦ä¸´æ—¶ç»“æœé›†ç”Ÿæˆåï¼Œæ‰€æœ‰è¡¨ä¸Šçš„é”å®šå‡è¢«é‡Šæ”¾ã€‚ è¿™èƒ½åœ¨é‡åˆ°è¡¨é”å®šé—®é¢˜æ—¶æˆ–è¦èŠ±å¾ˆé•¿æ—¶é—´å°†ç»“æœä¼ ç»™å®¢æˆ·ç«¯æ—¶æœ‰æ‰€å¸®åŠ©ï¼Œå› ä¸º å¯ä»¥å°½å¿«é‡Šæ”¾é”èµ„æºã€‚

ä¸‹é¢æ˜¯ä¸€äº›åœ¨ `MySQL` ä¸­å¸¸ç”¨çš„ `SQL` æç¤ºã€‚

#### 8.1 USE INDEX

åœ¨æŸ¥è¯¢è¯­å¥ä¸­è¡¨åçš„åé¢ï¼Œæ·»åŠ  `USE INDEX` æ¥æä¾›å¸Œæœ› `MySQL` å»å‚è€ƒçš„ç´¢å¼•åˆ—è¡¨ï¼Œå°±å¯ä»¥è®© `MySQL` ä¸å†è€ƒè™‘å…¶ä»–å¯ç”¨çš„ç´¢å¼•ã€‚

```mysql
mysql> explain select * from sales2 use index (ind_sales2_id) where id = 3\G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: ref
possible_keys: ind_sales2_id 
          key: ind_sales2_id 
      key_len: 5 
          ref: const 
         rows: 1
        Extra: Using where 
1 row in set (0.00 sec) 
12345678910111213
```

#### 8.2 IGNORE INDEX

å¦‚æœç”¨æˆ·åªæ˜¯å•çº¯åœ°æƒ³è®© `MySQL` å¿½ç•¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªç´¢å¼•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ `IGNORE INDEX` ä½œ ä¸º `HINT`ã€‚åŒæ ·æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œè¿™æ¬¡æ¥çœ‹ä¸€ä¸‹æŸ¥è¯¢è¿‡ç¨‹å¿½ç•¥ç´¢å¼• `ind_sales2_id`çš„æƒ…å†µï¼š

```mysql
mysql> explain select * from sales2 ignore index (ind_sales2_id) where id = 3\G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: ALL
possible_keys: NULL 
          key: NULL 
      key_len: NULL 
          ref: NULL 
         rows: 1000
        Extra: Using where 
1 row in set (0.00 sec) 
12345678910111213
```

ä»æ‰§è¡Œè®¡åˆ’å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿå¿½ç•¥äº†æŒ‡å®šçš„ç´¢å¼•ï¼Œè€Œä½¿ç”¨äº†å…¨è¡¨æ‰«æ

#### 8.3 FORCE INDEX

ä¸ºå¼ºåˆ¶ `MySQL` ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„ç´¢å¼•ï¼Œå¯åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ `FORCE INDEX` ä½œä¸º `HINT`ã€‚ä¾‹å¦‚ï¼Œ å½“ä¸å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œå› ä¸º `id` çš„å€¼éƒ½æ˜¯å¤§äº `0` çš„ï¼Œå› æ­¤ `MySQL` ä¼šé»˜è®¤è¿›è¡Œå…¨è¡¨æ‰«æï¼Œ è€Œä¸ä½¿ç”¨ç´¢å¼•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```mysql
mysql> explain select * from sales2 where id  > 0 \G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: ALL
possible_keys: ind_sales2_id 
          key: NULL 
      key_len: NULL 
          ref: NULL 
         rows: 1000
        Extra: Using where 
1 row in set (0.00 sec) 
12345678910111213
```

ä½†æ˜¯ï¼Œå½“ä½¿ç”¨`FORCE INDEX` è¿›è¡Œæç¤ºæ—¶ï¼Œå³ä¾¿ä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡ä¸æ˜¯æœ€é«˜ï¼Œ`MySQL` è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨äº†ç´¢å¼•ï¼Œè¿™æ˜¯ `MySQL` ç•™ç»™ç”¨æˆ·çš„ä¸€ä¸ªè‡ªè¡Œé€‰æ‹©æ‰§è¡Œè®¡åˆ’çš„æƒåŠ›ã€‚åŠ å…¥ `FORCE INDEX` æç¤ºåå†æ¬¡æ‰§è¡Œä¸Šé¢çš„ `SQL`ï¼š

```mysql
mysql> explain select * from sales2 force index (ind_sales2_id) where id > 0 \G; 
*************************** 1. row *************************** 
           id: 1 
  select_type: SIMPLE 
        table: sales2 
         type: range
possible_keys: ind_sales2_id 
          key: ind_sales2_id 
      key_len: 5 
          ref: NULL 
         rows: 1000
        Extra: Using where 
1 row in set (0.00 sec) 
```

### 9.æ¨¡ç³ŠæŸ¥è¯¢ä¼˜åŒ–

â€‹	æœ‰æ—¶å€™æˆ‘ä»¬ä½¿ç”¨æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆlikeï¼‰çš„æ—¶å€™ï¼Œä¼šå‡ºç°ç´¢å¼•å¤±æ•ˆçš„æƒ…å†µï¼Œæ¯”å¦‚æ ¹æ®æ‰‹æœºå·ç åå››ä½æ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢ã€‚åœ¨MySQLä¸­æ¨¡ç³ŠæŸ¥è¯¢ï¼šmobile like â€˜%8765â€™ï¼Œè¿™ç§æƒ…å†µæ˜¯ä¸èƒ½ä½¿ç”¨ mobile ä¸Šçš„ç´¢å¼•çš„ï¼Œé‚£ä¹ˆå¦‚æœéœ€è¦æ ¹æ®æ‰‹æœºå·ç åå››ä½è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ï¼Œå¯ä»¥ç”¨ä¸€ä¸‹æ–¹æ³•è¿›è¡Œæ”¹é€ ã€‚

â€‚â€‚â€‚â€‚æˆ‘ä»¬å¯ä»¥åŠ å…¥å†—ä½™åˆ—ï¼ˆMySQL5.7ä¹‹ååŠ å…¥äº†è™šæ‹Ÿåˆ—ï¼Œä½¿ç”¨è™šæ‹Ÿåˆ—æ›´åˆé€‚ï¼Œæ€è·¯ç›¸åŒï¼‰ï¼Œæ¯”å¦‚ mobile_reverseï¼Œå†…éƒ¨å­˜å‚¨ä¸º mobile çš„å€’å™æ–‡æœ¬ï¼Œå¦‚ mobile 17312345678ï¼ˆæ‰‹æœºå·ç ä¸ºè™šæ„ï¼‰ï¼Œé‚£ä¹ˆ mobile_reverse å­˜å‚¨ 87654321371ï¼Œä¸º mobile_reverse åˆ—å»ºç«‹ç´¢å¼•ï¼ŒæŸ¥è¯¢ä¸­ä½¿ç”¨è¯­å¥ mobile_reverse like reverse(â€™%5678â€™) å³å¯ã€‚

â€‚â€‚â€‚â€‚reverse æ˜¯ MySQL ä¸­çš„åè½¬å‡½æ•°ï¼Œè¿™æ¡è¯­å¥ç›¸å½“äº mobile_reverse like â€˜8765%â€™ ï¼Œè¿™ç§è¯­å¥æ˜¯å¯ä»¥ä½¿ç”¨ç´¢å¼•çš„ã€‚

â€‚â€‚â€‚â€‚mobile_reverse çš„æ›´æ–°å¯ä»¥ç”¨è§¦å‘å™¨è§£å†³ï¼Œä¸ºè¡¨æ–°å»º â€™æ–°å¢â€˜å’Œâ€™æ›´æ–°â€˜çš„è§¦å‘å™¨ï¼Œå†™å…¥ä»¥ä¸‹æ–‡æœ¬å³å¯ã€‚

```sql
set new.mobile_reverse = REVERSE(new.mobile);
```

æœªæ”¹é€ å‰æ¨¡ç³ŠæŸ¥è¯¢è¯­å¥ä¸ºï¼š

```sql
select * from xxx where mobile like '%5678';
```

æ”¹é€ åæŸ¥è¯¢è¯­å¥ä¸ºï¼š

```sql
select * from xxx where mobile_reverse like reverse('%5678');
```

æˆ–è€…

```sql
select * from xxx where mobile_reverse like '8765%';
```

æ”¹é€ åçš„æ¨¡ç³ŠåŒ¹é…å¯ä»¥ä½¿ç”¨ mobile_reverse å­—æ®µä¸Šçš„ç´¢å¼•ï¼ŒåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚

## 5.ç´¢å¼•å¤±æ•ˆ

> å¤åˆç´¢å¼•çš„åˆ›å»º

CREATE INDEX (è‡ªå®šä¹‰)ç´¢å¼•å ON æ•°æ®è¡¨(å­—æ®µ1nameï¼Œå­—æ®µ2statusï¼Œå­—æ®µ3addressã€‚ã€‚ã€‚);

* å…¨å€¼åŒ¹é…ï¼Œç´¢å¼•ä¸­æ‰€æœ‰åˆ—éƒ½æŒ‡å®šå…·ä½“å€¼ï¼Œä¾‹å¦‚å­—æ®µ2=xxï¼Œå­—æ®µ1=xx
* æœ€å·¦å‰ç¼€åŒ¹é…ï¼šå¦‚æœç´¢å¼•å¤šåˆ—ï¼ŒæŸ¥è¯¢ä»æœ€å·¦å‰åˆ—å¼€å§‹ï¼Œå¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚ä¾‹å¦‚åªæ ¹æ®å­—æ®µ1ï¼Œå­—æ®µ3æŸ¥è¯¢ï¼Œè·³è¿‡å­—æ®µ2ï¼Œåˆ™èµ°ç´¢å¼•åªæ ¹æ®å­—æ®µ1æŸ¥è¯¢ï¼Œå­—æ®µ3ä½¿ç”¨ä¸åˆ°ã€‚å…¶æ¬¡å¦‚æœæ ¹æ®å­—æ®µ2ï¼Œå­—æ®µ3æŸ¥è¯¢ï¼Œåˆ™æŸ¥è¯¢ä¸åˆ°ï¼Œä¸èµ°ç´¢å¼•ã€‚æ ¹æ®ç´¢å¼•é•¿åº¦å¯ä»¥çœ‹å‡ºç”¨äº†å“ªäº›ç´¢å¼•ã€‚

* èŒƒå›´æŸ¥è¯¢å³è¾¹çš„åˆ—ï¼Œå³è¾¹çš„åˆ—ä¸ä¼šä½¿ç”¨ç´¢å¼•ã€‚> <

* å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé¿å…select* ã€‚select* éœ€è¦å›è¡¨æŸ¥è¯¢ï¼Œè€Œä½¿ç”¨è¦†ç›–ç´¢å¼•é¿å…å›è¡¨æŸ¥è¯¢

  ```cmd
  explain ä¸­ extraä¿¡æ¯:
  	using index:ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡ºç°
  	usin whereï¼šåœ¨æŸ¥æ‰¾ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢æ‰€éœ€çš„æ•°æ®
  	using index conditionï¼šæŸ¥æ‰¾ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®
  	using indexï¼šusing where æŸ¥æ‰¾ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦çš„æ•°æ®éƒ½åœ¨ç´¢å¼•åˆ—ä¸­èƒ½æ‰¾åˆ°ï¼Œæ‰€ä»¥ä¸éœ€è¦å›æŸ¥è¯¢æ•°æ®
  ```

* å°½é‡ä½¿ç”¨ç¬¦åˆç´¢å¼•ï¼Œ å› ä¸ºä½¿ç”¨ä¸€ä¸ªå¤åˆç´¢å¼•ï¼Œç›¸å½“äºåˆ›å»ºå¤šä¸ªç´¢å¼•ï¼šå­—æ®µ1ï¼Œå­—æ®µ1+å­—æ®µ2ï¼Œå­—æ®µ1+å­—æ®µ2+å­—æ®µ...ã€‚å¦‚æœä½¿ç”¨å•åˆ—ç´¢å¼•ï¼ŒæŸ¥è¯¢å¤šä¸ªå­—æ®µï¼Œåªä¼šé€‰æ‹©å…¶ä¸­ä¸€ä¸ªæœ€ä¼˜çš„å­—æ®µä½¿ç”¨ï¼ˆè¾¨åˆ«åº¦æœ€é«˜çš„ï¼Œä¾‹å¦‚å”¯ä¸€ç´¢å¼•ï¼‰

> å…¶ä»–æƒ…å†µ

* ä¸è¦åœ¨ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè¿ç®—æ“ä½œï¼Œå¦åˆ™ç´¢å¼•å¤±æ•ˆ
* å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ï¼Œé€ æˆç´¢å¼•å¤±æ•ˆ

* orè¯­å¥å‰åæ²¡æœ‰åŒæ—¶ä½¿ç”¨ç´¢å¼•ã€‚å½“orå·¦å³æŸ¥è¯¢å­—æ®µåªæœ‰ä¸€ä¸ªæ˜¯ç´¢å¼•ï¼Œè¯¥ç´¢å¼•å¤±æ•ˆï¼Œåªæœ‰å½“orå·¦å³æŸ¥è¯¢å­—æ®µå‡ä¸ºç´¢å¼•æ—¶ï¼Œæ‰ä¼šç”Ÿæ•ˆ
* select* where name like%å¼€å¤´çš„likeæ¨¡ç³ŠæŸ¥è¯¢ï¼Œç´¢å¼•å¤±æ•ˆï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡è¦†ç›–ç´¢å¼•æ¥è§£å†³ï¼Œå¦‚select å­—æ®µ1ï¼Œå­—æ®µ2 where å­—æ®µ1like %ã€‚ä½†æ˜¯ä½¿ç”¨å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆã€‚
* å¦‚æœMysqlè¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ›´æ…¢ï¼Œåˆ™ä¸é€‚ç”¨ç´¢å¼•ï¼ŒæŸ¥è¯¢çš„æ•°æ®å æ‰€æœ‰è¡¨æ•°æ®å¤šçš„æ—¶å€™ï¼Œä¾‹å¦‚name=â€™è¥¿å®‰â€˜ï¼Œè¡¨ä¸­æ‰€æœ‰æ•°æ®nameå‡ ä¹éƒ½ä¸ºè¥¿å®‰ï¼Œé‚£ä¹ˆå°±ä¸èµ°ç´¢å¼•æ›´å¿«ï¼Œ
* åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨ IS NULL æˆ– IS NOT NULLæ“ä½œã€‚æ­¤æ—¶éœ€è¦åˆ¤æ–­ï¼Œå¦‚æœè¯¥å­—æ®µéƒ½ä¸ä¸ºnullï¼Œåˆ™ä¸èµ°ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æã€‚æ‰€æœ‰è¿›è¡Œåˆ¤æ–­
* inèµ°ç´¢å¼•ï¼Œnot inç´¢å¼•å¤±æ•ˆ

> æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```
show status like 'handler_read%'
show global status like â€™handler_read%â€˜
```

