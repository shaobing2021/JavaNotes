## 索引简介

> 索引是帮助MySQL高效获取数据的数据结构

提高数据查询的效率。

索引：排好序的快速查找数据结构！索引会影响where后面的查找，和order by 后面的排序。

## 索引的分类

1. 从存储结构上来划分：BTree索引（B-Tree或B+Tree索引），Hash索引，full-index全文索引，R-Tree索引。

2. 从应用层次来分：普通索引，唯一索引，复合索引。

3. 根据中数据的物理顺序与键值的逻辑（索引）顺序关系：聚集索引，非聚集索引。

### 说明

- 普通索引：即一个索引只包含单个列，一个表可以有多个单列索引
- 唯一索引：索引列的值必须唯一，但允许有空值
- 复合索引：即一个索引包含多个列
- 聚簇索引(聚集索引)：并不是一种单独的索引类型，而是一种数据存储方式。具体细节取决于不同的实现，InnoDB的聚簇索引其实就是在同一个结构中保存了B-Tree索引(技术上来说是B+Tree)和数据行。
- 非聚簇索引：不是聚簇索引，就是非聚簇索引（认真脸）。

## 索引的底层实现

mysql默认存储引擎innodb只显式支持B-Tree( 从技术上来说是B+Tree)索引，对于频繁访问的表，innodb会透明建立自适应hash索引，即在B树索引基础上建立hash索引，可以显著提高查找效率，对于客户端是透明的，不可控制的，隐式的。

## 问题

**问：为什么索引结构默认使用B-Tree，而不是hash，二叉树，红黑树？**

**hash：**虽然可以快速定位，但是没有顺序，IO复杂度高，无法支持范围查询。二叉树：树的高度不均匀，不能自平衡，查找效率跟数据有关（树的高度），并且IO代价高。

**红黑树**：树的高度随着数据量增加而增加，IO代价高。

**为什么官方建议使用自增长主键作为索引**

结合B+Tree的特点，自增主键是连续的，在插入过程中尽量减少页分裂，即使要进行页分裂，也只会分裂很少一部分。并且能减少数据的移动，每次插入都是插入到最后。

总之就是减少分裂和移动的频率。

## b树与b+树

B树

本质是多路二叉树；叶节点具有相同的深度，叶节点的指针为空；所有索引元素不重复；节点中数据索引从左到右依次递增的；

![B树索引示意图](https://pic4.zhimg.com/80/v2-1405edb8b0b8d43150b50e7d1995fcf1_720w.jpg)



B+树（B树的变种）

非叶子节点不存储数据，只存储索引(冗余)和指针，可以放更多的索引，树高降低 ；叶子节点包含所有索引字段；叶子节点比b树增加了指针连接；叶子节点有双向指针链接(首尾子节点还通过指针连接)，提高区间访问的性能，范围查找；

![B+树索引示意图](https://pic3.zhimg.com/80/v2-c9132812a8980b1c8fefd2cff120b263_720w.jpg)

### MySQL的索引要使用B+树而不是其它树形结构?比如B树？

这个问题的复杂版本可以参考本文；

**简单回答是：**

因为B树不管叶子节点还是非叶子节点，都会保存数据，这样导致在非叶子节点中能保存的指针数量变少（有些资料也称为扇出）

指针少的情况下要保存大量数据，只能增加树的高度，导致IO操作变多，查询性能变低；‘

> 个人见解：如果使用b树，b树非叶子节点也会存储数据，那么耗费空间变多，而mysql节点存储容量是16k，导致能存储的指针数量变少。这种情况下要保存大量数据，只能增加树的高度，导致IO操作变多。
>
> 同时B树最好情况是查找根节点，但是最坏进行多次IO，B+树范围查询更加方便

## mysql支持存储数据容量

MySQL每个B+树节点最大存储容量：16KB （指针+数据+索引）。假设我们一行数据大小为1K，那么一页就能存16条数据，也就是一个叶子节点能存16条数据；再看非叶子节点，假设主键ID为bigint类型，那么长度为8B，指针大小在Innodb源码中为6B，一共就是14B，那么一页里就可以存储16K/14=1170个(主键+指针)那么一颗高度为2的B+树能存储的数据为：1170*16=18720条，一颗高度为3的B+树能存储的数据为：1170*1170*16=21902400（千万级条）

```text
show global status like `Innodb_page_size`
```

因此，B+树存储大数据量的表也可以非常高效的获取数据，MySQL使用B+树作为索引的数据结构。

## 为什么非主键索引结构叶子节点存储的是主键值？

- 主键索引和非主键索引维护各自的B+树结构，当插入的数据的时候，由于数据只有一份，通过非主键索引获取到主键值，然后再去主键索引的B+树数据结构中找到对应的行数据，节省了内存空间；
- 如果非主键索引的叶子节点也存储一份数据，如果通过非主键索引插入数据，那么要向主键索引对应的行数据进行同步，那么会带来数据一致性问题。可以通过事务的方式解决，我们都知道使用事务后，就会对性能有所消耗。