## 入门

### 安装

1.通过docker命令启动集群

2.访问es http://192.168.0.130:9200/?pretty

3.name：节点名称，cluster_name:集群名称，version_name：7.8.0 es版本号

```
{
  "name" : "94df6b8cec1a",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "hXFVLIY4RB2nFf60s9lW6w",
  "version" : {
    "number" : "7.8.0",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "757314695644ea9a1dc2fecd26d1a43856725e65",
    "build_date" : "2020-06-14T19:35:50.234439Z",
    "build_snapshot" : false,
    "lucene_version" : "8.5.1",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

4.查看es状况

```powershell
GET http://192.168.0.130:9200/?pretty
Accept: application/json

<> 2021-06-02T221046.200.json

###详细，对值进行介绍
GET http://192.168.0.130:9200/_cluster/health
Accept: application/json

<> 2021-06-02T221117.200.json
<> 2021-06-02T221046.200.json


###不那么详细
GET http://192.168.0.130:9200/_cat/health
Cache-Control: no-cache
Accept: */*
Content-Type: application/json
```

### 实例

```json
{
	"name":"lz",
	"info":{
		"bio":"curious",
		"age":30,
		"interests":["bike","climb"]
	}
}
```

> 传统数据库存上述json数据格式,需要拆成两张表，employee表和employeeInfo表，同时employeeInfo表还需要外键字段关联employee

```java
public class EmployeeInfo{
	private String bio;//性格
	private Integer age;
	private String[] interests;
}
public class Employee{
  private String nama;
  private EmployeeInfo info;
}
Employee employee = new Employee();
EmployeeInfo info = new EmployeeInfo();
info.setAge(18);
employee.setName("zhangsan");
employee.setInfo(info);
```

## 索引的增删查

```powershell
###查看集群状态，green：primary shard和replica shard都是active状态，
###yellow：每个索引的primary shard都是active状态，但是部分replica shard不是active状态，处于不可用状态
##red：不是所有primary shard都是active状态，部分索引丢失
GET http://192.168.0.130:9200/_cat/health?v
Accept: application/json

<> 2021-06-02T235007.200.json
<> 2021-06-02T222806.200.json

###查看所有索引
GET http://192.168.0.130:9200/_cat/indices?v
Accept: application/json

<> 2021-06-02T234639.200.json
<> 2021-06-02T234530.200.json
<> 2021-06-02T223723.200.json

###插入一条索引
PUT http://192.168.0.130:9200/test_index?pretty
Accept: application/json

###删除一条索引
DELETE http://192.168.0.130:9200/test_index
Accept: application/json
```



## PUT

### 插入文档示例

```powershell
###es会自动建立索引和type，为每个doc每个field建立倒排索引，让其可以搜索
PUT /index/type/id
{}
{
  "_index": "shopping",
  "_type": "phone",
  "_id": "1",
  "_version": 1,   //涉及乐观锁和悲观所
  "result": "created",
  "_shards": {
    "total": 2,  //总共有两个shard去写，一个replica shard和一个primary shard
    "successful": 1, //由于此处只有一个节点，所以只写成功一个primary shard
    "failed": 0
  },
  "_seq_no": 0,
  "_primary_term": 1
}

###插入索引，同时确认shard，分布到3个shard以及1个replica shard
PUT http://192.168.0.130:9200/test_2
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"settings": {
  "number_of_shards": 3,
  "number_of_replicas": 1
}}

```



### 更新/插入文档

```powershell
###插入索引，更新必须全量更新
PUT http://192.168.0.130:9200/shopping/phone/1
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{  "title":"小米手机",  "category":"小米",  "images":"http://www.gulixueyuan.com/xm.jpg",  "price":1.00 }

###更新一条文档，必须全量更新，否则会丢掉部分数据
PUT http://192.168.0.130:9200/shopping/phone/1
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{  "title":"小米加强版本手机",  "category":"小米",  "images":"http://www.gulixueyuan.com/xm.jpg",  "price":1.00 }
```

> 发送put请求

幂等性，两个id一致？

### 返回

```
{"acknowledged":true,"shards_acknowledged":true,"index":"shopping"}
```

## GET

### 查询文档

```powershell
GET /index/type/id

GET http://192.168.0.130:9200/shopping/_doc/1

HTTP/1.1 200 OK
Warning: 299 Elasticsearch-7.8.0-757314695644ea9a1dc2fecd26d1a43856725e65 "[types removal] Specifying types in document get requests is deprecated, use the /{index}/_doc/{id} endpoint instead."
content-type: application/json; charset=UTF-8

{
  "_index": "shopping",
  "_type": "phone",
  "_id": "1",
  "_version": 1,
  "_seq_no": 0,
  "_primary_term": 1,
  "found": true,
  "_source": {   //文档数据
    "title": "小米手机",
    "category": "小米",
    "images": "http://www.gulixueyuan.com/xm.jpg",
    "price": 1.00
  }
}

```

### 查找所有文档

#### 示例

```powershell
GET http://192.168.0.130:9200/shopping/phone/_search

HTTP/1.1 200 OK
Warning: 299 Elasticsearch-7.8.0-757314695644ea9a1dc2fecd26d1a43856725e65 "[types removal] Specifying types in search requests is deprecated."
content-type: application/json; charset=UTF-8

{
  "took": 384,  ###花费了多少ms
  "timed_out": false,  ###超时
  "_shards": {  ###数据拆成了几个shard
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": { ###查询结果的数量
      "value": 2,
      "relation": "eq"
    },
    "max_score": 1.0,###对于一个search的相关度匹配分数，越相关，分数越高
    "hits": [  ##详细数据
      {
        "_index": "shopping",
        "_type": "phone",
        "_id": "1",
        "_score": 1.0,
        "_source": {
          "title": "opp手机",
          "category": "oppo",
          "images": "http://www.gulixueyuan.com/xm.jpg",
          "price": 1.00
        }
      },
      {
        "_index": "shopping",
        "_type": "phone",
        "_id": "2",
        "_score": 1.0,
        "_source": {
          "title": "opp手机",
          "category": "oppo",
          "images": "http://www.gulixueyuan.com/xm.jpg",
          "price": 1.00
        }
      }
    ]
  }
}

Response code: 200 (OK); Time: 418ms; Content length: 508 bytes

```

#### 查询

```powershell
###查找所有索引
在es5里面是/shopping/product/_search   
##带type会提示type不推荐，在es7里面只能有一个type，所以上和下相同
GET http://192.168.0.130:9200/shopping/phone/_search
###不带type可以查
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{
  "took": 143,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 3,
      "relation": "eq"
    },
    "max_score": 1.0,
    "hits": [
      {
        "_index": "shopping",
        "_type": "_doc",
        "_id": "eAWs33gB-CElxdss-2tR",
        "_score": 1.0,
        "_source": {
          "title": "小米手机",
          "category": "小米",
          "images": "http://www.gulixueyuan.com/xm.jpg",
          "price": 3999.00
        }
      },
      {
        "_index": "shopping",
        "_type": "_doc",
        "_id": "eQWt33gB-CElxdssCWtT",
        "_score": 1.0,
        "_source": {
          "title": "小米手机",
          "category": "小米",
          "images": "http://www.gulixueyuan.com/xm.jpg",
          "price": 3999.00
        }
      },
      {
        "_index": "shopping",
        "_type": "_doc",
        "_id": "1",
        "_score": 1.0,
        "_source": {
          "title": "小米手机",
          "category": "小米",
          "images": "http://www.gulixueyuan.com/xm.jpg",
          "price": 3999.00
        }
      }
    ]
  }
}
```

### 指定查询（全文检索，短语搜索）

```powershell
###指定查询，query string search 以http请求的query string附带,这种方式不安全
GET http://192.168.0.130:9200/shopping/_search?q=title:华为&sort=price:desc
Cache-Control: no-cache
Accept: */*

###高级查询通过get,dsl:domain specified language 特定领域语言，http request body 用json格式请求，比上强
###注意查询其实是先将所有查询出来，后面再带参数进行过滤
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match": {"category": "oppo"}},"sort":[{"price":"desc"}]}

###全文检索，包含小米 手机或者相关的通过分数都显示出来，所以124均会显示出来，通过倒排索引
#小米  2 4
#手机 1 2 4   显示最前面都是4 2 1
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match": {"category": "小米 手机"}}}


###短语检索 ： 要求输入的字符串必须包含一模一样的，才能算匹配，如小米 手机 ，超小米 手机
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match_phrase": {"category": "小米 手机"}}}

###指定查询所有
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match_all": {}}}
```

### 分页查询排序指定查询key

```powershell
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

###分页查询
{"query": {"match_all": {}},"from": 2,"size": 2}
###只包含category和price两个字段
{"query": {"match_all": {}},"from": 2,"size": 2, "_source":["category","price"]}
###兼顾两个
{"query": {"match_all": {}},"from": 2,"size": 2, "_source":["title"],"sort": {"price": {"order": "desc"}}}
```

### 与或查询

```powershell
###同时满足条件
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query":{"bool":{"must":[{"match": {"category": "小米"}},{"match": {"price": "1"}}]}}}

###两者满足其一
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query":{"bool":{"should":[{"match": {"category": "小米"}},{"match": {"price": "1"}}]}}}
```

### 范围查询

```powershell
###过滤查询
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

###如果只是should，那么category中vivo可以不被匹配
{"query":{"bool":{"should":[{"match": {"category": "vivo"}}],"filter": {"range": {"price":{"gt": 3} }}}}}
```

### 完全匹配查询

```
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match_phrase": {"category": "中米"}}}
```

### 高亮查询

```powershell
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match_phrase": {"category": "中米"}},"highlight": {"fields": {"category":{}}}}

###小米手机这几个字会分别高亮显示，如超小米，超不会被高亮显示
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match": {"category": "小米 手机"}},"highlight": {"fields": {"category": {}}}}
```

### 聚合查询

```powershell
###聚合操作  price_group随意起名,terms分组,field分组字段,size只对统计结果输出，输出价格一样的为一组，size:0对其他数据不显示
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"aggs": {"price_group": {"terms": {"field": "price"}}},"size": 0}

###fielddata=true on [category],uninverting the inverted index倒排索引给正排
###聚合索引，类似分组求个数，category有小米手机xiao等词，则统计小出现多少次，米出现多少次，手出现多少次
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"aggs": {"aggs_name": {"terms": {"field": "category"}}}}

###/shopping/_mapping/_type,设置fielddata为true，这样上面才可以查
PUT http://192.168.0.130:9200/shopping/_mapping
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"properties": {"category": {"type": "text","fielddata": true}}}

###先搜索再分组的写法
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json
###会将包含小米手机的title查出来，然后进行过滤
{"query":{"match": {"title": "小米手机"}},"aggs": {"aggs_name": {"terms": {"field": "category"}}}}

```

#### 结果示例

```
	"aggregations": {
    "aggs_name": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "手",
          "doc_count": 4
        },
				{
          "key": "phone",
          "doc_count": 1
        },
        {
          "key": "中",
          "doc_count": 1
        },
        {
          "key": "超",
          "doc_count": 1
        }
```

### 平均值查询

```powershell
###avg平均值
GET http://192.168.11.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"aggs": {"price_avg": {"avg": {"field": "price"}}},"size": 0}


###先聚合在计算价格

###这里先使用catgory分组，如category 有小米1，大米2，则结果平均价格是米1.5，小1，大2，
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{
  "size": 0,
  "aggs": {
    "aggs_name": {
      "terms": {
        "field": "category",
        "order":{
          "avg_price":"desc"
        }
      },
      "aggs": {
        "avg_price": {
          "avg": {
            "field": "price"
          }
        }
      }
    }
  }
}
```

#### 复杂平均范围组合查询

```powershell
GET http://192.168.0.130:9200/shopping/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{
  "size": 0,
  "aggs": {
    "group_by_price": {
      "range": {
        "field": "price",
        "ranges": [
          {
            "from": 0,
            "to": 1
          },
          {
            "from": 1,
            "to": 2
          }
        ]
      },
      "aggs": {
        "groub_by_category": {
          "terms": {
            "field": "category"
          },
          "aggs": {
            "avg_price": {
              "avg": {
                "field": "price"
              }
            }
          }
        }
      }
    }
  }
}
```



```powershell
GET http://192.168.0.130:9200/shopping/_search

HTTP/1.1 200 OK
content-type: application/json; charset=UTF-8

{
  "took": 54,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 5,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "group_by_price": {
      "buckets": [
        {
          "key": "0.0-1.0",
          "from": 0.0,
          "to": 1.0,
          "doc_count": 0,
          "groub_by_category": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": []
          }
        },
        {
          "key": "1.0-2.0",
          "from": 1.0,
          "to": 2.0,
          "doc_count": 3,
          "groub_by_category": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
              {
                "key": "手",
                "doc_count": 3,
                "avg_price": {
                  "value": 1.0
                }
              },
              {
                "key": "机",
                "doc_count": 3,
                "avg_price": {
                  "value": 1.0
                }
              },
              {
                "key": "米",
                "doc_count": 3,
                "avg_price": {
                  "value": 1.0
                }
              },
              {
                "key": "小",
                "doc_count": 2,
                "avg_price": {
                  "value": 1.0
                }
              },
              {
                "key": "中",
                "doc_count": 1,
                "avg_price": {
                  "value": 1.0
                }
              },
              {
                "key": "超",
                "doc_count": 1,
                "avg_price": {
                  "value": 1.0
                }
              }
            ]
          }
        }
      ]
    }
  }
}

Response code: 200 (OK); Time: 133ms; Content length: 806 bytes

```



### 映射关系

> 索引分三种：分词索引，完全索引，不被索引

```powershell

###映射关系 1 先创建user
PUT http://192.168.11.130:9200/user
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

###2  index:true表示可以索引查询，type:text表示可以被分词查询
PUT http://192.168.11.130:9200/user/_mapping
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"properties": {"name": {"type": "text","index": "true"},"sex":{"type": "keyword","index": true},"tel": {"type": "keyword","index": false}}}

<> 2021-04-18T033402.200.json
###3 查看put的mapping
GET http://192.168.11.130:9200/user/_mapping
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

<> 2021-04-18T033425.200.json
###4 放入数据
POST http://192.168.11.130:9200/user/_doc/3
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{  "name":"oppo手机",  "sex":"女的",  "tel": "136" }

<> 2021-04-18T034706.200.json
<> 2021-04-18T034651.409.json
<> 2021-04-18T034625.409.json


###5 查询   有分词效果，通过小查到小米
GET http://192.168.11.130:9200/user/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match": {"name": "小"}}}

###6查询 通过女查不到女的，必须完全匹配
GET http://192.168.11.130:9200/user/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match": {"sex": "女的"}}}

###7查询 通过电话查询，不能查询，因为电话没被索引，
GET http://192.168.11.130:9200/user/_search
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"query": {"match": {"tel": "136"}}}
```



## DELETE	

DELETE请求  http://192.168.11.130:9200

```powershell
###删除数据
DELETE http://192.168.0.130:9200/shopping/_doc/1
Cache-Control: no-cache
Accept: */*
Content-Type: application/json
```



### 返回

```
{"acknowledged":true}
```

## POST

### 插入

#### 插入一条

请求路径 /shopping/_doc/      这种随机生成id方法不能改为put，否则会报错

/shopping/__doc/1

![image-20210417195002759](https://gitee.com/shaobing2021/typora/raw/master/img/20210529164322.png)

```
请求体
{
 "title":"小米手机",
 "category":"小米",
 "images":"http://www.gulixueyuan.com/xm.jpg",
 "price":3999.00
}
```

#### 返回

> id随机生成

```
{
  "_index": "shopping",
  "_type": "_doc",
  "_id": "eQWt33gB-CElxdssCWtT",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 1,
  "_primary_term": 1
}
```

> id固定

```
{
  "_index": "shopping",
  "_type": "_doc",
  "_id": "1",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 2,
  "_primary_term": 1
}
```

### 更新

```powershell
###更新部分，由于更新局部，每次结果不一致，不能用put。更新全局可以用put

POST http://192.168.0.130:9200/shopping/_update/1
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"doc":{  "title":"华为手机" ,"os":"harmony"}}

###两种不同的更新方式,如果不添加update将会导致,原先的数据被替换成下面的json字符串，添加了之后若没有title将会添加
POST http://192.168.0.130:9200/shopping/_doc/1/_update
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

{"doc":{  "title":"小米手机" ,"os":"miui"}}

```

#### 返回

```powershell
POST http://192.168.11.130:9200/shopping/_update/1

HTTP/1.1 200 OK
content-type: application/json; charset=UTF-8

{
  "_index": "shopping",
  "_type": "_doc",
  "_id": "1",
  "_version": 7,
  "result": "updated",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 8,
  "_primary_term": 1
}

Response code: 200 (OK); Time: 130ms; Content length: 156 bytes

```

## DELETE

```powershell
###删除文档
DELETE http://192.168.0.130:9200/shopping/_doc/1
Cache-Control: no-cache
Accept: */*
Content-Type: application/json

###删除索引
DELETE http://192.168.0.130:9200/test_2
Accept: application/json
```

#### 返回

```
DELETE http://192.168.11.130:9200/shopping/_doc/1

HTTP/1.1 200 OK
content-type: application/json; charset=UTF-8

{
  "_index": "shopping",
  "_type": "_doc",
  "_id": "1",
  "_version": 9,
  "result": "deleted",   //not found
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 10,
  "_primary_term": 1
}

Response code: 200 (OK); Time: 181ms; Content length: 157 bytes

```