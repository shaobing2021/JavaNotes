### 数据链路层

https://blog.csdn.net/iwanderu/article/details/103812828

数据链路层属于计算机网络的低层，该层使用的信道主要有以下两种：

#### 简介

（1）**点对点信道**。使用一对一的点对点通信方式。

（2）**广播信道**。使用一对多的广播信道通信方式，广播信道上连接了很多主机，因此必须使用专用的共享信道协议协调这些主机的数据发送。

网络层讨论分组如何从一个网络通过路由器转发到另一个网络，本章讨论分组怎样从一台主机传送到另一台主机，不经过路由器，从整个网络看，局域网属于数据链路层的范围。

本章最重要的内容是：

（1）数据链路层的点对点信道和广播信道的特点，以及这两种信道所用协议（PPP协议以及CSMA/CD协议）的特点。

（2）数据链路层的三个基本问题：封装成帧、透明传输和差错检测。

（3）以太网MAC层的硬件地址。

（4）适配器、转发器、集线器、网桥、以太网交换机的作用和使用场合。

#### 3.1 使用点到点信道的数据链路层

链路和数据链路不是一回事，**链路（****link****）**是从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有其他交换结点。进行数据通信时，两台计算机之间的通信路径往往要经过许多段链路，因此链路只是一条路径的组成部分。

**数据链路（data link**）**是另一个概念。当需要在一条线路上传送数据时，除必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。最常用的方法是使用**网络适配器**（既包括硬件也包括软件）来实现这些协议。一般的适配器都包括数据链路层和物理层这两层的功能。

也有另外的术语，即把链路分为物理链路（上述链路）和逻辑链路（上述数据链路，是物理链路加上必要的通信协议）。

早期数据通信协议叫通信**规程（****procedure****）**，因此在数据链路层，规程和协议是同义语。

数据链路层的协议数据单元PDU是**帧**。数据链路层把网络层交下来的数据构成帧发送到链路上，以及把接收到的帧中的数据提出并上交给网络层。互联网中，网络层的协议数据单元就是IP数据报（或简称**数据报**、**包**、**分组**）。

点到点信道的数据链路层在通信时的主要步骤：

（1）结点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成帧

（2）结点A把封装好的帧发送给结点B的数据链路层

（3）若结点B的数据链路层收到的帧无差错，则提取出IP数据报上交网络层，否则丢弃这个帧。



数据链路层协议有许多种，但有三个基本的共同问题：**封装成帧**、**透明传输**和**差错控制**。

**（1）****封装成帧**

**封装成帧（framing****）**就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧，接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

一个帧的帧长等于数据长度部分（IP数据报构成）加上帧首部和帧尾部的长度。首部和尾部的一个重要作用就是**帧定界**（即确定帧的界限）。此外首部和尾部还包括许多控制信息，在发送帧时，是从帧首部开始发送的。为提高帧传输效率，应使帧的数据部分长度仅可能大于首部和尾部，但每一种链路层协议都规定了所能传送的帧的数据部分长度上限——**最大传输单元****MTU****（Maximum Transfer Unit****）**。

当数据由可打印的ASCII码组成的文本文件时，帧定界可以使用特殊的**帧定界符**。控制字符SOH（Start Of Header）放在帧的最前面，表示帧的首部开始，另一个控制字符EOT（End Of Transmission）表示帧的结束。SOH和EOT都是控制字符的名字，它们的16进制编码分别是01和04。

当数据在传输中出现差错时，帧定界的作用更加明显。假定发送端在尚未发送完一个帧时发生故障，中断了发送之后恢复正常，从头开始发送刚才未发完的帧，由于使用了帧定界符，接收端就知道前面收到的数据是不完整的帧（只有SOH而没有EOT），必须丢弃。

**（2）****透明传输**

当传送帧是用文本文件组成的帧时，其数据部分不会出现SOH或EOT这样的帧界定控制符。因此不管从键盘上输入什么字符都可以放在这样的帧中传输过去，这样的传输就是透明传输。

但当数据部分时非ASCII码的文本文件时，情况就不同了。如果数据中某个字节的二进制代码恰好和SOH或EOT一样，数据链路层会**错误地**找到帧的边界收下部分帧而把剩下的数据丢弃。

**透明**是一个重要术语，它表示：**某一个实际存在的事物看起来却好像不存在一样**。在数据链路层透明传送数据，表示无论什么样的比特组合的数据，都能按原样没有差错地通过数据链路层。因此对传送数据来说，这些数据就“看不见”数据链路层有什么妨碍数据传输的东西。

为解决透明传输，必须设法使数据中可能出现的控制字符SOH和EOT在接收端不被解释为控制字符。具体的方法是：发送端的数据链路层在数据中的SOH或EOT之前插入一个**转义字符****ESC**（其16进制编码为1B），而在接收端的数据链路层在把数据送往网络层之前删除这个ESC。这种方法称为**字节填充**或**字符填充**。如果转义字符也出现在数据，那就在ESC前再加一个ESC。

（3）**差错控制**

比特在传输过程中可能产生差错：1可能变成0，0可能变成1，这就叫**比特差错**。比特差错是传输差错的一种。在一段时间内，传输错误的比特占所传输比特总数的比率就叫**误码率****BER****（Error Bit Rate****）**。误码率和信噪比有关，如果设法提高信噪比，误码率就会减小。为保证数据传输可靠性，必须采用各种差错检测措施，目前在数据链路层广泛使用了**循环冗余检测****CRC**的检错技术。

在发送端，先把数据划分为组，假定每组k个比特。假定待传送数据M=101001（k=6），CRC运算就是在M的后面添加n位供差错检测用的**冗余码**，然后构成一个（k+n）位的帧发送出去。

n位冗余码用以下方法得出。用二进制的模2运算进行2n乘M，相当于在M后面添加n个0，得到的（k+n）位数除以事先约定的长度为（n+1）的除数P得到商Q和余数R（n位，比除数少一位）。例M=101001，P=1101即n=3，经模2除法得出的结果是商Q=110101（商无用），R=001。这个余数R就作为冗余码拼接在M的后面发送出去，这种为了检错而添加的冗余码称为**帧检测码****FCS**，因此加上FCS后发送的帧是101001001（即2nM+FCS）。

接收端把接收到的数据以帧为单位进行CRC校验：把收到的每一个帧都出以同样的除数P（模2运算），然后检查余数R。如果传输无差错，那么R=0。若R=0，判定帧没有差错，接收，如果R不等于0，则判断帧有差错并舍弃。

一种较简便的方法是用多项式来表示循环冗余检验过程。例如用P(X)=X3+X2+1表示1101。多项式P(X)称为**生成多项式**。

在数据链路层，发送端帧检验序列FCS和接收端CRC检验都是用硬件完成的，处理迅速，不会延误数据的传输。从上述讨论可知如果不以帧为单位传送数据就无法加入冗余码来进行差错检验，因此要在数据链路层进行差错检验就必须把数据划分位帧，每一帧都加上冗余码，一帧一帧地发送然后在接收端逐帧进行差错检验。

若仅使用CRC，则只能做到对帧的**无差错接受**，即凡是接收端数据链路层接受的帧，我们都能以非常接近1的概率认为这些帧在传输中没有出现差错。出现差错的帧虽然曾接收到了但最终会被丢弃。

差错传输分类两大类：一类是前述最基本的比特差错，而另一类传输差错更复杂，就是收到的帧没有比特差错，但出现了**帧丢失**、**帧重复**或**帧失序**。

过去OSI的观点是：必须让数据链路层向上提供可靠传输，因此在CRC的基础上增加了**帧编号**、**确认**和**重传机制**。收到正确的帧就要向发送端发送确认，发送端未在时限内收到对方确认就会进行重传直到收到对方确认位置。但现在的通信线路质量已大大提高，互联网以采用了区别对待的方法。

对通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制，即不要求向上提供可靠的传输服务。如果在数据链路层传输数据时出现差错并需要更正，那么改正差错的任务交给上层协议（如运输层的TCP）来完成。

对通信质量较差的无线传输链路，数据链路层协议使用确认和重传机制，向上提供可靠的服务。实践证明，这样做可以提高通信效率。

#### 3.2 点对点协议PPP

![image-20200509230853545](https://gitee.com/shaobing2021/typora/raw/master/img/20200728095710.png)

通信线路质量较差的年代，多使用可实现可靠传输的高级数据链路控制HDLC，现在HDLC已很少使用了，对于点对点的链路，简单得多的点对点协议PPP是目前使用的最广泛的数据链路层协议。

互联网用户通常需要连接到某个ISP才能接入互联网，PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。

**PPP****协议应满足的需求**：

**（1）****简单**

IETF设计互联网体系结构时将最复杂的部分放在TCP协议中，而网际协议IP则相对简单，提供不可靠的数据包服务。因此数据链路层没必要提供比IP协议更多的功能，对数据链路层的帧，不需要纠错，不需要序号，也不需要流量控制。IETF把简单作为**首要需求**。

简单的设计可使协议在实现时不易出错，从而使不同厂商在协议的不同实现上的互操作性提高了。数据链路层的协议非常简单：接收方每接收到一个帧，就进行CRC检验，如果正确就接收，否则丢弃，**其他什么也不做**。

##### **（2）****封装成帧**

PPP协议必须规定特殊字符作为帧定界符（即标志一个帧开始和结束的字符），以便接收端从收到的比特流中能准确找出帧的开始和结束位置。

##### **（3）****透明性**

即透明传输

PPP协议必须保证数据传输的透明性，这就是说如果数据中碰巧出现了和**帧定界符**

一样的比特组合时，就要采取有效的措施解决。

**（4）****多种网络层协议**

PPP协议必须能够在**同一条物理链路上同时支持多种网络层协议**的运行。当点对点链路所连接的是局域网或路由器时，PPP协议必须同时支持在链路所连接的局域网或路由器上运行的各种网络层协议。

**（5）****多种类型链路**

除要支持多种网络层协议外，PPP还必须能够在多种类型的链路上运行。例如，串行的或并行的，同步的或异步的，低速的或高速的，电的或光的，交换的（动态的）或非交换的（静态的）点对点链路。

在以太网上运行的PPP，即PPPoE，这是PPP协议能适应多种类型链路的一个典型例子。PPPoE是为宽带上网的主机使用的链路层协议，宽带上网时由于传输速率较高，因此可让多个连接在以太网上的用户共享一条到ISP的宽带链路，即使只有一个用户利用ADSL进行宽带上网（不和其他人分享到ISP的宽带链路），也是使用PPPoE协议。

##### **（6）****差错检测**

PPP协议必须能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。

**（7）****检测连接状态**

PPP协议必须具有一种机制能够及时（不超过几分钟）自动检测出链路是否处于正常工作状态。

**（8）****最大传送单元**

PPP协议必须对每一种类型的点对点链路设置最大传送单元MTU的标准默认值（1500B），这样做是为了促进各种实现之间的互操作性。MTU是数据链路层的帧可以载荷的**数据部分**的最大长度，**不是帧的总长度**。

**（9）****网络层地址协商**

PPP协议必须提供一种机制使通信的两个网络层的实体能通过协商知道或能配置彼此的网络层地址。协商算法应尽可能简单，并满足所有情况。对拨号连接的链路尤为重要。

**（10）****数据压缩协商**

PPP协议必须提供一种方法来协商数据压缩算法，但并不要求该算法标准化。

在TCP/IP协议族中，可靠传输由运输层的TCP协议复杂，因此数据链路层的PPP协议不需要进行纠错，不需要设置序号，也不需要进行流量控制。PPP协议不支持多点线路（即一个主站轮流和链路上的多个从站通信），只支持点对点的链路通信，此外PPP只支持全双工链路。

**PPP****协议的组成**：

（1）一个将IP数据报封装到串行链路的方法。PPP既支持异步链路（无奇偶检验的8比特数据），也支持面向比特的同步链路。

（2）一个用来建立、配置和测试数据链路连接的**链路控制协议****LCP**。

（3）**一套网络控制协议****NCP**，其中每个协议支持不同的网络层协议。

 

PPP协议的帧格式

首部（F A C 协议）+信息部分+尾部（FCS F）

**（1）****各字段的意义**

PPP帧的首部和尾部分别为四个字段和两个字段。首部的第一个字段和尾部的第二个字段都是标志字段F，规定为0x7E，标志字段表示一个帧的开始或结束。因此标志字段就是PPP帧的定界符，连续两帧之间只需要一个标志字段。如果出现连着两个标志字段，就表示一个应当丢弃的空帧。

首部中的四个字段为标志字段F，地址字段A和控制自字段C，2B的协议字段。信息字段的长度可变，不超过1500B。尾部的第一个字段（2B）是使用CRC的帧检验序列FCS，第二个字段是标志字段F。

F、A、C均为1B，协议和FCS为2B，信息部分不超过1500B。

##### **（2）****字节填充**

当PPP使用异步传输时，它把转义字符定义为0x7D，并使用字节填充。

由于在发送端进行了字节填充，因此在链路上传送的信息字节就超过了原来的信息字节数，但接收端在收到数据后再进行与发送端字节填充的相反变换，就可正确恢复出原有信息。

##### **（3）****零比特填充**

PPP协议在使用SONET/SDH链路时，使用同步传输（一连串的比特连续发送）而不是异步传输（逐个字符传送）。在这种情况下，PPP采用零比特填充法来实现透明传输。

具体做法：发现有5个连续的1，则填入一个0，保证信息字段不会出现连续6个1。接收端在收到一个帧时，先找到标志字段F确定一个帧的边界，再用硬件对比特流扫描，当发现5个连续的1时就删除后面的0。

 

PPP协议的工作状态

当用户拨号接入ISP后，就建立了一条从用户个人电脑到ISP的物理连接，这时用户电脑向ISP发送一系列链路控制协议LCP分组。这些分组及其响应选择了一些需要的PPP参数，接着还要进行网络配置，网络控制协议NCP给新接入的用户分配一个临时IP地址，通信完毕后，NCP释放网络层连接收回IP地址，接着LCP释放数据链路层连接，最后释放物理层连接。

PPP链路的起始和终止状态永远都是**链路静止**状态，此时用户个人电脑和ISP的路由器之间不存在物理层连接。当用户电脑通过调制解调器呼叫路由器时，路由器能检测到调制解调器发出的载波信号，双方建立了物理层连接后，PPP就进入了**链路建立**状态，目的是为了建立链路层的LCP连接。

这时LCP开始协商**配置选项**，即发送LCP的**配置请求帧**，链路的另一端可发送以下几种响应的一种：

（1）**配置确认帧** 所有选项都接受

（2）**配置否认帧** 所有选项都理解但不接受

（3）**配置拒绝帧** 选项有的无法识别或不能接受，需要协商。

协商结束后双方建立LCP链路，进入**鉴别**状态。该状态下只允许传送LCP协议的分组、鉴别协议的分组和监测链路质量的分组。若使用**口令鉴别协议****PAP**，则需要发起通信的一方发送身份标识符和口令。还可以使用更复杂的**口令握手鉴别协议****CHAP**。若鉴别失败则转到**链路终止**状态，若鉴别成功，则进入**网络层协议**状态。

在网络层协议状态，PPP链路两端的网络控制协议NCP根据网络层的不同协议互相交互网络层特定的网络控制分组。当网络层配置完成后，链路就可进入**链路打开**状态，链路的两个PPP端点可以彼此向对方发送分组。两个PPP端点还可发送**回送请求**LCP分组和**回送回答**LCP分组以检查链路的状态。

数据传输结束后可由链路一端发出**终止请求**LCP分组请求终止链路连接，在收到对方发来的**终止确认**LCP分组后，转到**链路终止**状态。若链路出现故障，也会从链路打开转到链路终止状态。当调制解调器的载波停止后，回到链路静止状态。

从设备之间无链路开始，先建立物理链路，再建立链路控制协议LCP链路。经过鉴别后再建立网络控制协议NCP链路然后才能交换数据。由此可见PPP协议不是纯粹的数据链路层协议，还包含了物理层和网络层的内容。

3.3 使用广播信道的数据链路层

广播信道可以进行一对多的通信，局域网使用的就是广播信道。

局域网最主要的特点：**网络为一个单位所有，且地理范围和站点数目有限**。

局域网的主要优点：

（1）具有广播功能，从一个站点可以很方便地访问全网。

（2）便于系统的扩展和逐渐演变，各设备的位置可灵活调整。

（3）提高了系统的可靠性、可用性和生存性。

局域网可按网络拓扑分类：

（1）**星形网**。由于**集线器**的出现和双绞线大量用于局域网中，星形以太网以及多级星形结构的以太网获得了广泛应用。（2）**环形网**。（3）**总线网**，各站直接连在总线上。以传统以太网最为著名。

局域网可使用多种传输媒体，双绞线是主流，当数据率很高时需要使用光纤。

局域网工作的层次跨越了数据链路层和物理层，不仅与数据链路层有关。

共享信道解决众多用户合理方便共享通信媒体资源的两种方法：

（1）**静态划分信道**，如2.4节中的频分复用FDM、时分复用TDM、波分复用WDM和码分复用CDM等。用户只要分配了信道就不会和其他人冲突，但代价高不适合局域网。

（2）**动态媒体介入控制**，又称**多点接入**，特点是信道并非在用户通信时固定分配给用户，又分为两类：①**随机接入**，特点是所有用户可随机发送信息。如果恰好由两个或以上用户在同一时刻发送信息，在共享媒体上会发生碰撞（冲突）。②**受控接入**，特点是用户不能随机发送而必须服从控制。代表由分散控制的令牌环局域网和集中控制的多点线路**探寻**，或称为**轮询**。

 

#### **以太网的两个标准**

以太网用无源电缆作为总线传输数据帧，并以曾在历史上表示传播电磁波的**以太**命名。

DEC公司、英特尔公司和施乐公司礼盒提出了10 Mbit/s以太网规约的第一个版本DIX V1，1982年修改为第二版规约DIX Ethernet V2。

在此基础上，IEEE 802委员会（专门制定局域网和城域网标准的机构）于1983年制定了第一个IEEE的以太网标准IEEE 802.3，数据率约为10Mbit/s。由于DIX Ethernet V2和IEEE的802.3标准很小，因此很多人把802.3局域网称为以太网。

IEEE 802委员会未能形成统一的局域网标准，而是被迫制定了几个不同的局域网标准，如802.4令牌总线网、802.5令牌环网等。为使数据链路层更好适应多种局域网标准，IEEE 802委员会把局域网的数据链路层拆分为两个子层，**逻辑链路控制****LLC**子层和**媒体接入控制****MAC**子层。于介入到传输媒体有关的内容放在MAC子层，而LLC子层与传输媒体无关，不管采用何种传输媒体和MAC子层的局域网对LLC子层来说都是透明的。

随着互联网的发展，局域网只剩下DIX Ethernet V2而不是IEEE 802.3标准中的局域网，因此LLC的作用已经消失了，很多厂商的适配器仅有MAC协议而没有LLC协议。

 

**适配器的作用**

计算机与外界局域网的连接是通过通信**适配器**进行的。适配器是一块网络接口板，又称**网络接口卡****NIC**简称网卡。适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的，而适配器和计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行的。因此适配器的一个重要功能即进行数据串行传输和并行传输的转换。由于网络和计算机总线上的数据率不同，还需要在适配器中装有对数据进行缓存的存储芯片。在主板插入适配器时，还必须安装管理该适配器的设备驱动程序至计算机的操作系统，该程序将告之计算机应当从存储器的什么位置把多长的数据块发送到局域网，或者在存储器的什么位置把局域网传来的数据块存储下来。适配器还要能够实现以太网协议。

适配器的功能包含了数据链路层和物理层两个层次的功能。

适配器在接受和发送帧时，不使用计算机的CPU。当适配器收到有差错的帧时，直接丢弃而不必通知计算机，当收到正确帧时，使用中断通知计算机，并交付协议栈中的网络层。当计算机要发送IP数据报时，由协议栈把IP数据报向下交给适配器，组装成帧后发到局域网。计算机的硬件地址就在适配器的ROM中，而计算机的软件地址（IP地址）则在计算机的存储器中。

 

##### CSMA/CD协议

最早的以太网是将许多计算机连接到一根总线上。总线的特点是：使用广播通信方式，当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据。为了在总线上实现一对一的通信，可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址，仅当数据帧的目的地址和适配器ROM中的硬件地址一样时，适配器才能接收这个数据帧。

为了通信的简便，以太网采用了以下两种措施：

（1）采用较为灵活的**无连接**工作方式，即不必先建立连接就可直接发送数据。适配器对发送的数据帧**不进行编号**，也**不要求对方发回确认**。因此以太网提供的服务是**尽最大努力的交付**，即**不可靠的交付**。**对有差错帧是否需要重传由高层决定**。例如TCP发现丢失数据后就把数据重新传递给以太网重传，**但以太网并不知道这是重传帧**，而是当作新数据帧。

总线上只要有一台计算机在发送数据，总线的传输资源就被占用，因此**同一时间只允许一台计算机发送数据**，否则会计算机之间会互相干扰。以太网采用的协调方法是使用CSMA/CD协议，意思是**载波监听多点接入****/****碰撞检测**。

（2）以太网发送的数据都使用曼彻斯特编码的信号。二进制基带数字信号的问题是出现一长串的连0或连1时接收端就无法从收到的比特流中提取同步位。曼彻斯特编码保证了每个码元的正中间出现一次电压转换，而接收端就利用这种转换方便地提取同步信号。缺点是所占的频带宽度增加了一倍。

CSMA/CD协议的要点：

（1）**多点接入** 说明这是总线型网络，许多计算机以多点接入的方式连接在总线上。协议的实质是载波监听和碰撞检测。
     （2）**载波监听** 用电子技术检测总线上有没有其他计算机也在发送，**不管发送前还是发送中，每个站都必须不停地检测信道**。

（2）**碰撞检测** **边发送边监听**，即适配器边发送数据边检测信道上的信号电压的变化情况，以判断自己在发送数据时其他站是否也在发送数据，也称冲突检测。

**电磁波在1km****电缆的传播时延约为5****μs**。在局域网中，常把总线上的**单程端到端传播时延**记为τ，站发送数据后最迟要经过**两倍的总线端到端传播时延**（2τ）或**总线的端到端往返传播时延**才能知道自己发送的数据和其他站的数据有没有发送碰撞。由于局域网上任意两站间传播时延有长有短，因此局域网必须按照最坏情况设计，即取总线两端的两个站之间的传播时延（这两个站之间距离最大）为端到端传播时延。

显然在使用CSMA/CD协议时一个站**不可能同时进行发送和接受**（**必须边发送边监听信道**），因此使用CSNA/CD协议的以太网不可能进行全双工通信而只能进行**双向交替通信**（**半双工通信**）。

**每个站在自己发送数据之后的一小段时间内**，**存在着遭遇碰撞的可能性**，这一小段时间是**不确定的**，它取决于另一个发送数据的站到本站的距离。因此以太网不能保证某一时间之内一定能把自己的数据帧成功地发送出去，这一特点称为**发送的不确定性**。

以太网的端到端往返时间称为**争用期**，又称为**碰撞窗口**，因为一个站在发送完数据后，只有通过争用期的“考验”，即**经过争用期这段时间还没有检测到碰撞**，**才能肯定这次发送不会发生碰撞**。

以太网使用截断二进制指数退避算法来确定碰撞后重传的时机，这种算法让发生碰撞的站在停止发送数据后，不是等待信道空闲后就立即发送数据，而是**推迟**（**退避**）一个随机时间。协议规定了基本退避时间为争用期2τ，具体的争用期时间是51.2μs。对于10Mbit/s以太网，在争用期可发送512bit，即64B，也可以说争用期是512比特时间。

从离散的整数集合[0，1，...，2k-1]中随机取出一个数记为r，重传应退后的时间就是r倍的争用期。重传次数不超过10，k=重传次数，当超过10次时，k=10。当重传达16次仍未成功时，丢弃该帧，并向高层报告。

以太网规定了一个最短帧长64B，即521bit，如果要发送的数据非常少，必须加入一些填充字节。

以太网在发送数据时，如果在争用期（发送64B）没有发生碰撞，那么后续发送的数据就一定不会冲突。如果发生碰撞，一定是在发送之前的64B内，**因此凡是长度小于****64B****的帧都是由于冲突而异常终止的无效帧**，收到后应当立即丢弃。

**强化碰撞**，当发送数据的一战发现发生了碰撞时，除了立即停止发送数据外，还要再继续发送32bit或48bit的**人为干扰信号**，以便所有用户都知道现在已发生了碰撞。

以太网还规定了**帧间最小间隔**为9.6μs，相当于96比特时间，这样做是为了使刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。

CSMA/CD协议的要点：

（1）准备发送：适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太网帧，放入适配器的缓存中。但在发送前必须先检测信道。

（2）检测信道：若检测信道忙，应不停地检测，直到信道转为空闲。若检测信道空闲，并在96比特时间内信道保持空闲（保持了帧间最小间隔），就发送这个帧。

（3）在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可能性：①发送成功：在争用期未检测到碰撞，发送成功后什么也不做返回（1）。②发送失败：在争用期内检测到碰撞，立即停止发送数据，按规定发送人为干扰信号。适配器执行指数退避算法，等待r倍512比特时间后回到步骤（2）。若重传16次仍不能成功，停止重传上报错误。

以太网每发送一帧，一定要把已发送的帧暂时保留一下，如果在争用期内检测到碰撞，那么还要推迟一段时间后再把这个暂时保留的帧重传一次。

 

传统以太网最初使用同轴电缆，最后发展为使用双绞线。这种以太网采用星形拓扑，在星形中心增加了可靠性很高的设备，叫**集线器**。双绞线以太网总是和集线器配合使用，由于集线器使用了大规模集成电路芯片，因此可靠性大大提高。1990年IEEE制定出星形以太网10BASE-T的标准802.3i。10代表10Mbit/s的数据率，BASE表示连接线上的信号是基带信号，T表示双绞线。10BASE-T以太网通信距离稍短，每个站到集线器的距离不超过100m。

使双绞线能够传输高速数据的主要措施是把双绞线的绞合度做的非常精确，可使特性阻抗均匀以减少失真，而且大幅度减少了电磁波辐射和无线电频率干扰。

集线器的特点如下：

（1）**使用集线器的以太网在逻辑上仍是一个总线网**，**各站共享逻辑上的总线**，**使用的还是****CSMA/CD****协议**（各站中的**适配器**执行CSMA/CD协议）。网络中的各站必须竞争对传输媒体的控制，并在**同一时刻至多只允许一个站发送数据**。

（2）一个集线器有许多**接口**（硬件端口），每个接口通过RJ-45插头用两对双绞线与一台计算机上的适配器相连。因此一个集线器很像一个**多接口的转发器**。

（3）**集线器工作在物理层**，它的每个接口仅仅**简单地转发比特**，收到1就转发1，收到0就转发0，不进行**碰撞检测**。若发生碰撞那么所有接口都收不到正确的帧。

（4）采用专门芯片进行自适应串音回波抵消，可使发出地较强信号不致对接收到的较弱信号产生干扰。

集线器本身非常可靠，堆叠式集线器由4-8个集线器堆叠起来使用。集线器一般都有少量的容错能力和网络管理功能。IEEE802.3还可使用光纤作为传输媒体，相应标准是10BASE-F系列，F代表光纤。它主要作用于集线器之间的远程连接。

以太网定义了参数a，它是以太网**单程端到端时延**τ与**帧的发送时间**T0之比，以太网的**参数****a****值应尽可能小些**，当数据率一定时，**以太网的连线长度受到限制**（否则τ太大），同时**以太网的帧长不能太短**（否则T0的值太小）。

极限信道利用率Smax=1/（1+a），**当****a****远小于1****时才能得到尽可能高的极限信道利用率**。

 

##### 以太网的MAC层

**MAC****层的硬件地址**

局域网中，**硬件地址**又称为**物理地址**或**MAC****地址**（因为这种地址用在MAC帧中）。IEE802标准为局域网规定了一种48位的全球地址，是局域网上的每一台计算机中**固化在适配器的****ROM****中的地址**。因此，

（1）更换了新的适配器后即使计算机的物理位置和接入的局域网没有任何改变，但这台计算机的局域网的地址改变了。

（2）即使改变了计算机的物理位置和接入的局域网，只要适配器不变，那么计算机在局域网中的地址就不变。

**严格地讲，局域网的地址应当是每一个站的名字或标识符**。如果连接在局域网上的主机或路由器有多个适配器，那么它就有多个地址。更准确地说，这种48位地址应当是某个接口的标识符。

**MAC****地址**也叫**硬件地址**或**物理地址**，MAC地址实际上就是**适配器地址**或**适配器标识符****EUI-48**。当这块适配器插入或嵌入某台计算机后，适配器的标识符EUI-48就成为这台计算机的MAC地址了。

IEEE规定地址字段的第一个字节位的最低位为I/G位，当其为0时，地址字段表示一个**单个站地址**，为1时表示**组地址**，用来进行**多播**。因此IEEE只分配地址段的前三个字节中的23位。IEEE把地址字段第一个字节的最低第二位规定为G/L位，0表示**全球管理**，1表示**本地管理**。

当路由器通过适配器连接到局域网时，适配器上的硬件地址就用来标志路由器的某个接口。路由器如果同时连接两个网络，那么它就需要两个适配器和两个硬件地址。

适配器有**过滤**功能。当适配器从网络收到每个MAC帧就先用硬件检测其目的地址，若是发往本站的帧则收下否则丢弃。发往本站的帧包括以下三种：

（1）**单播**帧（一对一） 即收到的帧与本站硬件地址相同

（2）**广播**帧（一对全体） 即发送给本局域网上所有站点的帧

（3）**多播**帧（一对多） 即发送给本局域网上一部分站点的帧

所有的适配器都应至少能识别前两种帧，即单播和广播地址。

以太网适配器还可设置为一种特殊的工作方式，即**混杂方式**。该工作方式是黑客常利用来非法获取网上用户口令的方法，适配器只要“听到”有帧在以太网传输就悄悄接收下来而不管这些帧是发往哪个站。但混杂方式有时非常有用，例如网络维护人员用以监视和分析以太网的流量。有一种叫做**嗅探器**的网络工具就使用了设置为混杂方式的网络适配器。

 

##### **MAC**帧的格式

![image-20200509222133514](https://gitee.com/shaobing2021/typora/raw/master/img/20200728095711.png)

常用的以太网MAC帧格式有两种标准，一种是以太网V2标准，一种是IEEE的802.3标准。这里讨论用的最多的以太网V2的MAC帧格式。

以太网V2的MAC帧较为简单，由五个字段组成。前两个字段分别为6B长的**目的地址**和**源地址**字段。第三个字段是2B的**类型字段**，用来标志上一层使用的是什么协议。第四个字段是**数据字段**，长度在45-1500B之间，46B是由最小长度64B减去18B的首部和尾部得出的数据字段的最小长度。最后一个字段是4B的**帧检验序列****FCS**（使用CRC检验）。

MAC子层通过曼彻斯特编码的特点确定MAC帧中数据字段的结束位置。

为了接收端迅速实现位同步，从MAC子层向下传到物理层时还要在帧的前面插入8字节（由硬件生成），它由两个字段构成。第一个字段时7个字节的**前同步码**（1和0交替码），它的作用是使接收端的适配器在接收MAC帧时能够迅速调制其时钟频率，使它和发送端的时钟同步。第二个字段是**帧开始定界符**，定义为10101011，它的前6位和前同步码一样，最后的连续两个1就是告诉接收端适配器MAC帧的信息马上要来了请注意接收。MAC帧的FCS字段检验范围不包括前同步码和帧开始定界符，在使用SONET/SDH进行同步传输时不需要使用前同步码，因为同步传输时收发双方的位同步总是一直保持的。

IEEE802.3标准规定下列情况之一的即为无效MAC帧：

（1）帧长度不是整数个字节

（2）用收到的帧检验序列FCS查出差错

（3）收到的帧MAC客户数据字段长度不在46-1500B之间。考虑到帧的首部和尾部长度共18B，可得出有效的MAC帧长度在64-1518B之间。

对于检测出的无效MAC帧就简单丢弃，以太网不负责重传丢弃的帧。

IEEE802.3规定的MAC帧格式与上述以太网V2MAC帧格式的区别：

（1）IEEE802.3规定的MAC帧第三个字段是“长度/类型”，当这个字段值大于0x0600时就表示类型，和以太网V2的MAC帧完全一样，小于时才表示长度。

（2）当“长度/类型”字段值小于0x6000时，数据字段必须装入上面的逻辑链路控制子层的LLC帧。由于现在广泛使用的局域网只有以太网，因此LLC帧已失去意义。现在市场上流行的都是以太网V2标准的MAC帧，但也称为IEEE802.3标准的MAC帧。

3.4 扩展的以太网

扩展的以太网在网络层看来依然是一个网络。

在物理层扩展以太网：

以太网中主机距离不能太远，否则主机发出的信号经过铜线传输会衰减到CSMA/CD协议不能正常工作。

扩展主机和集线器之间距离的简单方法是使用光纤（一对）和一对光纤调制解调器。由于光纤的时延很小而且带宽很宽，该方法可以很容易地使主机和几公里以外的集线器相连接。若使用多个集线器就可连接覆盖成更大范围的多级星形结构的以太网。

优点：更大范围的通信，扩大以太网的覆盖范围。

缺点：独立的**碰撞域**（**冲突域**）再连接后会成为一个冲突域，如果使用不同的以太网技术（如数据率不同），那么就不能用集线器互连。

 

在数据链路层扩展以太网：

最初使用**网桥**，网桥对收到的帧根据其MAC帧的目的地址进行**转发**和**过滤**。

1990年出现**交换式集线器**淘汰了网桥，又称**以太网交换机**或**第二层交换机**，强调其**工作在数据链路层**。

以太网交换机的特点：

实质是一个多接口的网桥，工作方式为全双工方式。以太网交换机具有并行性，能同时连接多对接口，使多对主机同时通信，相互通信的主机都是**独占传输媒体**，**无碰撞地传输数据。**

以太网交换机地接口有存储器，可缓存接收地帧。以太网交换机是一种即插即用设备，内部的帧**交换表**（**地址表**）是通过**自学习**算法自动逐渐建立的。

除了存储转发的方式，有的以太网交换机采用**直通**的交换方式对收到的帧转发。缺点是可能转发无效帧。

以太网交换机的自学习功能使以太网能够即插即用，不必人工配置。

生成树协议STD不改变网络的实际拓扑，但在逻辑上切断了某些链路，使得一个主机到其他所有主机的路径是无环路的树状结构，消除了无限制的兜圈子问题。

从总线以太网到星形以太网，以太网交换机不使用共享总线没有碰撞问题，不适用CSMA/CD协议，而以全双工方式工作。但因它的帧结构未改变，**仍然采用以太网的帧结构**，因此还叫作以太网。

 

利用以太网交换机可以方便实现虚拟局域网VLAN。

VLAN是由一些局域网网段构成的与地理位置无关的逻辑组，而这些网段居于某些共同的需求。虚拟局域网实际只是局域网给用户提供的一种服务，而不是新型局域网。

虚拟局域网限制了接收广播信息的计算机数，使得网络不会因为传播过多的广播信息（即**广播风暴**）引起性能恶化。

虚拟局域网协议在以太网帧格式中插入了一个4字节的标识符，称为VLAN标记，用来指明发送该帧的计算机属于哪个虚拟局域网。插入VLAN标记的帧称为802.1Q帧。

VLAN标记长度为4B，在以太网MAC帧的源地址字段之后，类型字段之前。前2个字节固定，称为**标记类型**。后两个字节中，前3位是用户优先级，第4位是**规范格式指示符****CFI**，最后12位是**VLAN****标识符VID**，唯一标志了帧的所属VLAN。

由于VLAN的以太网帧首部增加了4个字节所以以太网的最大帧长从1518B变为1522B。

3.5 高速以太网

100BASE-T以太网

在双绞线上传送100Mbit/s基带信号的星形拓扑以太网，仍使用CSMA/CD协议，又称**快速以太网**。

10/100Mbit/s以太网都使用无屏蔽双绞线布线。

 

吉比特以太网

特点：

（1）允许在1Gbit/s下以全双工和半双工两种方式工作

（2）使用IEEE802.2协议规定的帧格式

（3）半双工方式下使用CSMA/CD协议，全双工方式下不使用

（4）与10BASE-T和100BASE-T技术向后兼容

吉比特以太网物理层使用两种成熟的技术：一种来自现有以太网，一种来自ANSI制定的**光纤通道****FC**。

 

10吉比特以太网（10GE）和更快的以太网

10GE的以太网帧格式和上述以太网相同，并保留802.3标准规定的以太网最小帧长和最大帧长。只工作在全双工方式，不存在争用问题，因此不使用CSMA/CD协议。

以太网的工作范围已从局域网扩大到城域网和广域网，从而实现了端到端的传输，这种工作方式的好处是：

（1）以太网是一种经过实践证明的成熟技术。

（2）以太网的互操作性很好。

（3）在广域网中使用以太网时，价格低于同步光纤网SONET和异步传递方式ATM。还能适应多种传输媒体，不必重新布线。

（4）端到端的以太网连接使帧的格式全都是以太网的格式，不需要再进行帧的格式转换，简化操作管理。但以太网和其他网络仍需要相应接口才能互连。

 

使用以太网进行宽带接入

以太网接入的一个重要特点是它可以提供双向的宽带通信，并可以根据用户对带宽的需求灵活地升级带宽。

3.6 本章的重要概念

链路是从一个结点到另一个相邻结点的一段物理线路，数据链路则是在链路的基础上增加了一些必要的操作。

数据链路层使用的信道主要有点对点信道和广播信道两种。

数据链路层传送的协议数据单元是帧，三个基本问题是：封装成帧，透明传输和差错检验。

循环冗余CRC是一种检错方法，而帧检验序列FCS是添加在数据后面的冗余码。

点对点协议PPP是数据链路层使用最多的一种协议，它的特点是：简单，只检测差错而不纠正；不使用序号也不使用流量控制；可同时支持多种网络层协议。

PPPoE是为宽带上网的主机使用的链路层协议。

局域网的优点：具有广播功能，从一个站点可很方便的访问全网；便于系统的扩展和逐渐演变；提高了系统的可靠性、可用性和生存性。

共享通信媒体资源的方法有二：一是静态划分信道（各种复用技术），而是动态媒体接入控制，又称为多点接入（随机接入或受控接入）。

IEEE802委员会曾把局域网的数据链路层拆成两个子层，逻辑链路子层（LLC）子层（和传输媒体无关）和媒体接入控制子层（MAC）子层（与传输媒体有关），现在LLC子层已淘汰。

计算机与外界局域网的通信要通过通信适配器（网络适配器），又称为网络接口卡或网卡，计算机的硬件地址就在适配器的ROM中。

以太网采用无连接的工作方式，对发送的数据帧不进行编号，也不要求对方发回确认。目的站收到有差错帧就丢弃，其他什么也不做。

以太网采用的协议是具有冲突检测的载波监听多点接入CSMA/CD。协议的要点是：发送前先监听，边发送边监听，一旦发现总线上出了故障，就立即停止发送。然后按照退避算法等待一段随机时间后再次发送。因此每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网各站点都平等地争用以太网信道。

传统的总线以太网基本都是使用集线器的双绞线以太网，这种以太网在物理上是星形网，逻辑上则是总线网。集线器工作在物理层，它的每个接口仅仅简单地转发比特，不进行碰撞检测。

以太网地硬件地址，即MAC地址实际上就是适配器地址或适配器标识符，与主机所在地地点无关。源地址和目的地址都是48位长。

以太网地适配器有过滤功能，它只接受单播帧，广播帧或多播帧。

使用集线器可以在物理层扩展以太网（扩展后的以太网仍然是一个网络）。

交换式集线器常称为以太网交换机或第二层交换机（工作在数据链路层）。它就是一个多接口的网桥，而每个接口都直接与某台单主机或另一个集线器相连，且工作在全双工方式。以太网交换机能同时连通许多对接口，使每一对相互连通的主机都能像独占通信媒体那也无碰撞地传输数据。

高速以太网有100Mbit/s地快速以太网，吉比特以太网和10Gbit/s地10吉比特以太网。最近还发展到100吉比特以太网。在宽带接入技术中也常使用高速以太网进行接入。

### 网络层

本章最重要的内容是：

（1）虚拟互连网络的概念。

（2）IP地址与物理地址的关系。

（3）传统的分类的IP地址（包括子网掩码）和无分类域间路由选择CIDR。

（4）路由选择协议的工作原理

4.1网络层提供的两种服务

有些人认为应当模仿打电话所使用的面向连接的通信方式，当两台计算机进行通信时，也应当先建立连接（在分组交换中是建立一条**虚电路****VC**），以预留双方通信所需的一切网络资源。然后双方就沿虚电路发送分组，分组首部不需要填写完整的目的主机地址，只需填写虚电路编号（一个不大的整数），因此减小了分组开销。这种通信方式再使用可靠的网络协议就可使发送的分组无差错按序到达终点也不丢失、不重复在通信结束后要释放连接。

互联网的设计者认为计算具有很强的差错处理能力，因此采用了这样的设计思路：**网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报**（即IP数据报或分组）**服务**。

网络在发送分组时不需要先建立连接，每个分组独立发送。网络层不提供服务质量的承诺，因此所传送分组可能出错、丢失、重复和失序，也不保证到达时限。如果主机（端系统）中的进程之间的通信需要的是可靠的，那么就由网络的主机中的运输层负责（差错处理、流量控制等）。

**端系统而不是网络保证可靠交付**

虚电路服务：

（1）可靠通信应由网络层保证。

（2）必须有连接。

（3）终点地址仅在建立连接阶段使用，每个分组使用短的虚电路号。

（4）属于同一条虚电路的分组均按照同一路由转发。

（5）所有出故障的结点的虚电路均不能工作。

（6）分组按序到达。

（7）差错控制和流量控制可以由网络负责，也可以由用户主机负责。

#### 数据报服务：

（1）可靠通信应由用户主机保证。

（2）不要连接。

（3）每个分组都有终点的完整地址。

（4）每个分组独立选择路由转发。

（5）出故障的结点可能会丢失分组，一些路由可能会发生变化。

（6）不一定按序到达。

（7）差错控制和流量控制由主机负责。

4.2 网际协议IP

与IP协议配套的三个协议：

**（1）****地址解析协议ARP**

**（2）****网际控制报文协议ICMP**

**（3）****网际组管理协议IGMP**

逆地址解析协议RARP已被淘汰。

ICMP，IGMP经常要使用IP协议,IP协议经常要使用ARP协议。由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信的，因此TCP/IP体系中的网络层也叫**网际层**或**IP****层**。

 

1. 虚拟互连网络

由于用户需求是多样的，**没有一种单一的网络能适应所有用户的需求**。

将网络互相连接起来要使用一些**中间设备**，根据层次可划分为：

（1）物理层的中间设备叫做**转发器**

（2）数据链路层的中间设备叫做**网桥**或**桥接器**

（3）网络层的中间设备叫**路由器**

（4）网络层以上的中间设备叫**网关**，网关连接不兼容的系统要在高层进行协议转换

由于参加互连的计算机都使用相同的**网际协议**IP**，因此可以把互连后的计算机网络看成一个**虚拟互连网络**，也就是逻辑互联网络，互连起来的各种物理网络的异构性本来是客观存在的，但利用IP协议可以使这些性能各异的网络**在网络层看起来好像是一个统一的网络**。

当源主机H1要把一个IP数据报发送给目的主机H2时，根据分组交换的存储转发概念，H1先查看自己的路由表，如果目的主机就在本网络则采用**直接交付**，如果不是就转发给路由器进行**间接交付**，直到某路由器知道自己是和H2连接在同一个网络上就把数据表**直接交付**给H2。路由器的协议栈只有下三层，**互联网可以由多种异构网络互连组成**。

2. 分类的IP地址

**IP****地址及其表示方法**

整个的互联网就是一个**单一的、抽象的网络**。IP地址就是给互联网的每一台主机（或路由器）的每一个接口分配一个在全世界内范围唯一的32位标识符。IP地址由**互联网名字和数字分配机构****ICANN**分配。

IP地址的方法经过三个阶段：

（1）**分类的IP****地址**。最基本的编址方法。

（2）**子网的划分**。最基本编址方法的改进。

（3）**构成超网**。比较新的无分类编址方法。

所谓分类的IP地址就是将IP地址划分为若干个固定类，其中的A类、B类和C类地址都由两个固定长度的字段组成，其中第一个字段是**网络号**，标志主机或路由器所连接到的网络。一个网络号必须是唯一的。第二个字段是**主机号**，它标志主机或路由器，一台主机号在它前面网络号所指明的网络范围内必须是唯一的。因此一个IP地址**在整个互联网范围内唯一**。

A类、B类和C类地址的网络号字段分别为1个、2个和3个字节长，而在网络号字段的最前面有1-3位的**类别位**，分别规定为0，10和110。

A类、B类和C类地址的主机号字段分别为3个、2个和1个字节长。

D类地址（前4位是1110）用于**多播**（一对多通信）。

E类地址（前4位是1111）保留位以后使用。

IP地址不仅指明主机，还指明了主机所连接的网络。当某个单位申请到一个IP地址时，实际上是获得了具有同样网络号的一块地址。其中各台主机号则由该单位自行分，只要保证在范围内无重复主机号即可。

将32位IP地址的每8位插入一个空格（**机器中并没有**），并用等效十进制数字表示，并在这些数字之间加上一个点，就叫做**点分十进制记法**。

 

**常用的三种IP****地址**

A类地址的网络号字段占1个字节，只有7位可供使用，可指派网络号是126个。减2的原因是：第一，IP地址中全0表示“这个”，是保留地址，意思是本网络。第二，网络号01111111保留作为本地软件**环回测试**本主机的进程之间通信之用。

A类地址的主机号占3个字节，因此每个A类网络中最大主机数是224-2，减2的原因是：全0的主机号表示该IP地址是本主机所连接到的**单个网络地址**，而全1表示**所有的**，即该网络上的所有主机。

IP地址共有232个地址，A类地址共有231个地址，占整个IP地址空间的50%。

B类网络地址的网络号字段有2个字节，但前两位（1 0）已经固定。B类地址的网络数为214-1，从128.1.0.0开始，B类地址的最大主机数是216-2=65534个，减2是因为要扣除全0和全1的主机号，整个B类地址有230个，占整个IP地址的25%。

C类地址有3个字节的网络号段，最前面的3位是（1 1 0），还有21位可分配。C类地址可指派网络总数221-1个，最小从192.0.1.0开始。最大主机数是254个，整个C类地址空间共229个，占整个IP地址空间的12.5%。

IP地址的特点：

（1）每个IP地址都由网络号和主机号两部分组成，从这个意思来说IP地址是一种**分等级的地址结构**。好处：IP管理机构只分配网络号，路由器仅根据目的主机所连接的网络号来转发分组，**减小了路由表所占的存储空间和查找路由表的时间**。

（2）IP地址是标志一台主机或路由器和一条链路的**接口**。当一台主机同时连到两个网络上该主机就必须具有两个相应的IP地址，称为**多归属主机**。一个路由器至少应当连接到两个网络，因此一个路由器至少应有两个不同的IP地址。

（3）一个网络是指具有相同网络号的主机的集合，**因此用转发器或网桥连接起来的若干个局域网仍为一个网络**。

（4）所有分配到网络号的网络都是**平等**的。

同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的。

当两个路由器直接相连时，可以分配也可以不分配IP地址，如分配了IP地址，这样的特殊网络就叫**无编号网络**或**无名网络**。

 

3. IP地址与硬件地址

**物理地址是数据链路层和物理层的地址**，**IP****地址是网络层及其之上各层的地址**，是一种**逻辑地址**。

IP地址放在IP数据报的首部，而硬件地址放在MAC帧的首部。

**在IP****层抽象的互联网上只能看到IP****数据报**。

虽然在IP数据报首部有源站IP地址，但**路由器只根据目的站的****IP****地址的网络号进行路由选择**。

**在局域网的链路层，只能看到MAC****帧**。MAC帧在不同网络传送时，其首部的源地址和目的地址也要变化。

尽管互连在一起的网络的硬件地址体系各不相同，**但****IP****层抽象的互联网却屏蔽了下层这些复杂细节**。

 

4.地址解析协议ARP

地址解析协议ARP用来寻找已知IP地址主机的硬件地址。

ARP在主机ARP高速缓存中存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）。

每一台主机都设有一个**ARP****高速缓存**，里面有**本局域网**上的各主机和路由器的IP地址到硬件地址的映射表，这些都是该主机目前知道的一些地址。

当主机A要向本地局域网的某台主机B发送IP数据报时，先在其ARP高速缓存查看有无主机B的IP地址，如有就在ARP高速缓存中查出其对应的硬件地址再把它写入MAC帧，通过局域网把MAC帧发往此硬件地址。

若差不到主机B的IP地址，主机A就自动运行ARP，然后按以下步骤查出主机B的IP地址：

（1）ARP进程在本局域网上广播发送一个ARP请求分组，ARP分组的主要内容是：我的IP地址是...，我的硬件地址是...，我想知道IP地址为...的硬件地址。

（2）在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组。

（3）主机B的IP地址与ARP请求分组中要查询的IP地址一致，收下这个ARP请求分组，并向主机A发送ARP响应分组。ARP响应分组的主要内容是：我的IP地址是...，我的硬件地址是...。ARP请求分组是广播，但响应是单播。

（4）主机A收到ARP响应后，在ARP高速缓存中写入主机B的IP地址到硬件地址的映射。

为减小网络通信量，当A发送其ARP请求时就把自己的IP地址到硬件地址的映射写入ARP请求分组，B收到后将其写入自己的ARP高速缓存。

ARP对保存在高速缓存中的每一个映射地址项目都设置**生存时间**，超过生存时间的项目将被删除。ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题，若不在一个局域网上就无法解析。

从IP地址到硬件地址的解析是自动进行的，**主机的用户对这种过程是不知道的**。

由于全世界存在各种网络，它们使用不同的硬件地址。要使这些异构网络能相互通信就必须进行**非常复杂的硬件地址转换**工作，IP编址解决了此问题，因此不直接用硬件地址而额外使用抽象的IP地址。

 

\5. IP数据报的格式

一个IP数据报由首部和数据两部分组成，首部的前一部分是**固定长度**，共20字节，是所有IP数据报必须具有的。在首部的固定部分的后面是一些**可选字段**，长度可变。

**IP****数据报首部固定部分中的各字段**

（1）**版本** 占4位，指IP协议的版本。通信双方所用版本必须一致。

（2）**首部长度** 占4位 

（3）**区分服务** 占8位，在旧标准中叫做**服务类型**，一般情况不使用

（4）**总长度** 指首部和数据长度之和，16位，因此数据报的最大长度为216-1为65535字节。在进行分片时，数据报首部中的总长度字段是指分片后的每一个分片的首部长度与该分片的数据长度之和。

（5）**标识** 占16位，IP软件在存储器中维持一个计数器，每产生一个数据报，计数器加1，并将此值赋给标识字段。当数据报长度由于超过MTU而必须分片后，标识字段的值就被复制到所有的数据报片的标识字段，相同标识字段的值使分片后的各数据报片最后能正确地重装为原有的数据报。

（6）**标志** 占3位，只有2位有意义。最低位**MF**，1表示还有分片，0表示无。中间一位记作**DF**，意思是**不能分片**，DF=0时才允许分片。

（7）**片偏移** 占13位，较长的分组在分片后，某片在原分组中地相对位置。除最后一个数据报片外，每个分片地长度一定是8字节的整数倍。

（8）**生存时间** 占8位 常用英文缩写TTL，表明数据报在网络中的寿命。每经过一个路由器就减去其消耗的时间，为0时丢弃。

后来功能改为“**跳数限制**”（但**名称不变**），现在TTL的单位不是秒而是**跳数**。数据报能在互联网中经过的路由器最大数值为255，若初值设1则只能在本局域网传送。

（9）**协议** 占8位 指出此数据报携带的数据使用何种协议，以便使目的主机IP层知道应该将数据上交给哪个协议处理。

（10）**首部检验和** 占16位，只**检验数据报的首部不包括数据部分**，主要使用反码。

（11）**源地址** 占32位。

（12）**目的地址** 占32位。

**IP****数据报首部的可变部分**

用来支持排错、测量以及安全等措施，内容丰富。

 

\6. IP层转发分组的流程

在路由表中，对每一条路由最主要的是以下两个信息：（**目的网络地址**，**下一跳地址**）。

IP数据报最终一定可以找到目的主机所在目的网络上的路由器（可能需要通过多次间接交付）。只有到达最后一个路由器时，才试图向目的主机进行直接交付。

虽然互联网上所有的分组转发都是基于**目的主机所在的网络**，但在大多数情况下都允许有这样的特例，即对特定的目的主机指明一个路由，这种路由叫做**特定主机路由**。

路由器还可采用**默认路由**以减小路由表所占空间和搜索路由表所用的时间。

当路由器收到一个待转发的数据报，在从路由表中得出下一跳路由器的IP地址后，不是把这个地址填入IP数据报，而是交送数据链路层的网络接口软件。网络接口软件把下一跳路由器的IP地址转换成硬件地址（必须使用ARP），并将此硬件地址放在链路层MAC帧的首部，然后根据这个硬件地址找到下一跳路由器。

归纳**分组转发算法**如下：

（1）从数据报首部提取出目的主机的IP地址D，得出目的网络地址N。

（2）若N就是与此路由器直接相连的某网络，则直接交付，否则间接交付，执行（3）。

（3）若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器，否则执行（4）。

（4）若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器，否则执行（5）。

（5）若路由表有默认路由，则把数据报传送给路由表中所指明的默认路由器，否则执行（6）。

（6）报告转发分组出错。

4.3划分子网和构造超网

划分子网

**1.** **从两级IP****地址到三级IP****地址**

早期IP地址设计不合理处：

（1）**空间利用率有时很低**。

（2）给每一个物理网络分配一个网络号**会使路由表变得太大**而降低网络性能。

（3）**两级IP****地址不灵活**。

为解决上述问题，1985年起在IP地址中增加了一个“**子网号字段**”，这种做法叫做**划分子网**，或**子网寻址**或**子网路由选择**。划分子网已成为互联网正式标准协议。

划分子网的基本思想：

（1）一个拥有许多物理网络的单位，可将所属物理网络划分为若干**子网**。划分子网纯属一个单位内部的事情，本单位以外的网络**看不见**这个网络是由多少个子网组成，因为这个单位**对外仍表现为一个网络**。

（2）从网络的主机号借用若干位作为子网号，当然主机号就相应地减少同样的位数。于是两级IP地址在**本单位内部**就变为三级IP地址：网络号，子网号和主机号。

（3）凡是从其他网络发送给本单位某台主机的IP数据报，仍然是根据IP数据报的目的网络号找到连接在本单位网络上的路由器。但此路由器收到IP数据报后，再按目的网络号和子网号找到目的子网，把IP数据报交付目的主机。

**2.** **子网掩码**

从IP数据报的首部**无法看出**源主机或目的主机所连接的网络是否进行了子网划分，因此需要使用**子网掩码**。

使用子网掩码的好处：不管网络有没有划分子网，只要把子网掩码和IP地址进行逐位的**与**运算，就立即得出网络地址来。

如果一个网络不划分子网，那么该网络的子网掩码就使用默认的子网掩码。

A类地址的默认子网掩码是255.0.0.0。

B类地址的默认子网掩码是255.255.0.0。

C类地址的默认子网掩码是255.255.255.0。

子网掩码是一个网络或一个子网的重要属性。路由器在和相邻路由器交换路由信息时，必须把自己所在的网络或子网的子网掩码告诉相邻路由器。

在采用固定长度子网划分时，所划分的**所有**子网掩码的子网掩码都是相同的。子网号不能为全1或全0，但随着无分类域间路由CIDR的广泛使用，现在全1和全0的子网号也能使用了。划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。

同样的IP地址和不同的子网掩码可以得出相同的网络地址。但是不同的掩码效果是不同的。

 

使用子网时分组的转发

使用子网划分后，路由表必须包含以下三项内容：**目的网络地址**、**子网掩码**和**下一跳地址**。

划分子网的情况下，路由器转发分组的算法如下：

（1）从收到的数据报首部提取目的IP地址D。

（2）先判断是否直接交付。对路由器直接相连的网络逐个检查，用子网掩码与D进行与运算，看结果是否和相应的网络地址匹配。若匹配直接交付，否在就是间接交付，执行3。

（3）若路由表中有目的地址为D的特定主机路由，就把数据报传送给路由表中指明的下一跳路由器，否则执行4。

（4）对路由表每一行，用其中的子网掩码和D逐位与，结果为N。如果N与该行目的地址网络适配，则把数据报传送给改行指明的下一跳路由器，否则执行5。

（5）若路由表有默认路由，则传送给默认路由器，否则报告转发分组错误。

 

无分类编址CIDR

\1. 网络前缀

1992年互联网面临的问题：

（1）B类地址已分配近一半。（2）互联网主干上路由表项目数急剧增长。（3）整个IPv4的地址空间最终将全部耗尽。

IETF研究出**无分类编址**的方法解决前两个问题。它的正式名字时**无分类域间路由选择****CIDR**。

CIDR最主要的特点：

（1）**消除了传统的A****类、B****类、C****类地址以及划分子网的概念**，因而能更有效的分配IPv4的地址空间，并在新的IPv6使用之前容许互联网规模继续增长。CIDR把32位IP地址划分为前后两部分，前面是**网络前缀**，用来指明网络，后面用来指明主机。因此CIDR使IP地址从三级编址又回到了两级编址（**无分类的两级编址**）。

使用**斜线记法**，或称**CIDR****记法**，即在IP地址后加上斜线，写上网络前缀所占位数。

（2）CIDR把**网络前缀相同**的连续IP地址组成一个CIDR地址块，只要知道地址块中任何一个地址就能知道其中的起始地址和最大地址，以及地址块数。

为方便路由选择，CIDR使用32位的**地址掩码**。地址掩码由一串1和一串0组成，1的个数是网络前缀的长度，也可继续称为子网掩码。斜线记法中，**斜线后面的数字就是地址掩码中的****1****的个数**。

由于一个CIDR地址块中有很多单位，所以路由表就利用CIDR地址块来查找目的网络，这种地址的聚合常称为**路由聚合**，也称为**构成超网**。

**网络前缀越短，其地址块所包含的地址数就越多**。而在三级结构的IP地址中，划分子网是使网络前缀变长。

 

\2. 最长前缀匹配

使用CIDR时，路由表中的每个项目由**网络前缀**和**下一跳地址**组成。但在查找路由表时**可能会得到不止一个匹配结果**。**应当从匹配结果中选择具有最长网络前缀的路由**，这叫做**最长前缀匹配**，因为网络前缀越长，地址块就越小，因而路由就越具体。最长前缀匹配又称**最长匹配**或**最佳匹配**。

 

**3.** **使用二叉线索查找路由表**

为了进行更有效的查找，最常用的是二叉线索。为了简化二叉线索的构造，可以先找出对应于每一个IP地址的唯一前缀。

二叉线索只是提供了一种可以快速在路由表中找到匹配的叶节点的机制，但这是否和网络前缀匹配，还要和子网掩码进行一次逻辑与的运算。

为提高二叉线索的查找速度，广泛使用了各种压缩技术。

 

4.4网际控制报文协议ICMP

为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP。ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告，不是高层协议，作为IP层数据报的数据，加上数据报的首部，组成IP数据报。

ICMP报文的种类有两种，即**ICMP****差错报告报文**和**ICMP****询问报文**。

ICMP的前四个字节是统一的格式，共有三个字段：类型、代码和检验和。接着的4个字节的内容与ICMP的类型有关，最后面是数据字段，长度取决于ICMP的类型。

ICMP差错控制报文共有四种，即：

（1）**终点不可达** 当路由器或主机不能交付数据时就向源点发送此报文

（2）**时间超过** 当路由器收到生存时间为0的数据报时，除丢弃该数据报外还要向源点发送该报文。当终点在预先规定时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送此报文。

（3）**参数问题** 当路由器或目的主机收到的数据报的首部中有的字段不正确时，就丢弃该数据报，并向源点发送此报文。

（4）**改变路由**（**重定向**） 路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

所有的ICMP差错报文报告中的数据字段都具有相同格式，把收到的需要进行差错报告的IP数据报的首部和数据字段的前8个字节提取出来，作为ICMP报文的数据字段，再加上ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文。

下面是不应发送ICMP差错报告报文的情况：

（1）对ICMP差错报告报文，不再发送

（2）对第一个分片的数据报片的所有后续数据报片，都不发送

（3）对具有多播地址的数据报，都不发送

（4）对具有特殊地址的数据报，不发送

常用的ICMP询问报文有两种：

（1）**回送请求和回答** ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的目的主机必须给源主机或路由器发送ICMP回送回答报文，这种询问报文用来测试目的站是否可达以及了解其有关状态。

（2）**时间戳请求和回答** ICMP时间戳请求报文是请某台主机或路由器回答当前的日期和时间。用于时钟同步和时间测量。

 

ICMP的一个重要应用就是分组网间探测**PING**（Packet Internet Groper），用来测试两台主机之间的连通性。PING使用了ICMP回送请求和回送回答报文。PING是应用层直接使用网络层ICMP的一个例子，没有通过运输层的TCP或UDP。

Windows操作系统的用户在命令提示行输入ping+主机名或ip地址就可测试连通性。

例PING一个服务器时，PC一连发出4个ICMP回送请求报文，如果服务器正常工作而且响应这个ICMP回送请求报文（有的主机为防止恶意攻击而不理睬外界发送的这种报文），那么它就发回ICMP回送回答报文。由于往返的ICMP报文上都是时间戳，因此很容易得出往返时间。最后显示出的是统计结果：发送到哪个机器（IP地址），发送的、收到的和丢失的分组数（但不给出分组丢失原因）以及往返时间的最小值、最大值和平均值。

另一个非常有用的应用是traceroute（这是UNIX系统中的名字），它用来跟踪一个分组从源点到终点的路径，在Windows中这个命令是tracert。

原理：Traceroute从源主机向目的主机发送一连串的IP数据报，数据报中封装的是无法交付的UDP用户数举报（因为使用了非法端口号）。第一个数据报的TTL设为1，当其到达路径上第一个路由器时，路由器先收下它，接着把TTL减1，由于TTL=0，路由器丢弃数据报并向源主机发送一个**ICMP****时间超过**差错报告报文。

接着源主机发送第二个数据报，并把TTL设为2...以此类推直到最后一个数据报刚到达目的主机时，数据报的TTL=1，主机不转发数据报也不把TTL减1，但因为IP数据报中封装的时无法交付的运输层的UDP数据报，因此目的主机要向源主机发送**ICMP****终点不可达**差错报告报文。这样源主机就知道了路由信息——到达目的主机所经过的路由器的IP地址以及到达其中每个路由器的往返时间。每一行有3个时间出现是因为对应于每个TTL，源主机要发送三次同样的IP数据报。

 

4.5 互联网的路由选择协议

理想的路由算法特点：

（1）**算法必须是正确的和完整的**。正确指沿着各路由表所指引的路由，分组一定能最终到达目的网络和目的主机。

（2）**算法在计算上应简单**，不应使网络通信量增加太多额外开销。

（3）**算法能适应通信量和网络拓扑的变化**，要有**自适应性**。有时称这种自适应性为稳健性。

（4）**算法应具有稳定性**，网络通信量和拓扑稳定时不应使路由不停变化。

（5）**算法应公平**。

（6）**算法应是最佳的**，找到最好的路由使分组平均时延最小而网络吞吐量最大。

若从路由算法能否随网络的通信量或拓扑自适应地进行调整变化来划分，则只有两大类，即**静态路由选择策略**（非自适应路由选择）和**动态路由选择策略**（自适应路由选择）。

 

分层次的路由选择协议

互联网采用的路由选择协议主要是自适应的（动态的）、分布式路由选择协议，主要因为：

（1）互联网规模非常大，如果让所有路由表知道所有网络应怎样到达，开销太大。

（2）许多单位不愿意外界了解自己网络的布局细节和采用的路由选择协议但又希望连接互联网。

为此可把互联网划分为许多较小的**自治系统**AS。AS是在单一技术管理下的一组路由器，而这些路由器使用一种自治系统内部的路由选择协议和共同的度量。一个AS对其他AS表现出的是一个**单一的和一致的路由选择策略**。

目前的互联网中，一个大的ISP就是一个自治系统。这样，互联网就把路由选择协议划分为两大类：

（1）**内部网关协议IGP** 包括RIP和OSPF协议

（2）**外部网关协议EGP** 目前使用最多的外部网关协议是BGP

自治系统之间的路由选择叫**域间路由选择**，而在自治系统内部的路由选择叫**域内路由选择**。

 

内部网关协议RIP

RIP是内部网关协议IGP中最先得到广泛使用的协议，中文名为路由信息协议，但很少使用。RIP是一种分布式的**基于距离向量**的路由选择协议，最大优点是简单。

RIP协议要求网络中每一个路由器都要维护从它自己到其他每个目的网络的距离记录（这**一组距离**即**距离向量**）。距离定义如下：

从路由器到直接相连的网络距离为1，从路由器到非直接相连的网络距离为经过的路由器数加1。RIP的距离也成为跳数，RIP允许一条路径最多只能包含15个路由器，因此距离等于16时相当于不可达，因此**RIP****只适用于小型互联网**。

RIP协议的特点：

（1）**仅和相邻路由器交换信息**。

（2）路由器交换的信息是**当前本路由器知道的全部信息**，**即自己现在的路由表**。

（3）**按固定时间间隔交换路由信息**。

路由表中最主要的信息就是：到某个网络的距离（最短距离），以及应经过的下一跳地址。路由表更新的原则是找出到每个目的网络的**最短距离**，这种更新算法又称**距离向量算法**。

距离向量算法，基础是Bellman-Ford算法或Ford-Fulkerson算法。

步骤：

（1）对地址X的相邻路由器发来的RIP报文，先修改此报文中的所有项目，把下一跳地址改为X，并把所有距离加1。每个项目都有三个关键数据，目的网络N，距离d，下一跳地址X。

（2）对修改后的项目，若路由表没有目的网络N则添加，若有且下一跳地址是X则替换，若有且下一跳地址不是X，如果d小于原来的距离则更新，否则什么也不做。

（3）3分组内没收到相邻路由表的更新路由表，则记为不可达，即设置距离16。

（4）返回。

RIP协议使得从**每一个路由到每一个目的网络的路由都是最短的**。

RIP2支持变长子网掩码和无分类域间路由选择CIDR，还提供简单鉴别支持多播。RIP协议使用UDP进行传送（UDP端口520）。

RIP报文由首部和路由组成。

RIP2报文中的路由部分由若干路由信息组成，每个路由信息需要用20字节。**地址族标识符**（又称**地址类别**）字段用来标志所使用的地址协议。路由标记填入**自治系统号****ASN**，这是考虑使RIP有可能收到本自治系统外的路由选择信息。再后面指出某个**网络地址**、该网络的**子网掩码**、**下一跳路由器地址**以及**到此网络距离**。一个RIP报文最多包括25个路由，因而RIP报文最大长度504字节。

RIP问题：当网络故障时，要经过比较长的时间才能将信息传送到所有路由器。这一特点叫：**好消息传播得快，坏消息传播得慢**。总之RIP协议最大的优点就是**实现简单**，**开销较小**，缺点也较多，限制了网络规模，对于规模较大的网络应使用OSPF协议。

 

内部网关协议OSPF

这个协议的名字是**开放最短路径优先****OSPF**，为克服RIP缺点开发。**开放**表明OSPF协议不是受一家厂商控制，而是公开发表。**最短路径优先**是因为使用了**Dijkstra****提出的最短路径算法SPF**。

主要特征：使用分布式的链路状态协议，而不是RIP那样的距离向量协议。

（1）向本自治系统的**所有路由器**发送信息，用的是**洪泛法**。

（2）发送的信息就是与本路由器**相邻的所有路由器的链路状态**，这只是路由器知道的部分信息。链路状态就是说明本路由器都和哪些路由器相邻，以及该链路的**度量**（费用、距离、时延、带宽等）。

（3）只有当链路状态**发生变化**时，路由器才向所有路由器用**洪泛法**发送此信息。

由于各路由器之间频繁交换链路信息，因此所有路由器最终都能建立一个**链路状态数据库**，实际上就是**全网的拓扑结构图**。RIP协议的每个路由器虽然知道到所有网络的距离以及下一跳路由器，但不知道全网的拓扑结构。OSPF的链路状态数据库能较快更新，使各路由器及时更新路由表，OSPF的更新过程收敛得快是其重优点。

为使OSPF能够用于大型网络，OSPF将一个自治系统划分为若干**区域**。OSPF使用**层次结构的区域划分**，在上层的区域叫**主干区域**，作用使连通其他下层区域，从其他区域来的信息都由**区域边界路由器**进行概括。在主干区域内的路由器叫**主干路由器**，一个主干路由器可以同时是多个区域边界路由器。在主干区域还有一个路由器专门和本自治系统之外的其他自治系统交换路由信息，叫做**自治系统边界路由器**。

OSPF不用UDP而是直接用IP数据报传送（IP数据报首部协议字段值89）。OSPF分组使用24字节的固定首部长度，分组的数据部分可以是五种类型分组中的一种。

OSPF首部各字段的意义：

（1）**版本** 当前版本号为2

（2）**类型** 五种类型分组中的一种

（3）**分组长度** 包括OSPF首部在内的分组长度，以字节为单位

（4）**路由器标识符** 标志发送该分组的路由器的接口的IP地址

（5）**区域标识符** 分组属于的区域

（6）**检验和** 用来检验分组中的差错

（7）**鉴别类型** 0（不用）和1（口令）

（8）**鉴别** 鉴别类型为0时填入0，为1时填入8个自负的口令

OSPF的其他特点：

（1）对于不同类型的业务可计算不同的路由，链路代价为1-65535

（2）如果到同一个目的网络有多条相同路径，那么可以将通信量分配给这几条路径，这叫做**多路径间的负载平衡**。

（3）所有在OSPF路由器之间交换的分组都具有鉴别的功能。

（4）OSPF支持可变长度的子网划分和CIDR。

（5）OSPF让每个链路状态都带上一个32位的序号，序号越大状态越新。

OSPF的五种分组类型:

（1）类型1，**问候分组**。

（2）类型2，**数据库描述分组**。

（3）类型3，**链路状态请求分组**。

（4）类型4，**链路状态更新分组**。

（5）类型5，**链路状态确认分组**。

 

外部网关协议BGP

1989年公布了新的外部网关协议——边界网关协议BGP。

内部网关协议主要设法使数据报在一个AS中尽可能有效从源站传送到目的站，在一根AS内也不需要考虑其他方面策略。然而BGP使用环境不同，主要因为：

（1）互联网规模太大，使得自治系统AS之间路由选择非常困难。

（2）自治系统AS之间的路由选择必须考虑有关策略。

由于上述情况，边界网关协议BGP只能力求寻找一条能够到达目的网络且**比较好**的路由，而**并非寻找一条最佳路由**。BGP采用了**路径向量路由选择协议**。

配置BGP时，每个AS管理员要选择至少一个路由器作为该AS的BGP发言人，一般来说，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是**BGP****边界路由器**，但也可以不是。

一个BGP发言人与其他AS的BGP发言人要交换路由信息就要先建立TCP连接（端口号179），然后在此连接上交换BGP报文以建立**BGP****会话**，利用BGP会话交换路由信息。使用TCP连接能提供可靠服务，也简化了路由选择协议。使用TCP连接交换路由信息的两个BGP发言人彼此成为对方的**临站**或**对等站**。

BGP所交换的网络可达性的信息就是要到达某个网络所要经过的一系列自治系统，当BGP发言人相互交换了网络可达性信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各自治系统的较好录由。

BGP协议交换路由信息的结点数量级时**自治系统个数**的量级，要比自治系统的**网络数**少很多。

BGP支持无分类域间路由选择CIDR，因此BGP的路由表也应当包括目的网络前缀、下一跳路由器以及到达该目的网络所要经过的自治系统序列。

BGP的四种报文：

（1）OPEN打开报文，用来与相邻的另一个BGP发言人建立关系，通信初始化。

（2）UPDATE 更新报文，用来通告某一路由的信息以及列出要撤销的多条路由。

（3）KEEPALIVE保活报文，用来周期性证实临站的连通性。

（4）NOTIFICATION通知报文，用来发送检测到的差错。

四种类型的BGP报文具有同样的通用首部，长度19字节。通用首部分为三各字段。标记字段16字节，用来鉴别收到的BGP报文，当不使用鉴别时，标记字段置为全1。长度字段指出包括通用首部在内的整个BGP报文以字节为单位的长度，最小值19，最大值4096。类型字段的值1-4。

OPEN报文有6个字段，即版本（1字节，当前值4）、本自治系统（2字节）、保持时间（2字节）、BGP标识符（2字节）、可选参数长度和可选参数。

UPDATE报文共有5个字段，即不可行路由长度（2字节）、撤销的路由、路径属性总长度（2字节）、路径属性和网络层可达性NLRI。

KEEPALIVE报文只有BGP的19字节长的通用首部。

NOTIFICATION报文有3个，即差错代码（1字节）、差错子代码（1字节）和差错数据。

 

路由器的构成

路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。路由器的转发分组是网络层的主要工作。路由器的结构可划分为两部分：**路由选择**部分和**转发分组**部分。

路由选择部分也叫**控制部分**，其核心构件是路由选择处理机。路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期和相邻路由器交换路由信息而不断地更新和维护路由表。

分组转发部分由三部分组成：**交换结构**、一组**输入端口**和一组**输出端口**。这里的端口指硬件接口。

交换结构又称为**交换组织**，它的作用是根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。可将交换结构看成在路由器中的网络。

**转发**就是路由器根据转发表把收到的IP数据报从路由器的合适端口转发出去，仅仅涉及一个路由器，但**路由选择**涉及到很多路由器，路由表则是多个路由器协同工作的结果。路由表一般仅包含从目的网络到下一跳的映射，而转发表是从路由表得出的。路由表总是用软件实现的，但转发表则甚至可用特殊的硬件实现。**当讨论路由选择原理时，往往不去区分转发表和路由表的分别**。

若分组处理的速率赶不上分组进入的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。以前所提的分组丢失就是发生在路由器的输入或输出队列产生溢出的时候。设备或线路故障也可能使分组丢失。

交换结构是路由器的关键构件，正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。实现这样的交换有多种方法。

（1）最早使用的路由器就是利用普通计算机，用计算机的CPU作为路由器的路由选择处理机。许多现代的路由器也通过存储器进行交换，与早期路由器的区别是，目的地址的查找和分组在存储器中的缓存都是在输入端口中进行的。

（2）通过总线进行交换，采用这种方式时，数据报从输入端口通过共享总线直接传送到合适的输出端口，而不需要路由选择处理机的干预。

（3）通过纵横交换结构进行交互，这种交换结构常称为**互连网络**，它有2N条总线，可以使N个输入端口和N个输出端口相连接，这取决于相应的交叉结点是使水平总线和垂直总线接通还是断开。输入端口将收到的分组发送到与输入端口相连的水平总线，若垂直总线空闲就将其与水平总线连通并转发到输出端口，否则在输入端口排队。

4.6 IPV6

解决IP地址耗尽的根本措施就是采用具有更大地址空间的新版本的IP，即IPV6。

IPv6仍支持无连接的传送，但将协议数据单元PDU称为分组，而不是IPv4的数据报。

IPv6的主要变化：

（1）**更大的地址空间**，从IPv4的32位增大到128位。

（2）**扩展的地址层次结构**。

（3）**灵活的首部格式**。IPv6数据报的首部和IPv4不兼容。

（4）**改进的选项**。IPv6允许数据报包含有选项的控制信息，但IPv6的首部长度是固定的。

（5）**允许协议继续扩充**。

（6）支持即插即用（自动配置）。不需要使用DHCP。

（7）**支持资源的预分配**。

（8）IPv6的首部改为**8****字节对齐**（即首部长度必须是8字节的整数倍）。

IPv6数据报由两大部分组成，即**基本首部**和后面的**有效载荷**（净负荷），有效载荷允许有零个或多个**扩展首部**，再后面是数据部分。

与IPv4相比，IPv6对首部的某些字段进行了如下更改：

（1）取消了首部长度字段，因为它的首部长度固定为40字节

（2）取消了服务类型字段

（3）取消了总长度字段

（4）取消了标志、标识和片偏移字段

（5）把TTL字段改为限制条数字段，功能不变

（6）取消了协议字段

（7）取消了检验和字段，加快了路由器处理数据报的速度

（8）取消了选项字段

IPv6首部中各字段的作用：

（1）**版本** 4位，指明协议版本，值为6

（2）**通信量类** 8位，为了区分不同IPv6数据报的类别或优先级

（3）**流标号** 20位，IPv6提出**流**的抽象概念，所谓**流就是互联网上从特定源点到特定终点（单播或多播）的一系列数据报（如实时音频或视频传输），而在这个流所经过的路径上的路由器都保证指明的服务质量**。属于同一个流的数据报都具有同样的流标号。

（4）**有效载荷长度** 16位，指明IPv6数据报除基本首部以外的字节数，最大值64KB。

（5）**下一个首部** 8位，相当于IPv4的协议字段或可选字段。当没有扩展首部时，下一个首部字段的作用和IPv4的协议字段作用一样，6代表交付运输层TCP，17代表交付UDP。

出现扩展首部时，下一个首部字段的值标识后面第一个扩展首部的类型。

（6）**跳数限制** 8位，防止数据报在网络无限期存在，最大跳255。

（7）**源地址** 128位，数据报发送端的IP地址。

（8）**目的地址** 128位，数据报接收端的IP地址。

IPv6把原来IPv4首部中选项的功能都放在扩展首部，并把扩展首部留给路径两端的源点和终点的主机处理，而数据报途径中经过的**路由器都不处理这些扩展首部**（除了逐跳选项扩展首部），大大**提高了路由器的处理效率**。

RFC2460定义了以下6种扩展首部：（1）逐跳选项（2）路由选择（3）分片（4）鉴别（5）封装安全有效载荷（6）目的站选项

 

IPv6的地址是以下三种之一：

（1）**单播** 传统的点对点通信

（2）**多播** 一点对多点的通信，数据报发送到一组计算机中的而每一个，IPv6没有采用广播的术语，而是将广播看作多播的一个特例

（3）**任播** 终点是一组计算机，但数据报只交付其中一个，通常是距离最近的一个。

IPv6把实现IPv6的主机或路由器均称为结点。

 

向IPv6过渡只能采取逐步演进的办法，同时还必须使新安装的IPv6系统能够向后兼容。这就是说IPv6系统必须能够接收和转发IPv4分组，并且能够为IPv4分组选择路由。

向IPv6过渡的策略：

**（1）****双协议栈**

是指在完全过渡到IPv6之前使一部分主机或路由器装有双协议栈：一个IPv4和一个IPv6。它使用域名系统DNS来查询目的主机使用的IP地址类型。

**（2）****隧道技术**

这种方法的要点就是在IPv6数据报要进入IPv4网络时，把IPv6数据报封装称IPv4数据报，要使双协议栈的主机知道IPv4数据报里封装的是一个IPv6数据报就必须把IPv4首部的协议字段值设为41。

 

和IPv4一样，IPv6也不保证数据报的可靠交付，它也需要使用ICMP来反馈一些差错信息，新的版本称为ICMPv6，它比ICMPv4要复杂许多，地址解析协议ARP和网际组管理协议IGMP的功能都已被合并到ICMPv6中。

4.7 IP多播

与单播相比，在一对多的通信中，多播可大大节约网络资源。

在互联网范围的多播要靠路由器实现，这些路由器必须增加一些能够识别多播数据报的软件，能够运行多播协议的路由器称为**多播路由器**。

在互联网上进行多播就叫IP多播。IP多播所传送的分组需要使用多播IP地址。

在多播数据报的目的地址写入的是多播组的标识符，然后设法让加入这个多播组的主机IP地址与多播组的标识符关联起来。其实多播组的标识符就是IP地址中的D类地址。D类地址范围是224.0.0.0到239.255.255.255，用每一个D类地址标志一个多播组。多播数据报和一般IP数据报的区别是它使用D类IP地址作为目的地址，并且首部中的协议字段值为2，表明使用网际管理组协议IGMP。

**多播地址只能用于目的地址，而不能用于源地址**。对多播报文不产生ICMP差错报文，因此若在PING命令后键入多播地址将永远不会收到响应。

IP多播分为两种：（1）在本局域网上进行硬件多播（2）在互联网范围进行多播。前一种虽然简单但很重要，因为现在大部分主机都是通过局域网接入互联网。在互联网上进行多播的最后阶段还是要把多播数据报在局域网上用硬件多播交付多播组的所有成员。

IP多播需要两种协议

（1）网际组管理协议IGMP

工作可分为两阶段：

第一阶段：当某台主机加入新的多播组时，该主机向多播组的多播地址发送一个IGMP报文，声明自己要成为该组的成员。本地的多播路由器收到IGMP报文后，还要利用多播路由选择协议把这种组成员关系转发给互联网上的其他多播路由器。

第二阶段：组成员关系是动态的，本地多播路由器要周期性地探寻本地局域网上的主机，以便知道这些主机是否还继续是组的成员。只要有一台主机对某个组响应，那么多播路由器就认为这个组是活跃的。但一个组在多次探询后仍然没有一台主机响应，多播路由器就认为本网络上的主机都离开了这个组，也就不再转发组关系至其它多播路由器。

（2）多播路由选择协议

在多播过程中一个多播组中的成员是动态变化的。多播路由实际上就是要找出以源主机为根节点的**多播转发树**。

转发多播数据报时用到了三种方法：（1）**洪泛与剪除**。适合于小的多播组，而所有组成员接入的局域网也是相邻的。为了避免兜圈子，采用了**反向路径广播****RPB****。**（2）**隧道技术**，适用于多播组的位置在地理上很分散的情况。（3）基于核心的发现技术，这种方法对于多播组的大小在较大范围内变化时都适合。

 

4.8 虚拟专用网VPN和网络地址转换NAT

假定一个机构内部的计算机通信也采用TCP/IP协议，那么这些仅在机构内部使用的计算机就可以由本机自行分配其IP地址，这就是说让这些计算机使用仅在本机构内有效的IP地址（本地地址）而不需要向互联网的管理机构申请全球唯一的IP地址（全球地址），这样可大大节约IP地址资源。

**在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发**。

2013年4月，RFC6890给出了所有特殊用途的IPv4地址：

（1）10.0.0.0到10.255.255.255 即10.0.0.0/8

（2）172.16.0.0到172.31.255.255 即172.16.0.0/12

（3）192.168.0.0到192.168.255.255 即192.169.0.0/16

采用这样的专用IP地址的互连网洛称为**专用互联网**或**本地互联网**，或**专用网**。专用IP地址也叫做**可重用地址**。

机构利用公用的互连网作为本机构各专用网之间的通信载体，这样的专用网叫做**虚拟专用网****VPN**。之所以叫专用网是因为这种网络时为本机构的主机用于机构内部的通信，而不适用于和网络外费本机构的主机通信。如果专用网不同网点间通信必须经过公用互联网，但又有保密要求，那么**所有通过互联网传送的数据都必须加密**。虚拟表示好像时，但实际上不是，因为现在并没有真正使用通信专线，而VPN只是在**效果上**和真正专用网一样。

VPN类型：内联网、外联网（内联网和外联网都基于TCP/IP）、远程接入

 

网络地址转换NAT

这种方法需要在专用网连接到互联网上的路由器安装NAT软件，装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。这样所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和互联网通信。

通过NAT路由器的通信必须由专用网内的主机发起，专用网内的主机不能充当服务器，因为互联网上的客户无法请求专用网内的服务器提供服务。为更加有效利用NAT路由器上的IP地址，现在常用的NAT转换表把运输层的端口号也加上，这样就可使多个拥有本地地址的主机，公用一个NAT路由器上的IP地址，因而可以同时和互联网上的不同主机通信。

采用了端口号的NAT也叫做**网络地址与端口号转换****NAPT**，而不使用端口号的NAT就叫做NAT。普通路由器转发IP数据报时，源地址或目的地址都不改变，但NAT路由器在转发IP数据报时一定要更换其IP地址，且还要查看和转换运输层端口号，不仅仅工作在网络层。

 

4.9 多协议标记交换MPLS

MPLS利用面向连接技术，使每个分组携带一个叫做**标记**的小整数，当分组到达交换机时，交换机读取分组的标记，并用标记值来检索分组转发表，这样就比查找路由表来转发分组要快得多。

特点：（1）支持面向连接的服务质量（2）支持流量过程，平衡网络负载（3）有效支持虚拟专用网VPN

MPLS的一个重要特点就是在MPLS域的入口处，给每一个IP数据报打上固定长度的标记，**然后对打上标记的****IP****数据报用硬件转发**，大大加快了IP数据报的转发过程。采用硬件技术对打上标记的IP数据报进行转发就成为标记交换。交换也表示在转发时不再上升到第三层查找转发表，而是**根据标记在第二层（链路层）用硬件转发**。MPLS可使用多种链路层协议：PPP、以太网、ATM以及帧中继等。

MPLS域指该域中有许多彼此相邻的路由器，并且所有路由器都是支持MPLS技术的**标记交换路由器****LSR**。LSR同时具有标记交换和路由选择两种功能。

4.10 本章的重要概念

TCP/IP体系中的网络层向上只提供简单灵活、无连接的、尽最大努力交付的数据报服务。网络层不提供服务质量的承诺，不保证分组交换的时限，所传送的分组可能出错、丢失、重复或失序。进程之间通信的可靠性由运输层负责。

IP网是虚拟的，因为从网络层上看，IP网就是一个统一的、抽象的网络（实际上是异构的）。IP层抽象的互联网屏蔽了下层网络复杂的细节使我们能够使用统一的、抽象的IP地址处理主机之间的通信问题。

在互联网上的交互有两种：在本网络的直接交付（不经过路由器）和到其他网络的间接交付（至少经过一个路由器但最后一次一定是直接交付）。

一个IP地址在整个互联网范围内是唯一的，分类的IP地址包括A类、B类、C类地址（单播地址）、以及D类地址（多播地址），E类地址未使用。

分类的IP地址由网络号字段（指明网络）和主机号字段（指明主机）组成。网络号字段最前面的类别位指明IP地址的类别。

IP地址是一种分等级的地址结构。IP地址管理机构在分配IP地址时只分配网络号，主机号则由得到该网络号的单位自行分配。路由器仅根据目的主机所连接的网络号来转发分组。

IP地址标志一台主机（或路由器）和一条链路的接口。多归属主机同时连接到两个或更多的网络上。这样的主机同时具有两个或更多的IP地址，其网络号必须是不同的。由于一个路由器至少应连接到两个网络，因此一个路由器至少应当有两个不同的IP地址。

按照互联网的观点，用转发器或网桥连接起来的若干局域网仍为一个网络，所有分配到网络号的网络（无论范围大小）都是平等的。

物理地址（硬件地址）是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址（用软件实现），在数据链路层看不见数据报的IP地址。

IP数据报分为首部和数据两部分，首部的前一部分是固定长度20字节，是所有IP数据报必须具有的（源地址、目的地址、总长度等重要字段都在固定首部中）。一些长度可变的可选字段放在固定首部的后面。

IP首部中的生存时间字段给出了IP数据报在互联网中所能经过的最大路由数，可防止IP数据报在互联网中无限制兜圈。

地址解析协议ARP把IP地址解析为硬件地址，它解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题。ARP的高速缓存可以大大减少网络上的通信量。

互联网中我们无法根据硬件地址寻找在某个网络上的某台主机，因此从IP地址到硬件地址的解析是非常必要的。

无分类域间路由选择CIDR是解决目前IP地址紧缺的一个好办法。CIDR记法把IP地址后面加上斜线“/”，然后写上前缀所占的位数。前缀用来指明网络，前缀后面的部分是后缀，用来指明主机。CIDR把前缀都相同的连续IP地址组成一个CIDR地址块，IP地址的分配都以CIDR地址块为单位。

CIDR的32为地址掩码由一串1和一串0组成，1的个数是前缀的长度。只要把IP地址和地址掩码逐位进行与运算，就很容易得出网络地址。A类地址的默认地址掩码是255.0.0，B类地址的默认地址掩码是255.255.0.0，C类地址的默认地址掩码是255.255.255.0。

路由聚合（把许多前缀相同的地址用一个来代替）有利于减少路由表中的项目，减少路由器之间的路由选择信息的交换，从而提高整个网络的性能。

转发和路由选择有区别，转发是单个路由器的动作，路由选择是许多路由器共同协同的过程，这些路由器相互交换信息，目的是生成路由表，再从路由表导出转发表。若采用自适应的路由选择算法，则网络拓扑变化时，路由表和转发表都能够自动更新。许多情况下，可不考虑路由表和转发表的区别而都使用路由表这一名词。

自治系统AS就是在单一的技术管理下的一组路由器，一个自治系统对其他自治系统表现出的是一个单一的和一致的路由选择策略。

路由选择协议有两大类：内部网关协议（或自治系统内部的路由选择协议），如RIP和OSPF；外部网关协议（自治系统之间的路由选择协议），如BGP-4。

RIP是分布式的基于距离向量的路由选择协议，只适用于小型互联网。RIP按固定的时间间隔与相邻路由器交换信息。交换的信息是自己当前的路由表，即到达本自治系统中所有网络的最短距离，以及到每个网络应经过的下一跳路由器。

OSPF是分布式的链路状态协议，适用于大型互联网。OSPF只在链路状态发生变化时，才向本自治系统中的所有路由器用洪泛法发送与本路由器相邻的所有路由器的链路状态信息。链路状态指明本路由器都和哪些路由器相邻，以及该链路的度量。度量表示费用、时延、带宽等，可通称为代价。所有的路由器最终都能建立一个全网的拓扑结构图。

BGP-4是不同AS的路由器之间交换路由信息的协议，是一种路径向量路由选择协议。BGP力求寻找一条能够到达目的网络（可达）且比较好的路由（不兜圈子），而并非寻找一条最佳路由。

网际控制报文协议ICMP是IP层的协议。ICMP报文作为IP数据报的数据，加上首部后组成IP数据报发送出去。使用ICMP并非为了实现可靠传输，ICMP允许主机或路由器报告差错情况和提供有关异常的报告。ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文。

ICMP的一个重要应用就是分组网间探测PING，用来测试两台主机之间的连通性。PING使用了ICMP回送请求和回送回答报文。

要解决IP地址耗尽的问题，最根本的办法就是采用具有更大地址空间的新版本IP协议即IPv6。

IPv6的主要变化是：（1）更大的地址空间（2）灵活的首部格式（3）改进的选项（4）支持即插即用（5）支持资源的预分配（6）IPv6的首部改为8字节对齐。

IPv6数据报在基本首部的后面允许有零个或多个扩展首部，再后面是数据。所有的扩展首部和数据合起来叫做数据报的有效载荷或净负荷。

IPv6数据报的目的地址可以是以下三种基本类型之一：单播、多播和任播。

IPv6的地址使用冒号16进制记法。

向IPv6过渡只能采用逐步演进的办法，必须使新安装的IPv6系统能够向后兼容。向IPv6过渡可以使用双协议栈或隧道技术。

与单播相比，在一对多的通信中，IP多播可大大节约网络资源。IP多播使用D类IP地址，IP多播需要使用网际组管理协议IGMP和多播路由选择协议。

虚拟专用网VPN利用公用的互联网作为本机构各专用网之间的通信载体。VPN内部使用互联网的专用地址，一个VPN至少要有一个路由器具有合法的全球IP地址，这样才能和本系统另一个VPN通过互联网进行通信。所有通过互联网传说的数据都必须加密。

使用网络地址转换NAT技术，可以在专用网络内部使用专用IP地址，而仅在连接到互联网的路由器使用全球IP地址，这样就大大节约了IP地址资源。

MPLS的特点：（1）支持面向连接的服务质量（2）支持流量工程，平衡网络负载（3）有效地支持虚拟专用网VPN

MPLS在入口结点给

一个IP数据报打上固定长度的标记，然后根据标记在第二层（链路层）用硬件进行转发（在标记交换路由器中进行标记对换），因而转发速率大大加快。

### 运输层

#### 抓包分析：

点击一个网址：

首先：ARP地址解析协议对告诉本计算机某个计算机网络地址的MAC地址

然后TCP三次握手，再然后告诉其他计算机传输数据

![image-20200517193113900](https://gitee.com/shaobing2021/typora/raw/master/img/20200728095712.png)

#### 三次握手

SYN：发起一次连接，ACK确认

因此：第一次连接客户端向服务器发起连接：SYN=1,ACK=0,seq= x（相当于发送了多少字节数据）

第二次连接：服务器确认并发起连接：ACK=1,SYN=1，seq=y（序列号，相当于发送第多少字节数据）,ack=x+1(让客户端继续发送后面的数据，确认号)

第三次连接：客户端也要确认：ACK=1,seq=y+1,ack=y+1

syn同步信息只有前面两次连接有

前面两次连接足够确保双方通信正常和协商窗口大小

为什么需要第三次握手：

主要原因在于：第三次握手时为了防止已失效的连接请求报文段有传送到B，因而产生错误。

#### 四次挥手

两次挥手是用来发送FIN=1 请求，告诉对方没有数据发送需要关闭

另外两次挥手用来确认关闭连接

本章重要内容：

（1）运输层为相互通信的应用进程提供逻辑通信。

（2）端口和套接字的意义。

（3）无连接的UDP的特点。

（4）面向连接的TCP的特点。

（5）在不可靠网络上实现可靠传输的工作原理，停止等待协议和ARQ协议。

（6）TCP的滑动窗口、流量控制、拥塞控制和连接管理。

5.1运输层协议概述

从通信和信息处理的角度看，**运输层向它上面的应用层提供通信服务**，它属于面向通信部分的最高层，同时也是用户功能中的最底层。当网络边缘的两台主机利用网络的核心功能进行端到端的通信时，只有主机的协议栈才有运输层，而路由器在转发分组时只用到下三层的功能。

从IP层来说通信的两端是两台主机，IP数据报的首部明确标志了这两台主机的IP地址。但真正进行通信的实体是主机中的进程，因此严格地讲，两台主机进行通信就是两台主机中的**应用进程互相通信**。IP协议虽然能把分组送到目的主机，但是这个分组还停留在主机的网络层而没有交付主机中的应用进程。从运输层的角度看，**通信的真正端点并不是主机而是主机中的进程**。也就是说，**端到端的通信**是应用进程之间的通信。

运输层有一个很重要的功能——**复用**和**分用**。复用是指在发送方不同的应用进程都可以使用同一个运输层协议传送数据（加上适当的首部），而分用是指接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进程。**运输层提供应用进程之间的逻辑通信**，逻辑通信的意思是：从应用层来看，只要把应用层报文交给下面的运输层，运输层就可以把报文送到对方的运输层，**好像这种通信就是沿水平方向直接传送数据**。**但事实上这两个运输层之间并没有一条水平方向的物理连接**，**数据传送是经过多个层次传送的**。

**网络层为主机之间提供逻辑通信**，**而运输层为应用进程之间提供逻辑通信**。

运输层还要对收到的报文进行**差错检测**，在网络层，IP数据报首部中的检验和字段，只检验首部是否出现差错而不检查数据部分。

根据应用程序的不同需求，运输层需要两种协议，即**面向连接的****TCP**和**无连接的****UDP**。

**运输层向高层用户屏蔽了下面网络核心的细节**（网络拓扑、所采用的路由选择协议等），**它使应用进程看见的就好像是在两个运输层实体之间有一条端到端的逻辑通信信道**，但这条逻辑通信信道对上层的表现因运输层的不同协议而有很大差别。当运输层采用TCP时，**尽管下面的网络是不可靠的**，但这种逻辑通信信道就相当于一条**全双工的可靠信道**。但运输层采用UDP时，这种逻辑通信信道仍然是**不可靠的**。

按照OSI的术语，两个对等层实体在通信时传送的数据单位叫**运输协议数据单元****TPDU****。**但在TCP/IP体系中，根据所选协议分别称为**TCP****报文段**（segment）或**UDP****用户数据报**。

UDP在传送数据前**不需要先建立连接**，远地主机运输层收到报文后不需要给出任何确认。

TCP**提供面向连接的服务**，在传送前必须建立连接，传送后要释放连接。TCP不提供广播或多播服务。

使用TCP和UDP的各种应用和应用层协议：

UDP：名字转换 DNS、文件传送TFTP、路由选择协议IP、IP地址配送DHCP、网络管理SNMP、远程文件服务器NFS、IP电话 专用协议、流式多媒体通信 专用协议、多播 IGMP

TCP：电子邮件 SNMP、远程终端接入TELNET、万维网WWW、文件传送 FTP

应用层的所有应用进程都可以通过运输层再传送到IP层（网络层），这就是**复用**。运输层从IP层收到发送给各应用进程的数据后，必须分别交付指明的各应用进程，这就是**分用**。

在运输层使用**协议端口号**，或称**端口**。虽然通信的终点是应用进程，但只要把传送的报文交到目的主机的某个合适的目的端口，剩下的工作（即交付目的进程）就由TCP或UDP完成。

这种在协议栈层间的端口是**软件端口**，和路由器或交换机上的**硬件端口**不同。硬件端口是**不同硬件设备**进行交互的接口，而软件端口是**应用层的各种协议进程与运输实体进行层间交互的一种地址**。

TCP和UDP的首部格式中都有**源端口**和**目的端口**，当运输层收到IP层上交的运输层报文时，就能根据其首部中的目的端口号把数据交付应用层的目的应用进程。

TCP/IP的运输层使用16位**端口号**来标志一个端口，端口号**只具有本地意义**，只是为了标志**本计算机**应用层中的各个进程在和运输层交互时的层间接口。在互联网不同计算机中，相同的端口号**没有关联**，16位端口号允许65535个不同的端口号。

两个计算机中的进程要相互通信，不仅要知道对方的IP地址，还要知道对方的端口号。互联网上的计算机通信采用客户-服务器方式，运输层端口号分为以下两种：

（1）**服务器端口号** 最重要的一类叫做**熟知端口号**或**系统端口号**，数值0-1023。如：FTP21 、TELNET23、SMTP25、DNS53、TFTP69、HTTP80、SNMP161、SNMP(trap)162、HTTPS443。

另一类叫做**登记端口号**，数值1024-49151，为没有熟知端口号的应用进程使用的。

（2）**客户端端口号** 数值为49152-65535，又叫做**短暂端口号**。



5.2 用户数据报协议UDP

UDP只在IP的数据报服务上增加了很少一点的功能，复用、分用以及差错检测。UDP的主要特点是：

（1）**无连接**，发送数据前不需要建立连接，减小了开销和发送时延。

（2）**尽最大努力交付，**不保证可靠服务，主机不需要维持复杂的连接状态表。

（3）UDP是**面向报文的**，UDP对应用层交下来的报文，既不合并也不拆分，而是保留这些报文的边界。因此应用程序需要选择合适大小的报文，太长（需要分片）太短（首部相对长度太大）都会降低IP等的效率。

（4）UDP**没有拥塞控制**，网络出现拥塞不会使源主机的发送速率降低，适合很多实时应用（IP电话，视频会议等），这些应用要求源主机以恒定速率发送数据。

（5）**支持一对一、一对多、多对一和多对多的交互通信**。

（6）**首部开销小**，只有8字节，TCP需要20字节。

不使用拥塞控制的UDP有可能使网络产生严重拥塞。

 

UDP的首部格式

UDP有两个字段，数据字段和首部字段。首部字段只有8字节，由四个字段组成，每个字端都是2字节长。各字段意义如下：

（1）**源端口** 源端口号，需要对方回信时使用，不需要全0。

（2）**目的端口** 目的端口号，在终点交付报文时必须使用。

（3）**长度** UDP用户数据报的长度，最小值为8（仅有首部）。

（4）**检验和** 检测UDP数据报在传输中是否有错，有错则丢弃。（使用12字节的伪首部，既不向下传送也不向上递交）

如果接收方UDP发现接收报文中目的端口号不正确，即不存在对应于该端口号的应用进程，就丢弃该报文，并由网际控制报文协议ICMP发送端口不可达差错报文给发送方。ICMP的traceroute应用就是让发送的UDP数据报故意使用非法UDP端口。

 

5.3 传输控制协议TCP概述

TCP最主要的特点：

（1）TCP是**面向连接**的运输层协议。

（2）每一条TCP连接只能有两个**端点**，只能是**点对点**的（一对一）。

（3）TCP提供**可靠交付**的服务，通过TCP传送的数据，无差错、不丢失、不重复并且按序到达。

（4）提供**全双工通信**，TCP两端都有发送缓存和接收缓存，用来临时存放双向通信的数据。

（5）**面向字节流**，流指的是流入到进程或从进程中流出的字节序列。面向字节流的含义是，虽然应用进程和TCP的交互是一次一个数据块，但TCP把应用程序交下来的数据仅仅看成一连串的**无结构字节流**。TCP不保证接收方应用程序收到的数据块和发送方应用程序发出的数据块具有对应大小的关系，但接收方收到的字节流必须和发送的字节流完全一样。

TCP连接是一条**虚连接**（**逻辑连**接），而不是一条真正的物理连接。TCP报文端先要传送到IP层，加上IP首部后，再传送到数据链路层。再加上数据链路层的首部和尾部再离开主机发送到物理链路。

TCP发送报文时不关心应用进程一次把多长的报文发送到TCP的缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度决定一个报文段应包含多少字节（UDP发送的报文长度是应用进程给出的）。如果应用进程发送到TCP缓存的数据块太长，TCP就把它划分短一些再传送，如果太短TCP也可以等待积累足够多的字节构成报文段再发送。

TCP把**连接**作为**最基本的抽象**，TCP的许多特性都与TCP是面向连接的这个基本特性有关。

TCP连接有两个端点，TCP连接的端点叫做**套接字（****socket****）**或**插口**。端口号**拼接到**IP地址即构成了套接字。因此套接字的表示方法是在点分十进制的IP地址后写上端口号，中间用冒号或逗号隔开。**每一条****TCP****连接唯一地被通信两端的两个端点（即两个套接字）确定**。

一定要记住：**TCP****连接的端点是个很抽象的套接字**，即（IP地址：端口号）。还应记住：同一个IP地址可以有多个不同的TCP连接，而同一个端口号也可以出现在多个不同的TCP连接。

 

5.4 可靠传输的工作原理

TCP下面的网络所提供的是不可靠的传输，因此TCP必须采用适当的措施才能使两个运输层之间的通信变得可靠。

 

停止等待协议

全双工通信的双方既是发送方也是接收方。停止等待协议就是每发送完一个分组就停止发送，等待对方的确认，在收到确认之后再发送下一个分组。

**1** **无差错情况**

A发送分组M1，发送完后就暂停发送，等待B的确认。B收到M1就向A发送确认，A收到了对M1的确认后就发送M2，同样在收到B对M2的确认后再发送M3。

**2** **出现差错**

B收到M1时检测出来差错就丢弃M1，其他什么也不做（不通知A收到差错分组），也可能是在传输过程中丢失了。这两种情况下B都不会发送任何信息，A只要超过了一段时间仍然没有收到确认，就认为之前发送的分组丢失了，因而重传前面发送的分组，这就叫**超时重传**。因此要在每发送完一个分组时设置一个**超时计时器**，如果在计时器到期前收到确认就撤销计时器。

需要注意三点：

（1）A发送完分组后，必须暂时保留已发送分组的副本。只有收到确认后才清除。

（2）分组和确认分组都必须进行编号。

（3）超时计时器设置的重传时间应当比数据在分组传输的平均往返时间更长一些。如果设置的太长就会降低通信效率，如果太短就会导致不必要的重传。

**3** **确认丢失和确认迟到**

假定B发送的确认丢失了，A在设定超时重传时间内没收到确认，重传了M1，假定B又收到了重传分组，此时B应采取两个行动。第一，**丢弃重复分组**M1，不向上层交付。第二，向A**发送确认**。

当B的确认迟到时，A会收到重复的确认。对此的处理很简单，A收下后就丢弃。B仍然会收到重复的分组M1，并且同样要丢弃掉重复分组，并重传确认分组。

通常A最终总是可以收到对发出所有分组的确认，如果A不断重传分组但总是收不到确认，说明通信线路太差，不能通信。

使用上述的确认和重传机制就可以**在不可靠的传输网络实现可靠通信**。上述的这种可靠传输协议常称为**自动重传请求****ARQ**，意思是重传的请求是自动进行的。接收方不需要请求发送方重传某个出错的分组。

**4** **信道利用率**

停止等待协议的优点是简单，确点是信道利用率太低。

信道利用率U=TD/（TD+RTT+TA）

RTT：往返时间 TD:A发送分组的时间 TA :B发送确认分组时间。

当RTT远大于分组发送时间时，信道利用率会非常低。为提高传输效率，发送方可以不使用低效率的停止等待协议，而采用**流水线传输**，流水线传输就是发送方可连续发送多个分组，不必发送完每个分组就停顿下来等待确认。当使用流水线传输时，就要使用**连续****ARQ****协议**和**滑动窗口协议**。

 

连续ARQ协议

连续ARQ协议规定，发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。

接收方一般都是采用**累积确认**的方式，接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，**对按序到达的最后一个分组发送确认**，这就表示，到这个分组为止的所有分组都已经正确收到了。

累积确认的优点：容易实现，即使确认丢失也不必重传。缺点：不能向发送方反映出接收方已经正确收到的所有分组信息。

例如发送方发送了前5个分组，而第3个分组丢失了。这时接收方只能对前2个分组进行确认，发送方无法知道后面3个分组的下落，只好把后面3个分组再重传一次。这就叫做回退N，表示需要再退回来重传已发送的N个分组。因此通信线路质量不好时，连续ARQ协议会带来负面影响。

5.5 TCP报文段的首部格式

TCP虽然面向字节流，但传送的数据单元是报文段。一个TCP报文段分为首部和数据两部分。

TCP报文段首部20字节是固定的，后面有4n字节是根据需要而增加的选项，因此TCP首部的最小长度是20字节。

首部固定部分各字段意义如下：

（1）**源端口**和**目的端口** 各占2字节，分别写入源端口号和目的端口号，TCP的分用和UDP相似，也是通过端口实现。

（2）**序号** 4字节，范围是[0，232-1]。在一个TCP连接中传送的字节流中的**每一个字节都按顺序编号**，整个要传送的字节流的起始序号必须在连接建立时设置。首部中的序号字段值则是**本报文段**所发送的数据的第一个字节的序号。这个字段的名称也叫**报文段序号**。

（3）**确认号** 4字节，是**指期望收到对方下一个报文段的第一个数据字节的序号**。若确认号=N，表明到序号N-1为止的所有数据都已正确收到。一般情况下可保证当序号重复使用时旧序号的数据早已通过网络到达终点了。

（4）**数据偏移** 4位，指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。

（5）**保留** 6位，目前置为0。

（6）**紧急URG** 值为1时，表明有效。当URG置1时，发送应用进程就告诉发送方的TCP有紧急数据要传送，于是发送方TCP就把紧急数据插入到本报文段数据的**最前面**，而在紧急数据后面的数据仍是普通数据。这时要与首部中**紧急指针字段**配合使用。

（7）**确认ACK** 仅当ACK=1时确认字段才有效。TCP规定在连接建立后所有传送的报文字段都必须把ACK置1。

（8）**推送PSH** 当两个应用进程进行交互式通信时，有时在一端的应用进程希望在键入一个命令后立即就能够收到对方的响应，这种情况下TCP就可以使用推送操作。

（9）**复位RST** 当RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立运输连接。RST置1还用来拒绝一个非法的报文段或拒绝打开一个连接。

（10）**同步SYN** 在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则在响应的报文段中使SYN=1和ACK=1。因此SYN=1表示这是一个连接请求或连接接受报文。

（11）**终止FIN** 用来释放一个连接，当FIN=1时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。

（12）**窗口** 2字节，值为[0，216-1]之间的整数，指的是发送本报文段的一方的接收窗口。窗口值告诉对方，从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。

（13）**检验和** 2字节，检验的范围包括首部和数据两部分。计算检验和时要在TCP报文段的前面加上12个字节的伪首部。

（14）**紧急指针** 2字节，仅在URG=1时才有效，指出本报文段中的紧急数据字节数。

（15）**选项** 长度可变，最长40字节。TCP起初只规定了一种选项，最大报文段长度MSS（数据字段的最大长度）。默认值536字节，为提高网络利用率。

#### 5.6 TCP可靠传输的实现

TCP的滑动窗口是以字节为单位的。发送窗口里的序号表示允许发送的序号，显然窗口越大，发送方就可以在收到对方确认之前连续发送更多的数据，提高传输效率。发送窗口的大小不能超过对方的接收窗口大小。

发送窗口的后沿部分表示已发送并且收到确认的序号，前沿部分表示不允许发送的序号。发送窗口后沿的变化情况有两种，不动（没有收到新的确认）和前移（收到了新的确认）。发送窗口的前沿通常不断向前移动，但也可能不动或向后收缩。

5.7 TCP的流量控制

所谓流量控制，就是让发送方的发送速率不要太快，要让接收方来得及接收。

发送方的发送窗口不能超过接收方给出的接收窗口的数值。**TCP****窗口的单位是字节**，**不是报文段**。

B向A发送的接收窗口大小报文可能丢失，A一直等待B发送的非零窗口通知，B也在一直等待A发送的数据，如果没有其他措施，可能会形成死锁。

为了解决这个问题，TCP为每一个连接设有一个**持续计时器**，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器，若持续计时器的时间到了，就发送一个零窗口**探测报文段**（仅携带1字节数据），而对方就在确认这个探测报文段时给出了现在的窗口值。如果窗口仍然是0，那么收到这个报文段的一方就重新设置持续计时器。如果窗口不是0，那么死锁的僵局就打破了。

应用进程把数据发送到TCP的发送缓存后，剩下的发送任务就交给TCP来控制了。可以用不同的机制来控制TCP报文段的发送时机，例如第一种机制是TCP维持一个变量，它等于最大报文段长度MSS，只要缓存中数据到达此长度就组成一个TCP报文段发送出去。第二种机制是由发送方的应用进程指明要求发送报文段，即TCP支持的推送操作。第三种机制是发送方的一个计时器时限到了，这就把当前已有的缓存数据装入报文段（长度不超过MSS）发送出去。

#### 5.8 TCP的拥塞控制

主要理解三个窗口：拥塞窗口，接受窗口，发送窗口

由于窗口不断增多，从1->2->4->...不能增长到接受宽口大小

拥塞控制的一般原理

某段时间内，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种情况就叫做**拥塞**。

网络拥塞的原因很多。例如某个结点缓存的容量太小，到达该结点的分组因无存储空间暂存而不得不丢弃。假设将该结点缓存的容量扩展到非常大，于是凡到达该结点的分组均可在结点的缓存队列中排队，不受任何限制。由于输出链路的容量和处理机的速度并未提高，因此队列中的绝大多数分组的排队等待时间将会大大增加，结果上层软件只好把它们重传（超时）。因此简单扩大缓存空间不能解决网络拥塞。

拥塞常常趋于恶化，拥塞引起的重传不会缓解网络拥塞，反而会加剧。

**拥塞控制**就是**防止过多的的数据注入到网络**，**这样可以使网络中的路由器或链路不致过载**。拥塞控制要做的都有一个前提，就是**网络能够承受现有的网络载荷**。拥塞控制是一个全局性过程，涉及到所有主机，所有的路由器，以及与降低网络传输性能有关的所有因素。TCP连接的端点只要迟迟不能收到对方的确认信息，就猜想当前网络的某处可能发生了拥塞，但发生的地点和原因不从得知。

相反，流量控制是指**点对点通信的控制**，是个**端到端**的问题（接收端控制发送端）。流量控制所要做的就是抑制发送端发送数据的速率以便接收端来得及接收。

理想情况下，随着**输入负载**（单位时间内输入给网络的分组数目）或**网络负载**的增大，**吞吐量**应等于提供的负载，当吞吐量饱和时，理想拥塞控制的情况下，吞吐量仍然可以维持最大值。但实际上随着负载增大，网络吞吐量的增长速率逐渐减小，当网络的吞吐量明显小于理想吞吐量时，网络就进入了**轻度拥塞**的状态。当提供负载到达某一数值时，网络的吞吐量反而随着负载的增大而下降，这时网络就进入了**拥塞状态**。当负载继续增大时，网络的吞吐量就下降到0，网络无法工作，这就是所谓的**死锁**。

拥塞控制是一个动态的问题，从大的方面可以将拥塞控制分为**开环控制**和**闭环控制**两种方法。开环控制就是在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络工作时不产生拥塞，但系统一旦运行就不在途中进行改正了。

闭环控制是基于反馈环路的概念，主要措施：

（1）监测网络系统以便检测到拥塞在何时、何处发生

（2）把拥塞发生的信息传送到可采取行动的地方

（3）调制网络系统的运行以解决出现的问题

 

TCP拥塞控制的算法有四种：（1）**慢开始**（2）**拥塞避免**（3）**快重传**（4）**快恢复**。

5.9 TCP的运输连接管理

运输连接有三个阶段：**连接建立**、**数据传送**、**连接释放**

TCP连接建立中要解决以下三个问题：

（1）要使每一方能够确知对方的存在

（2）要允许双方协商一些参数

（3）能够对运输实体资源进行分配

TCP连接的建立采用客户服务器方式，主动发起连接建立的应用进程叫做**客户**，而被动等待连接建立的应用进程叫做**服务器**。

 

TCP建立连接的过程叫做握手，握手需要在客户和服务器之间交换三个TCP报文段。

最初两端的TCP进程都处于CLOSED状态，假设**A****主动打开连接**，**B****被动打开连接**。

一开始B的TCP服务器进程先创建**传输控制块****TCB**，准备接收客户进程的连接请求。然后服务器进程就处于LISTEN状态，等待客户的连接请求。如有则立即响应。

A的TCP客户进程也是首先创建**传输控制块****TCB**，然后打算建立TCP连接时，先向B发出连接请求报文段，SYN=1，同时选择一个初始序号seq=x。TCP规定SYN报文段不能携带数据，但要消耗掉一个序号，这时TCP客户进程进入SYN-SENT（同步已发送）状态。

B收到连接请求报文段后，如同意建立连接则向A确认。在确认报文段应把SYN和ACK位都置1，确认号是ack+1，同时也为自己选择一个初始序号seq=y。这个报文段也不能携带数据，但同样**要消耗一个序号**。这时TCP服务器进程进入SYN-RCVD（同步收到）状态。

TCP客户进程收到B的确认后，还要向B给出确认。确认段ACK=1，确认号ack=y+1，而自己的序号seq=x+1。TCP规定ACK的报文段可以携带数据，如果不携带数据则不消耗序号，这种情况下下一个报文段的序号仍是seq=x+1，这时TCP连接已建立，A进入ESTABLISHED（已建立连接）状态。

B收到A的确认后，也进入ESTABLISHED状态。

为什么A要发送一次确认呢，主要是为了防止已失效的连接请求报文段突然又传送到了B，因而产生错误。假设A发出的连接请求报文在网络某些结点滞留了，以至于连接释放后的某个时间才到达B。本来这是失效报文段，但B收到后误认为是A发出的新连接请求，就发出确认。假设不采取报文握手，只要B发出确认，连接就建立了，由于A并没有发出请求因此不会理睬B，但B误认为连接已建立会一直等待A发送数据，白白浪费B中的资源。

 

TCP的连接释放

A和B都处于ESTABLISHED状态，A的应用进程先向其TCP发出释放连接报文段，并停止再发送数据，主动关闭TCP连接。A把连接释放报文段首部的终止控制位FIN置1，seq=u，它等于前面已传送的最后一个字节的序号加1。这时A进入FIN-WAIT-1（终止等待1）的状态，等待B的确认。FIN报文段不携带数据也要消耗掉一个序号。

B收到连接释放报文段后发出确认，确认号是ack=u+1，而这个报文段自己的序号是v，等于前面B已传送的最后一个字节的序号加1。然后B就进入CLOSE-WAIT（关闭等待）状态。这时A到B这个方向的连接就释放了，这时TCP的连接处于**半关闭**状态，即A已经没有数据要发送了，但若B发送数据，A仍要接受。

A收到来自B的确认后，就进入FIN-WAIT-2（终止等待2）状态，等待B发出的连接释放请求报文。若B已经没有要向A发送的数据，其应用进程就通知TCP释放连接，这时B发出的连接释放报文段必须使FIN=1。假定B的序号为w（半关闭状态时B可能又发送了一些数据）。B还必须重复上次已发送过的确认号ack=u+1，这时B就进入了LAST-ACK（最后确认）状态。

A收到B的连接释放报文段后必须对此确认，在确认报文段中把ACK置1，确认号ack=w+1，自己的序号是u+1（前面发送的FIN报文消耗一个序号）。然后进入TIME-WAIT状态。必须经过时间等待计时器设置的时间2MSL后，A才能进入到CLOSED状态。MSL叫做最长报文段寿命。

A必须等待2MSL时间的理由：

（1）为了保证A发送的最后一个ACK报文段能够到达B。这个ACK报文段有可能丢失，B会超时重传这个FIN+ACK报文段，而A就能在2MSL时间内收到这个报文段，接着A再重传一次确认，重新启动2MSL计时器。最后AB都正常进入到CLOSED状态。如果A不等待一段时间就收不到B重传的报文段，也不会再发送一次确认报文段，B就无法按照正常步骤进入CLOSED状态。

（2）为了防止前述的“已失效连接请求报文段”出现在本连接中。

TCP还设有保活计时器，服务器每收到一次客户的数据就重新设置保活计时器，时间的设置通常是2小时，若2小时内没有收到客户的数据，就发送一个探测报文段，以后每隔75秒发送一次，如果连续10个探测报文段后仍无客户的响应，服务器就认为客户端出了故障，关闭连接。

5.10 本章的重要概念

运输层提供应用进程间的逻辑通信，运输层的通信并不是真正在两个运输层之间直接传送数据。运输层向应用层屏蔽了下面的网络细节（网络拓扑、路由选择协议等），它使应用进程看见的就好像在两个运输层实体之间有一条端到端的逻辑通信线路。

网络层为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信。

运输层有两个主要的协议：TCP和UDP。它们都有复用和分用，以及检错的功能。当运输层采用TCP协议时，尽管下面的网络是不可靠的，但这种逻辑通信信道就相当于一条全双工通信的可靠信道。当运输层采用UDP协议时，这种逻辑通信信道仍然是一条不可靠信道。

运输层用一个16位端口号来标志一个端口，端口号具有本地意义，它只是为了标志本计算机应用层中的各个进程在和运输层交互时的层间接口。在互联网的不同计算机中，相同的端口号没有关联。

两台计算机中的进程要互相通信，不仅要知道对方IP地址，还要知道对方的端口号。

运输层的端口号分为服务器端端口号（0-1023指派给数值端口，1024-49151是登记端口号）和客户端暂时使用的端口号（49152-65535）。

UDP的主要特点：（1）无连接（2）尽最大努力交付（3）面向报文（4）无拥塞控制（5）支持一对一、一对多、多对一和多对多的交互通信（6）首部开销小（只有源端口、目的端口、长度、检验和）。

TCP的主要特点：（1）面向连接（2）每一条TCP连接只能是点对点的（3）提供可靠的交付服务（4）提供全双工通信（5）面向字节流

TCP用主机的IP地址加上主机的端口号作为TCP连接的端点，这样的端点叫做套接字或插口。套接字用（IP地址：端口号）来表示。

停止等待协议能够在不可靠的传输网络实现可靠通信。每发完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组，分组需要编号。

超时重传是只要超过了一段时间仍然没有收到确认，就重传前面发送过的分组。因此每发送完一个分组需要设置一个超时计时器，其重传时间应比数据在分组传输中的平均往返时间更长一些。这种自动重传方式常称为自动重传请求ARQ。

在停止等待协议中，若接收方收到重复分组，就丢弃该分组，但同时还要发送确认。

连续ARQ协议可提高信道利用率，发送方维持一个发送窗口，凡位于发送窗口内部的分组都可以连续发送，而不需要等待确认。接收方一般采用累积确认，对按序到达的最后一个分组发送确认，表明到这个分组为止的所有分组都已正确收到了。

TCP报文段首部的前20个字节是固定的，后面有4N字节是根据需要而增加的选项（N是整数）。在一个TCP连接中传送的字节流中的每一个字节都按顺序编号。首部中的序号字段值指的是本报文段发送的数据的第一个字节的序号。

TCP首部中的确认号是期望收到对方下一个报文段的第一个数据字节的序号，若确认号位N，则表明到序号N-1为止的所有数据都已正确收到。

TCP首部中窗口的字段指出了现在允许对方发送的数据量，窗口是动态变化的。

TCP使用窗口滑动机制，发送窗口里的序号表示允许发送的序号，发送窗口后沿的部分表示已发送并且收到确认的，前沿的前面部分表示不允许发送。发送窗口后沿的变化情况有两种，即不动（没有收到新的确认）和前移（收到了新的确认）。发送窗口前沿通常是不断向前移动的。

流量控制就是让发送方的速率不要太快，要让接收方来得及接收。

某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种情况叫做拥塞。拥塞控制就是防止过多的数据注入到网络，这样可使网络中的路由器或链路不至于过载。

流量控制是一个端到端的问题，使接收端抑制发送端发送数据的速率，以便使接收端来得及接收。拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。

为了进行拥塞控制，TCP的发送方要维持一个拥塞窗口cwnd的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态变化。发送方让自己的发送窗口取为拥塞窗口和接收方的接收窗口中较小的一个。

TCP的拥塞控制采取了四种算法，即慢开始、拥塞避免、快重传和快恢复。在网络层也可以使路由器采用适当的分组丢弃策略（如主动队列管理AQM），以减小网络拥塞的发生。

运输连接有三个阶段：连接建立、数据传送、连接释放。

主动发起TCP连接请求的应用进程叫客户，而被动等待连接建立的应用进程叫服务器。TCP的连接建立采用三报文握手机制，服务器要确认客户连接请求，然后客户要对服务器的确认进行确认。

TCP连接的释放采用四报文握手机制，任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后就进入半关闭状态。当另一方也没有数据再发送时，则发送连接释放通知，对方确认后就完全关闭了TCP连接。



